import{r as c,j as e,N as ce,V as Se,W as Ce,Z as ne,O as ge,_ as oe,B as C,b as de,i as X,Y as H,U as De,s as z,$ as Y,I,P as ke,F as J,a0 as h,H as $e,K as Pe,o as se,k as te,a1 as Oe,c as Fe,u as ue,g as Te}from"./index-BkKKilg3.js";import{OrderForm as Ae}from"./order-form-BpXtBFaE.js";import{A as R,a as _}from"./alert-B9qo0drA.js";import{r as je,u as pe}from"./xlsx-ocdEQCFM.js";import{P as Re}from"./progress-B6Qii5XM.js";import{C as ie}from"./checkbox-JWbK7OTn.js";import{T as _e}from"./textarea-CBSH_8eL.js";import{D as fe,a as ve,b as Ne,c as ye,e as be,d as Le}from"./dialog-DUEHrOUT.js";import{M as Q}from"./mail-BtcNO8bc.js";import{U as Ue}from"./users-DuHO3T1_.js";import{P as Ve}from"./paperclip-CDK9qrNu.js";import{S as Be}from"./send-D6-6xUnD.js";import{S as Me}from"./save-yByEdYEb.js";import{C as he}from"./calendar-B3GIQRUc.js";import{P as we}from"./package-BnxkbB3s.js";import{H as qe}from"./hash-DUals3yL.js";import{D as me}from"./download-DU1bV6-C.js";import{R as ze}from"./refresh-cw-CcQD2__t.js";import{I as re}from"./info-FpGCGLL4.js";import{T as Ke,a as We,b as ae,c as le}from"./tabs-B5mwIv1W.js";import"./select-BCNeRYAS.js";import"./index-C57cqXPQ.js";import"./chevron-down-Aoc09in8.js";import"./chevron-up-19dbfq0_.js";import"./table-rmD-UXE4.js";import"./authUtils-CcDzk6i0.js";import"./trash-2-DnOhhWYr.js";import"./index-DK0Bws7N.js";function He({onDataParsed:j}){const[v,u]=c.useState(!1),[x,i]=c.useState("idle"),[E,d]=c.useState(""),S=c.useRef(null),b=g=>{if(!g)return;u(!0),i("idle");const m=new FileReader;m.onload=r=>{try{const k=new Uint8Array(r.target?.result),$=je(k,{type:"array"}),P=$.SheetNames[0],O=$.Sheets[P],w=pe.sheet_to_json(O,{header:1});if(w.length<2)throw new Error("Excel 파일에 데이터가 없습니다.");const F=w.slice(1).filter(T=>T&&T.some(A=>A));if(F.length===0)throw new Error("유효한 데이터가 없습니다.");i("success"),d(`${F.length}개의 행을 성공적으로 불러왔습니다.`),j(F)}catch(k){i("error"),d(k instanceof Error?k.message:"파일 처리 중 오류가 발생했습니다.")}finally{u(!1)}},m.onerror=()=>{u(!1),i("error"),d("파일을 읽는 중 오류가 발생했습니다.")},m.readAsArrayBuffer(g)},p=g=>{const m=g.target.files?.[0];m&&b(m)},D=()=>{S.current?.click()};return e.jsxs(ce,{className:"w-full",children:[e.jsx(Se,{children:e.jsxs(Ce,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5"}),"Excel 파일 업로드 (실험 기능)"]})}),e.jsx(ge,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed rounded-lg p-6 text-center border-gray-300 hover:border-gray-400",children:[e.jsx("input",{ref:S,type:"file",accept:".xlsx,.xlsm,.xls,.csv",onChange:p,className:"hidden"}),e.jsx(oe,{className:"h-8 w-8 text-gray-400 mx-auto mb-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-gray-700",children:"Excel 파일을 업로드하여 품목 데이터 불러오기"}),e.jsx("p",{className:"text-sm text-gray-500",children:".xlsx, .xlsm, .xls, .csv 파일을 지원합니다"})]}),e.jsx(C,{onClick:D,disabled:v,className:"mt-3",variant:"outline",children:v?"처리 중...":"파일 선택"})]}),x==="success"&&e.jsxs(R,{children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(_,{children:E})]}),x==="error"&&e.jsxs(R,{variant:"destructive",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx(_,{children:E})]}),e.jsxs(R,{children:[e.jsx(X,{className:"h-4 w-4"}),e.jsxs(_,{children:[e.jsx("strong",{children:"참고:"})," 첫 번째 행은 헤더로 처리되며, 두 번째 행부터 데이터로 인식됩니다. 품목명, 수량, 단가 등의 정보가 포함된 Excel 파일을 업로드해주세요."]})]})]})})]})}function Xe({isOpen:j,onClose:v,onSend:u,orderData:x,initialTo:i=[],initialCc:E=[]}){const[d,S]=c.useState(i),[b,p]=c.useState(E),[D,g]=c.useState(`발주서: ${x?.projectName||""} - ${x?.vendorName||""}`),[m,r]=c.useState(`안녕하세요.

${x?.projectName||"[프로젝트명]"} 관련 발주서를 송부드립니다.

발주 내역:
- 거래처: ${x?.vendorName||"[거래처명]"}
- 납기일: ${x?.deliveryDate||"[납기일]"}
- 품목: ${x?.items?.[0]?.itemName||"[품목명]"}
- 수량: ${x?.items?.[0]?.quantity||"[수량]"}
- 금액: ${((x?.items?.[0]?.quantity||0)*(x?.items?.[0]?.unitPrice||0)).toLocaleString()}원

첨부된 발주서를 확인하시고 문의사항이 있으시면 연락 부탁드립니다.

감사합니다.`),[k,$]=c.useState(!0),[P,O]=c.useState(!1),[w,L]=c.useState(""),[F,T]=c.useState(""),[A,K]=c.useState("to"),f=()=>{if(!w){h({title:"이메일 주소를 입력하세요",variant:"destructive"});return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(w)){h({title:"올바른 이메일 형식이 아닙니다",variant:"destructive"});return}const t={email:w,name:F||void 0};if(A==="to"){if(d.some(a=>a.email===w)){h({title:"이미 추가된 수신자입니다",variant:"destructive"});return}S([...d,t])}else{if(b.some(a=>a.email===w)){h({title:"이미 추가된 참조자입니다",variant:"destructive"});return}p([...b,t])}L(""),T("")},V=(s,t)=>{t==="to"?S(d.filter(a=>a.email!==s)):p(b.filter(a=>a.email!==s))},B=()=>{if(d.length===0){h({title:"수신자를 추가해주세요",variant:"destructive"});return}if(!D.trim()){h({title:"제목을 입력해주세요",variant:"destructive"});return}if(!m.trim()){h({title:"내용을 입력해주세요",variant:"destructive"});return}u({to:d,cc:b,subject:D,body:m,attachPdf:k,attachExcel:P})};return e.jsx(fe,{open:j,onOpenChange:v,children:e.jsxs(ve,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ne,{children:e.jsxs(ye,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5"}),"이메일 작성"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsxs(H,{className:"flex items-center gap-2 mb-2",children:[e.jsx(De,{className:"h-4 w-4"}),"수신자 (To)"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[d.map(s=>e.jsxs(z,{variant:"secondary",className:"px-2 py-1",children:[s.name&&`${s.name} `,"<",s.email,">",e.jsx("button",{onClick:()=>V(s.email,"to"),className:"ml-2 hover:text-red-600",children:e.jsx(Y,{className:"h-3 w-3"})})]},s.email)),d.length===0&&e.jsx("span",{className:"text-sm text-gray-500",children:"수신자를 추가해주세요"})]})]}),e.jsxs("div",{children:[e.jsxs(H,{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ue,{className:"h-4 w-4"}),"참조 (CC)"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[b.map(s=>e.jsxs(z,{variant:"outline",className:"px-2 py-1",children:[s.name&&`${s.name} `,"<",s.email,">",e.jsx("button",{onClick:()=>V(s.email,"cc"),className:"ml-2 hover:text-red-600",children:e.jsx(Y,{className:"h-3 w-3"})})]},s.email)),b.length===0&&e.jsx("span",{className:"text-sm text-gray-500",children:"참조자 없음 (선택사항)"})]})]}),e.jsx("div",{className:"border rounded-lg p-3 bg-gray-50",children:e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(I,{placeholder:"이름 (선택사항)",value:F,onChange:s=>T(s.target.value)})}),e.jsx("div",{className:"flex-1",children:e.jsx(I,{placeholder:"이메일 주소",type:"email",value:w,onChange:s=>L(s.target.value),onKeyPress:s=>s.key==="Enter"&&f()})}),e.jsxs("select",{className:"px-3 py-2 border rounded-md",value:A,onChange:s=>K(s.target.value),children:[e.jsx("option",{value:"to",children:"수신자"}),e.jsx("option",{value:"cc",children:"참조"})]}),e.jsxs(C,{type:"button",onClick:f,size:"sm",children:[e.jsx(ke,{className:"h-4 w-4 mr-1"}),"추가"]})]})}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"subject",children:"제목"}),e.jsx(I,{id:"subject",value:D,onChange:s=>g(s.target.value),placeholder:"이메일 제목을 입력하세요",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"body",children:"내용"}),e.jsx(_e,{id:"body",value:m,onChange:s=>r(s.target.value),placeholder:"이메일 내용을 입력하세요",className:"mt-1 min-h-[200px]"})]}),e.jsxs("div",{children:[e.jsxs(H,{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ve,{className:"h-4 w-4"}),"첨부파일"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{id:"attach-pdf",checked:k,onCheckedChange:s=>$(s)}),e.jsxs("label",{htmlFor:"attach-pdf",className:"flex items-center gap-2 text-sm cursor-pointer",children:[e.jsx(J,{className:"h-4 w-4 text-red-600"}),"발주서 PDF 첨부"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{id:"attach-excel",checked:P,onCheckedChange:s=>O(s)}),e.jsxs("label",{htmlFor:"attach-excel",className:"flex items-center gap-2 text-sm cursor-pointer",children:[e.jsx(J,{className:"h-4 w-4 text-green-600"}),"원본 엑셀 파일 첨부"]})]})]})]})]}),e.jsxs(be,{children:[e.jsx(C,{variant:"outline",onClick:v,children:"취소"}),e.jsxs(C,{onClick:B,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),"이메일 발송"]})]})]})})}function Je({orders:j,onOrderUpdate:v,onOrderRemove:u,onSingleOrderSave:x,file:i}){const[E,d]=c.useState(null),[S,b]=c.useState(""),[p,D]=c.useState(j.reduce((s,t,a)=>({...s,[a]:!0}),{})),[g,m]=c.useState(null),[r,k]=c.useState(null),[$,P]=c.useState(!1),O=$e({mutationFn:async({order:s,sendEmail:t,index:a,isDraft:n=!1})=>{const l=new FormData;i&&l.append("excelFile",i),l.append("orders",JSON.stringify([s])),l.append("sendEmail",t.toString()),l.append("isDraft",n.toString());const N=await fetch("/api/orders/bulk-create-simple",{method:"POST",credentials:"include",body:l});if(!N.ok){const y=await N.text();throw new Error(y||"Failed to save order")}return N.json()},onSuccess:async(s,t)=>{await Pe.invalidateQueries({predicate:a=>a.queryKey.some(l=>typeof l=="string"&&(l.includes("orders")||l.includes("/api/orders")))}),t.isDraft?(h({title:"임시저장 완료",description:"발주서가 '임시저장' 상태로 저장되어 작업 목록에서 제거되었습니다. 발주서 관리 화면에서 언제든지 조회, 수정, 승인요청이 가능합니다."}),u(t.index,!0)):t.sendEmail?(k({...s,originalOrder:t.order,originalIndex:t.index}),P(!0),h({title:"발주서 생성 완료",description:"발주서가 생성되었습니다. 이메일을 작성해주세요."})):(h({title:"발주서 생성 완료",description:"발주서가 성공적으로 생성되었습니다. 생성된 발주서는 발주서 관리 화면에서 확인할 수 있습니다."}),u(t.index,!0))},onError:s=>{h({title:"발주서 생성 실패",description:s.message||"발주서 생성 중 오류가 발생했습니다.",variant:"destructive"})},onSettled:()=>{m(null)}}),w=(s,t)=>{d(s),b(t||"")},L=s=>{x?x(s,p[s]):(m(s),O.mutate({order:j[s],sendEmail:p[s],index:s}))},F=s=>{m(s),O.mutate({order:j[s],sendEmail:!1,index:s,isDraft:!0})},T=(s,t)=>{D(a=>({...a,[s]:t}))},A=(s,t,a)=>{const l={...j[s]};if(t.startsWith("item.")){const[,N]=t.split("."),y=l.items[0]||{};["quantity","unitPrice"].includes(N)?(y[N]=parseFloat(a)||0,y.quantity&&y.unitPrice&&(y.totalAmount=y.quantity*y.unitPrice)):y[N]=a,l.items=[y]}else l[t]=a;l.errors=[],l.vendorName||l.errors.push("거래처명 필수"),l.vendorEmail||l.errors.push("이메일 필수"),l.projectName||l.errors.push("프로젝트 필수"),l.isValid=l.errors.length===0,v(s,l),d(null)},K=(s,t,a)=>{s.key==="Enter"?(s.preventDefault(),A(t,a,S)):s.key==="Escape"&&d(null)},f=({cellId:s,value:t,orderIndex:a,field:n,type:l="text",icon:N,label:y,className:W=""})=>E===s?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-20",children:[y,":"]}),e.jsx(I,{type:l,value:S,onChange:M=>b(M.target.value),onKeyDown:M=>K(M,a,n),onBlur:()=>A(a,n,S),className:se("h-7 px-2 py-0 text-xs flex-1",W),autoFocus:!0})]}):e.jsxs("div",{className:"flex items-center gap-2 p-1 rounded cursor-pointer hover:bg-gray-50 group",onClick:()=>w(s,t),children:[N&&e.jsx("div",{className:"text-gray-400 w-4",children:N}),e.jsxs("span",{className:"text-xs text-gray-500 min-w-[80px]",children:[y,":"]}),e.jsx("span",{className:se("text-xs flex-1",!t&&"text-gray-400 italic"),children:t||"입력"})]}),V=async s=>{try{const t=await fetch("/api/orders/send-email-simple",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({to:s.to,cc:s.cc,subject:s.subject,body:s.body,orderData:{orderId:r?.orderId||r?.orderIds?.[0],orderNumber:r?.orderNumber,projectName:r?.projectName,vendorName:r?.vendorName,location:r?.location,orderDate:r?.orderDate,deliveryDate:r?.deliveryDate,totalAmount:r?.totalAmount,excelFilePath:r?.excelFilePath},attachPdf:s.attachPdf,attachExcel:s.attachExcel})}),a=await t.json();t.ok?a.message&&a.message.includes("개발 모드")?h({title:"이메일 테스트 모드",description:"SMTP 설정이 없어 실제 이메일은 발송되지 않았습니다. 발주서는 정상적으로 생성되었습니다.",variant:"default"}):h({title:"이메일 발송 완료",description:"발주서와 이메일이 성공적으로 발송되었습니다."}):h({title:"이메일 발송 실패",description:a.error||"이메일은 발송되지 않았지만 발주서는 생성되었습니다.",variant:"destructive"}),r?.originalIndex!==void 0&&u(r.originalIndex,!0)}catch(t){console.error("이메일 발송 오류:",t),h({title:"이메일 발송 실패",description:"네트워크 오류가 발생했습니다. 발주서는 정상적으로 생성되었습니다.",variant:"destructive"}),r?.originalIndex!==void 0&&u(r.originalIndex,!0)}finally{P(!1),k(null)}},B=()=>{P(!1),r?.originalIndex!==void 0&&u(r.originalIndex,!0),k(null)};return e.jsxs("div",{className:"space-y-4",children:[j.map((s,t)=>{const a=j[t].items[0]||{},n=(a.quantity||0)*(a.unitPrice||0);return e.jsxs(ce,{className:se("p-4 relative",s.isValid===!1&&"border-red-300 bg-red-50/30"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(z,{variant:"outline",className:"text-xs",children:["#",t+1]}),e.jsx(z,{variant:s.isValid?"default":"destructive",className:"text-xs h-5",children:s.isValid?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"유효"]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-3 w-3 mr-1"}),"검증 필요"]})}),s.errors&&s.errors.length>0&&e.jsxs("span",{className:"text-xs text-red-600",children:["(",s.errors.join(", "),")"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{id:`email-${t}`,checked:p[t],onCheckedChange:l=>T(t,l),disabled:g===t}),e.jsxs("label",{htmlFor:`email-${t}`,className:"text-xs text-gray-600 cursor-pointer",children:[e.jsx(Q,{className:"h-3 w-3 inline mr-1"}),"이메일 발송"]})]}),e.jsxs(C,{onClick:()=>L(t),disabled:!s.isValid||g===t,size:"sm",className:"bg-blue-600 hover:bg-blue-700 text-xs",children:[e.jsx(J,{className:"h-3 w-3 mr-1"}),g===t?"생성 중...":"발주서 생성"]}),e.jsxs(C,{onClick:()=>F(t),disabled:!s.isValid||g===t,size:"sm",variant:"outline",className:"text-xs",children:[e.jsx(Me,{className:"h-3 w-3 mr-1"}),g===t?"저장 중...":"임시저장"]}),e.jsx(C,{variant:"ghost",size:"icon",className:"h-6 w-6 text-gray-400 hover:text-red-600",onClick:()=>u(t),children:e.jsx(Y,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-3",children:[e.jsx(f,{cellId:`${t}-orderDate`,value:s.orderDate,orderIndex:t,field:"orderDate",label:"발주일자",icon:e.jsx(he,{className:"h-3 w-3"})}),e.jsx(f,{cellId:`${t}-deliveryDate`,value:s.deliveryDate,orderIndex:t,field:"deliveryDate",label:"납기일자",icon:e.jsx(he,{className:"h-3 w-3"})}),e.jsx(f,{cellId:`${t}-vendor`,value:s.vendorName,orderIndex:t,field:"vendorName",label:"거래처명",icon:e.jsx(te,{className:"h-3 w-3"})}),e.jsx(f,{cellId:`${t}-vendorEmail`,value:s.vendorEmail,orderIndex:t,field:"vendorEmail",label:"거래처 이메일",type:"email",icon:e.jsx(Q,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-3",children:[e.jsx(f,{cellId:`${t}-deliveryPlace`,value:s.deliveryPlace,orderIndex:t,field:"deliveryPlace",label:"납품처명",icon:e.jsx(te,{className:"h-3 w-3"})}),e.jsx(f,{cellId:`${t}-deliveryEmail`,value:s.deliveryEmail,orderIndex:t,field:"deliveryEmail",label:"납품처 이메일",type:"email",icon:e.jsx(Q,{className:"h-3 w-3"})}),e.jsx(f,{cellId:`${t}-project`,value:s.projectName,orderIndex:t,field:"projectName",label:"프로젝트명",icon:e.jsx(te,{className:"h-3 w-3"})})]}),e.jsx("div",{className:"border-t pt-3",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[e.jsx(f,{cellId:`${t}-itemName`,value:a.itemName,orderIndex:t,field:"item.itemName",label:"품목명",icon:e.jsx(we,{className:"h-3 w-3"})}),e.jsx(f,{cellId:`${t}-spec`,value:a.specification,orderIndex:t,field:"item.specification",label:"규격"}),e.jsx(f,{cellId:`${t}-qty`,value:a.quantity,orderIndex:t,field:"item.quantity",label:"수량",type:"number",icon:e.jsx(qe,{className:"h-3 w-3"})}),e.jsx(f,{cellId:`${t}-price`,value:a.unitPrice,orderIndex:t,field:"item.unitPrice",label:"단가",type:"number"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"총금액:"}),e.jsxs("span",{className:"text-sm font-medium",children:[n.toLocaleString(),"원"]})]}),e.jsx(f,{cellId:`${t}-remarks`,value:a.remarks,orderIndex:t,field:"item.remarks",label:"비고"})]})}),e.jsx("div",{className:"mt-3 pt-3 border-t",children:e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(f,{cellId:`${t}-majorCategory`,label:"대분류",value:s.majorCategory||"",orderIndex:t,field:"majorCategory",className:"h-7"}),e.jsx(f,{cellId:`${t}-middleCategory`,label:"중분류",value:s.middleCategory||"",orderIndex:t,field:"middleCategory",className:"h-7"}),e.jsx(f,{cellId:`${t}-minorCategory`,label:"소분류",value:s.minorCategory||"",orderIndex:t,field:"minorCategory",className:"h-7"})]})})]},t)}),j.length===0&&e.jsx("div",{className:"text-center py-12 text-gray-500",children:"업로드된 발주서가 없습니다."}),$&&r&&e.jsx(Xe,{isOpen:$,onClose:B,onSend:V,orderData:r?.originalOrder||r,initialTo:[{email:r?.originalOrder?.vendorEmail||"",name:r?.originalOrder?.vendorName||""}],initialCc:r?.originalOrder?.deliveryEmail?[{email:r?.originalOrder?.deliveryEmail,name:r?.originalOrder?.deliveryPlace||""}]:[]})]})}function Ge({isOpen:j,onClose:v,errors:u,onRetry:x,onDownloadTemplate:i}){return e.jsx(fe,{open:j,onOpenChange:v,children:e.jsxs(ve,{className:"sm:max-w-[500px] max-h-[80vh]",children:[e.jsxs(Ne,{children:[e.jsxs(ye,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(X,{className:"h-5 w-5"}),"Excel 필드명 오류"]}),e.jsx(Le,{children:"업로드한 파일의 필드명이 표준 형식과 일치하지 않습니다."})]}),e.jsx(Oe,{className:"max-h-[300px] rounded-md border p-4 bg-red-50",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-sm text-red-900 mb-3",children:"❌ 잘못된 필드명:"}),u.map((E,d)=>e.jsxs("div",{className:"text-sm text-red-700 ml-4",children:["• ",E]},d))]})}),e.jsxs("div",{className:"rounded-lg bg-blue-50 p-3 mt-2",children:[e.jsx("p",{className:"text-sm text-blue-900 font-medium mb-2",children:"✅ 해결 방법:"}),e.jsxs("ol",{className:"text-sm text-blue-700 space-y-1 ml-4",children:[e.jsx("li",{children:"1. 표준 템플릿을 다운로드하세요"}),e.jsx("li",{children:"2. 템플릿의 필드명을 정확히 사용하세요"}),e.jsx("li",{children:"3. 필드명을 수정 후 다시 업로드하세요"})]})]}),e.jsxs(be,{className:"gap-2",children:[i&&e.jsxs(C,{onClick:i,variant:"outline",className:"gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),"템플릿 다운로드"]}),x&&e.jsxs(C,{onClick:x,variant:"default",className:"gap-2",children:[e.jsx(ze,{className:"h-4 w-4"}),"다시 시도"]}),e.jsx(C,{onClick:v,variant:"secondary",children:"닫기"})]})]})})}function Ie(){Fe();const[,j]=ue(),v=c.useRef(null),[u,x]=c.useState(null),[i,E]=c.useState(!1),[d,S]=c.useState([]),[b,p]=c.useState(!1),[D,g]=c.useState(0),[m,r]=c.useState([]),[k,$]=c.useState([]),[P,O]=c.useState(!1),w=a=>{a.preventDefault(),a.stopPropagation(),a.type==="dragenter"||a.type==="dragover"?E(!0):a.type==="dragleave"&&E(!1)},L=a=>{if(a.preventDefault(),a.stopPropagation(),E(!1),a.dataTransfer.files&&a.dataTransfer.files[0]){const n=a.dataTransfer.files[0];T(n)}},F=a=>{a.target.files&&a.target.files[0]&&T(a.target.files[0])},T=a=>{const n=a.name.toLowerCase();if(!n.endsWith(".xlsx")&&!n.endsWith(".xls")&&!n.endsWith(".xlsm")){h({title:"파일 형식 오류",description:"엑셀 파일(.xlsx, .xls, .xlsm)만 업로드 가능합니다.",variant:"destructive"});return}x(a),A(a)},A=async a=>{p(!0),g(20);try{const n=await a.arrayBuffer();g(40);const l=je(n,{type:"array"});g(60);const N=l.SheetNames[0],y=l.Sheets[N],W=pe.sheet_to_json(y,{header:1});if(g(80),W.length===0)throw new Error("엑셀 파일이 비어있습니다.");const xe=W[0],M=["발주일자","납기일자","거래처명","거래처 이메일","납품처명","납품처 이메일","프로젝트명","대분류","중분류","소분류","품목명","규격","수량","단가","총금액","비고"],Z=[],Ee=new Map;for(let o=0;o<M.length;o++){const U=M[o],q=xe[o]?.toString().trim();!q||q!==U?Z.push(`컬럼 ${o+1}: "${q||"(빈값)"}" → 올바른 필드명: "${U}"`):Ee.set(U,o)}if(Z.length>0){$(Z),O(!0),p(!1);return}const ee=W.slice(1).filter(o=>o&&o.some(U=>U)).map((o,U)=>{const q=G=>G?typeof G=="number"?new Date((G-25569)*86400*1e3).toISOString().split("T")[0]:G.toString().trim():"";return{rowIndex:U+2,orderDate:q(o[0]),deliveryDate:q(o[1]),vendorName:o[2]?.toString().trim(),vendorEmail:o[3]?.toString().trim(),deliveryPlace:o[4]?.toString().trim(),deliveryEmail:o[5]?.toString().trim(),projectName:o[6]?.toString().trim(),majorCategory:o[7]?.toString().trim(),middleCategory:o[8]?.toString().trim(),minorCategory:o[9]?.toString().trim(),items:[{itemName:o[10]?.toString().trim(),specification:o[11]?.toString().trim(),quantity:parseFloat(o[12])||0,unitPrice:parseFloat(o[13])||0,totalAmount:parseFloat(o[14])||0,remarks:o[15]?.toString().trim()}],isValid:!0,errors:[]}});S(ee),r(ee),g(100),h({title:"엑셀 파일 로딩 완료",description:`발주서 생성을 위해 ${ee.length}개의 데이터가 성공적으로 로드되었습니다. 각 항목을 확인하고 수정한 후 '모두 저장' 버튼을 클릭하세요.`})}catch(n){console.error("Excel parsing error:",n);const l=n instanceof Error?n.message:"알 수 없는 오류가 발생했습니다.";l.includes("헤더가 올바르지 않습니다")?h({title:"엑셀 필드 검증 실패",description:l,variant:"destructive"}):h({title:"파일 파싱 실패",description:l,variant:"destructive"})}finally{p(!1),setTimeout(()=>g(0),1e3)}},K=(a,n)=>{const l=[...m];l[a]=n,r(l)},f=(a,n=!1)=>{const l=m.filter((N,y)=>y!==a);if(r(l),l.length===0&&d.length>0){h({title:"모든 처리 완료",description:`${d.length}개의 발주서가 모두 처리되었습니다. 발주서 관리 화면으로 이동합니다.`}),setTimeout(()=>j("/orders"),1500);return}n||h({title:"항목 제거",description:"선택한 항목이 목록에서 제거되었습니다."})},V=()=>{x(null),S([]),r([]),g(0)},B=()=>{v.current?.click()},s=async()=>{try{const n=await(await fetch("/api/excel-template/download")).blob(),l=window.URL.createObjectURL(n),N=document.createElement("a");N.href=l,N.download="PO_Excel_Template.xlsx",document.body.appendChild(N),N.click(),window.URL.revokeObjectURL(l),document.body.removeChild(N),h({title:"템플릿 다운로드 완료",description:"표준 Excel 템플릿을 다운로드했습니다."})}catch(a){console.error("Template download error:",a),h({title:"다운로드 실패",description:"템플릿 다운로드 중 오류가 발생했습니다.",variant:"destructive"})}},t=()=>{O(!1),$([]),B()};return e.jsxs("div",{className:"space-y-6",children:[m.length===0&&e.jsx(ce,{children:e.jsxs(ge,{className:"p-8",children:[e.jsx("input",{ref:v,type:"file",accept:".xlsx,.xls,.xlsm",onChange:F,className:"hidden"}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-12 text-center transition-colors ${i?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`,onDragEnter:w,onDragLeave:w,onDragOver:w,onDrop:L,children:[e.jsx(oe,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium text-gray-700",children:"엑셀 파일을 드래그하거나 클릭하여 업로드"}),e.jsx("p",{className:"text-sm text-gray-500",children:"DB 검증 없이 바로 편집 가능한 발주서로 변환됩니다"}),e.jsx("p",{className:"text-xs text-gray-400",children:".xlsx, .xls, .xlsm 파일 지원"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-6",children:[e.jsx(C,{onClick:B,disabled:b,size:"lg",children:b?"처리 중...":"파일 선택"}),e.jsxs(C,{onClick:s,variant:"outline",size:"lg",className:"gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),"템플릿 다운로드"]})]})]}),D>0&&e.jsxs("div",{className:"mt-6 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600",children:[e.jsx("span",{children:"파일 처리 중..."}),e.jsxs("span",{children:[D,"%"]})]}),e.jsx(Re,{value:D,className:"h-2"})]}),u&&e.jsxs(R,{className:"mt-6",children:[e.jsx(ne,{className:"h-4 w-4"}),e.jsxs(_,{children:[e.jsx("strong",{children:u.name})," (",(u.size/1024).toFixed(1)," KB)"]})]}),e.jsxs(R,{className:"mt-6 bg-blue-50 border-blue-200",children:[e.jsx(re,{className:"h-4 w-4 text-blue-600"}),e.jsx(_,{children:e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-semibold text-blue-900 mb-2",children:"📋 필수 Excel 필드명 (정확히 일치해야 함)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-blue-800",children:[e.jsxs("div",{children:["• ",e.jsx("strong",{children:"기본 정보:"})," 발주일자, 납기일자"]}),e.jsxs("div",{children:["• ",e.jsx("strong",{children:"거래처:"})," 거래처명, 거래처 이메일"]}),e.jsxs("div",{children:["• ",e.jsx("strong",{children:"납품처:"})," 납품처명, 납품처 이메일"]}),e.jsxs("div",{children:["• ",e.jsx("strong",{children:"프로젝트:"})," 프로젝트명"]}),e.jsxs("div",{children:["• ",e.jsx("strong",{children:"분류:"})," 대분류, 중분류, 소분류"]}),e.jsxs("div",{children:["• ",e.jsx("strong",{children:"품목:"})," 품목명, 규격, 수량, 단가, 총금액, 비고"]})]})]})})]}),e.jsxs(R,{className:"mt-6",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsxs(_,{children:[e.jsx("strong",{children:"엑셀 심플 업로드 특징:"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 text-sm space-y-1",children:[e.jsx("li",{children:"DB 값과 비교/보정 과정 없음"}),e.jsx("li",{children:"엑셀 데이터를 그대로 표시"}),e.jsx("li",{children:"모든 필드를 직접 수정 가능"}),e.jsx("li",{children:"여러 발주서를 한번에 편집 및 저장"})]})]})]})]})}),m.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sticky top-0 z-10 bg-white border rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{children:"각 발주서를 개별적으로 검토하고 저장하세요"})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["처리 진행률: ",d.length-m.length,"/",d.length,"개 완료"]})]}),e.jsxs(C,{onClick:V,variant:"outline",size:"lg",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"전체 초기화"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(z,{variant:"secondary",className:"px-3 py-1",children:[e.jsx(we,{className:"h-3 w-3 mr-1"}),m.length,"개 대기중"]}),e.jsxs(z,{variant:"success",className:"px-3 py-1 bg-green-100 text-green-700",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),d.length-m.length,"개 완료"]})]})]})}),e.jsx(Je,{orders:m,onOrderUpdate:K,onOrderRemove:f,file:u})]}),e.jsx(Ge,{isOpen:P,onClose:()=>O(!1),errors:k,onRetry:t,onDownloadTemplate:s})]})}const Qe={EXCEL_UPLOAD:!0,HANDSONTABLE:!1,APPROVAL_WORKFLOW:!1,ADVANCED_PERMISSIONS:!1};function Ye(j){return Qe[j]}function $s(){const[,j]=ue(),[v,u]=c.useState([]),{theme:x}=Te(),i=x==="dark",E=Ye("EXCEL_UPLOAD");console.log("🔍 Create Order Debug Info:",{isExcelUploadEnabled:E,VITE_ENVIRONMENT:"production",VITE_ENABLE_EXCEL_UPLOAD:"true",NODE_ENV:void 0,timestamp:new Date().toISOString()});const d=()=>{j("/orders")},S=()=>{j("/orders")},b=p=>{u(p)};return e.jsx("div",{className:`min-h-screen transition-colors ${i?"bg-gray-900":"bg-gray-50"}`,children:e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6 space-y-6 pb-20",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(J,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:`text-2xl font-bold transition-colors ${i?"text-white":"text-gray-900"}`,children:"발주서 작성"}),e.jsx("p",{className:`text-sm mt-1 transition-colors ${i?"text-gray-400":"text-gray-600"}`,children:"새로운 발주서를 작성하거나 Excel 파일을 업로드해주세요"})]})]})}),e.jsxs(R,{className:`mb-6 transition-colors ${i?"bg-gray-800 border-gray-700":"bg-white border-gray-200"}`,children:[e.jsx(re,{className:`h-4 w-4 ${i?"text-blue-400":"text-blue-600"}`}),e.jsx(_,{className:i?"text-gray-300":"text-gray-700",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:`font-medium ${i?"text-white":"text-gray-900"}`,children:"📋 사용팁"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:`font-medium ${i?"text-blue-400":"text-blue-600"}`,children:"Excel 업로드:"})," 대량 발주서, 반복 업무, 자동화 처리에 적합 (50건+ 권장)"]}),e.jsxs("div",{children:[e.jsx("span",{className:`font-medium ${i?"text-green-400":"text-green-600"}`,children:"일반 폼 작성:"})," 소량 발주서, 세밀한 조정, 즉시 처리에 적합 (10건 이하 권장)"]})]}),e.jsx("div",{className:`pt-2 border-t transition-colors ${i?"border-gray-700":"border-gray-200"}`,children:e.jsxs(C,{variant:"outline",size:"sm",className:`transition-colors ${i?"text-blue-400 border-gray-600 hover:bg-gray-700 hover:border-blue-500":"text-blue-600 border-blue-200 hover:bg-blue-50"}`,onClick:()=>{const p=document.createElement("a");p.href="/PO_Excel_Template.xlsx",p.download="PO_Excel_Template.xlsx",p.click()},children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Excel 템플릿 다운로드"]})})]})})]}),e.jsxs(Ke,{defaultValue:"excel",className:"w-full",children:[e.jsxs(We,{className:`grid w-full grid-cols-3 transition-colors ${i?"bg-gray-800 border-gray-700":"bg-gray-100"}`,children:[e.jsxs(ae,{value:"excel",className:`flex items-center gap-2 transition-colors ${i?"data-[state=active]:bg-gray-700 data-[state=active]:text-white hover:bg-gray-750":"data-[state=active]:bg-white data-[state=active]:text-gray-900"}`,children:[e.jsx(ne,{className:"h-4 w-4"}),"엑셀 파일 업로드"]}),e.jsxs(ae,{value:"form",className:`flex items-center gap-2 transition-colors ${i?"data-[state=active]:bg-gray-700 data-[state=active]:text-white hover:bg-gray-750":"data-[state=active]:bg-white data-[state=active]:text-gray-900"}`,children:[e.jsx(J,{className:"h-4 w-4"}),"직접 입력"]}),e.jsxs(ae,{value:"simple",className:`flex items-center gap-2 transition-colors ${i?"data-[state=active]:bg-gray-700 data-[state=active]:text-white hover:bg-gray-750":"data-[state=active]:bg-white data-[state=active]:text-gray-900"}`,children:[e.jsx(oe,{className:"h-4 w-4"}),"엑셀 업로드 입력"]})]}),e.jsx(le,{value:"excel",className:"mt-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(He,{onDataParsed:b}),v.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(R,{className:`transition-colors ${i?"bg-gray-800 border-gray-700":"bg-white border-gray-200"}`,children:e.jsx(_,{className:i?"text-gray-300":"text-gray-700",children:'Excel 데이터를 불러왔습니다. "직접 입력" 탭으로 이동하여 발주서를 완성해주세요.'})}),e.jsxs("div",{className:`rounded-lg p-4 transition-colors ${i?"bg-gray-800":"bg-gray-50"}`,children:[e.jsxs("h3",{className:`font-medium mb-3 transition-colors ${i?"text-white":"text-gray-900"}`,children:["미리보기 (",v.length,"개 행)"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx("table",{className:"min-w-full text-sm",children:e.jsxs("tbody",{children:[v.slice(0,5).map((p,D)=>e.jsx("tr",{className:`border-b transition-colors ${i?"border-gray-700":"border-gray-100"}`,children:p.slice(0,6).map((g,m)=>e.jsx("td",{className:`py-2 px-3 transition-colors ${i?"text-gray-300":"text-gray-900"}`,children:g||"-"},m))},D)),v.length>5&&e.jsx("tr",{children:e.jsxs("td",{colSpan:6,className:`py-2 px-3 text-center transition-colors ${i?"text-gray-400":"text-gray-500"}`,children:["... 외 ",v.length-5,"개 행"]})})]})})})]})]})]})}),e.jsx(le,{value:"form",className:"mt-6",children:e.jsx(Ae,{onSuccess:d,onCancel:S})}),e.jsx(le,{value:"simple",className:"mt-6",children:e.jsx(Ie,{})})]})]})})}export{$s as default};
