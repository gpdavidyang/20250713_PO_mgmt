import{v as qe,r as u,j as e,ah as G,a as te,p as ee,s as se,w as V,a8 as Y,B as N,X as ae,G as Be,h as he,m as de,L as f,I as J,P as le,A as Pe,D as Fe,E as ye,F as re,ak as Ve,c as Ke,b as Je}from"./index-DjAfYDOA.js";import{A as oe,a as ce}from"./alert-Dughf68L.js";import{P as He}from"./progress-CXJhfd_5.js";import{D as Te,a as Ae,b as Oe,c as De,e as Le}from"./dialog-BbIdk7IQ.js";import{S as X,a as W,b as Q,c as Z,d as T}from"./select-3-ceTvVr.js";import{T as Ge}from"./target-pX7Tbt3T.js";import{T as ue}from"./triangle-alert-CB72zIVM.js";import{T as Me}from"./trending-up-BQKaxzD5.js";import{A as $e}from"./arrow-right-BW-gA8XK.js";import{S as Xe}from"./search-DoLqPHmd.js";import{U as Ne}from"./upload-BrKilRYz.js";import{T as ie}from"./textarea-Bid3wNRg.js";import{C as be}from"./calendar-DcqLnfd-.js";import{P as we,a as Ce,b as Se}from"./popover-BKa2o2yA.js";import{C as ke}from"./calendar-BOggCMoY.js";import{T as Re}from"./trash-2-DuVwuAEc.js";import{f as Ee}from"./format-BqlaHE6C.js";import{k as Ie}from"./ko-DHTEdlBI.js";import{T as We,a as Qe,b as me,c as xe}from"./tabs-CLRv4ZU1.js";import{C as ne}from"./checkbox-Bu8iSM2P.js";import{M as ge}from"./mail-DsVvMP7e.js";import{R as ze}from"./refresh-cw-DMG6DAzo.js";import{D as ve}from"./download-Dw9zfdH9.js";import{P as pe}from"./paperclip-9veGhoHR.js";import{S as Ze}from"./save-BP2imVWy.js";import{S as Ye}from"./send-DebVCMhb.js";import{L as es}from"./list-Nmc--0ny.js";import{I as je}from"./info-DcTrNH2h.js";import"./index-DwE-nMEg.js";import"./index-BdQq_4o_.js";import"./index-0R4TikJ-.js";import"./chevron-down-ErttL176.js";import"./chevron-up-pENLZV2w.js";import"./chevron-left-D1JQpx-R.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=qe("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]),ss=({isOpen:a,onClose:A,mappingItems:m,onApplyMappings:y})=>{const[E,d]=u.useState([]),[b,O]=u.useState(0),[p,k]=u.useState(!1),[M,L]=u.useState([]),[I,x]=u.useState([]),[j,P]=u.useState([]),[_,R]=u.useState([]),[w,z]=u.useState(!1);u.useEffect(()=>{d([...m]),O(0)},[m]),u.useEffect(()=>{a&&M.length===0&&K()},[a]);const K=async()=>{z(!0);try{const n=await fetch("/api/categories");if(n.ok){const $=(await n.json()).flatCategories||[];L($),x($.filter(D=>D.categoryType==="major")),P($.filter(D=>D.categoryType==="middle")),R($.filter(D=>D.categoryType==="minor")),console.log("📋 전체 분류 로드 완료:",{total:$.length,major:$.filter(D=>D.categoryType==="major").length,middle:$.filter(D=>D.categoryType==="middle").length,minor:$.filter(D=>D.categoryType==="minor").length})}else console.error("❌ 분류 데이터 로드 실패:",n.status)}catch(n){console.error("❌ 분류 데이터 로드 오류:",n)}finally{z(!1)}},g=E[b];console.log("🔍 Current item data:",g),console.log("🔍 Mapping result DB data:",g?.mappingResult?.db);const B={total:E.length,resolved:E.filter(n=>n.userSelection||n.mappingResult.status==="exact_match").length,needsAttention:E.filter(n=>!n.userSelection&&n.mappingResult.status!=="exact_match").length},U=(n,S)=>{const $=[...E],D=$[b];D.userSelection||(D.userSelection={}),D.userSelection[`${n}Id`]=S,n==="major"?(D.userSelection.middleId=void 0,D.userSelection.minorId=void 0):n==="middle"&&(D.userSelection.minorId=void 0),d($)},q=()=>{const n=g?.userSelection?.majorId,S=g?.mappingResult?.db?.majorId;return console.log("🔍 getCurrentMajorId:",{userMajorId:n,autoMajorId:S,result:n||S}),n||S},i=()=>{const n=g?.userSelection?.middleId,S=g?.mappingResult?.db?.middleId;return console.log("🔍 getCurrentMiddleId:",{userMiddleId:n,autoMiddleId:S,result:n||S}),n||S},s=n=>n?j.filter(S=>S.parentId===n):[],t=n=>n?_.filter(S=>S.parentId===n):[],o=(n,S)=>{const $=g?.mappingResult?.suggestions?.filter(H=>H.type===n)||[];let D=[];n==="major"?D=I:n==="middle"?D=s(S):n==="minor"&&(D=t(S));const _e=$.map(H=>H.id),Ue=D.filter(H=>!_e.includes(H.id));return[...$.map(H=>({...H,isSuggestion:!0})),...Ue.map(H=>({...H,name:H.categoryName,type:H.categoryType,similarity:0,isSuggestion:!1}))]},c=()=>{b<E.length-1?O(b+1):h()},r=()=>{b<E.length-1?O(b+1):h()},l=()=>{b>0&&O(b-1)},h=async()=>{k(!0);try{await y(E),A()}catch(n){console.error("매핑 적용 실패:",n)}finally{k(!1)}},v=n=>{switch(n){case"exact_match":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"partial_match":return e.jsx(ue,{className:"w-4 h-4 text-yellow-600"});case"no_match":return e.jsx(ae,{className:"w-4 h-4 text-red-600"});default:return e.jsx(Xe,{className:"w-4 h-4 text-gray-600"})}},F=n=>{switch(n){case"exact_match":return"bg-green-100 text-green-800 border-green-200";case"partial_match":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"no_match":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},C=n=>n>=80?"text-green-600":n>=60?"text-yellow-600":"text-red-600";return!g&&!w?null:e.jsx(Te,{open:a,onOpenChange:A,children:e.jsxs(Ae,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Oe,{children:e.jsxs(De,{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"w-5 h-5 text-blue-600"}),"분류 매핑 검증 및 수정",w&&e.jsx(G,{className:"w-4 h-4 animate-spin text-blue-600"})]})}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["진행률: ",b+1," / ",E.length]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"w-3 h-3 text-green-600"}),e.jsxs("span",{children:["해결됨: ",B.resolved]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:"w-3 h-3 text-yellow-600"}),e.jsxs("span",{children:["검토 필요: ",B.needsAttention]})]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${(b+1)/E.length*100}%`}})})]}),w&&!g?e.jsx(ee,{className:"mb-6",children:e.jsx(se,{className:"p-4",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(G,{className:"w-8 h-8 mx-auto mb-2 animate-spin text-blue-600"}),e.jsx("p",{className:"text-sm text-gray-600",children:"분류 데이터를 불러오는 중..."})]})})})}):g?e.jsx(ee,{className:"mb-6",children:e.jsxs(se,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900",children:g.itemName}),e.jsxs("div",{className:"flex items-center gap-2",children:[v(g.mappingResult.status),e.jsxs(V,{className:F(g.mappingResult.status),children:[g.mappingResult.status==="exact_match"&&"완전 매칭",g.mappingResult.status==="partial_match"&&"부분 매칭",g.mappingResult.status==="no_match"&&"매칭 없음",g.mappingResult.status==="invalid_hierarchy"&&"계층 오류"]}),e.jsxs(V,{variant:"outline",className:Y("text-xs",C(g.mappingResult.confidence)),children:[e.jsx(Me,{className:"w-3 h-3 mr-1"}),"신뢰도: ",g.mappingResult.confidence,"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"엑셀 대분류"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.major||"없음"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"엑셀 중분류"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.middle||"없음"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"엑셀 소분류"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.minor||"없음"})]})]}),e.jsx("div",{className:"flex items-center justify-center py-2",children:e.jsx($e,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"시스템 대분류"}),e.jsxs(X,{value:g.userSelection?.majorId?.toString()||g.mappingResult.db.majorId?.toString()||"",onValueChange:n=>U("major",parseInt(n)),disabled:w,children:[e.jsx(W,{className:"h-8",children:e.jsx(Q,{placeholder:w?"로딩 중...":"대분류 선택"})}),e.jsx(Z,{children:o("major").map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"시스템 중분류"}),e.jsxs(X,{value:g.userSelection?.middleId?.toString()||g.mappingResult.db.middleId?.toString()||"",onValueChange:n=>U("middle",parseInt(n)),disabled:w||!q(),children:[e.jsx(W,{className:"h-8",children:e.jsx(Q,{placeholder:w?"로딩 중...":q()?"중분류 선택":"먼저 대분류를 선택하세요"})}),e.jsx(Z,{children:o("middle",q()).map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"시스템 소분류"}),e.jsxs(X,{value:g.userSelection?.minorId?.toString()||g.mappingResult.db.minorId?.toString()||"",onValueChange:n=>U("minor",parseInt(n)),disabled:w||!i(),children:[e.jsx(W,{className:"h-8",children:e.jsx(Q,{placeholder:w?"로딩 중...":i()?"소분류 선택":"먼저 중분류를 선택하세요"})}),e.jsx(Z,{children:o("minor",i()).map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]})]})]})}):null,g&&g.mappingResult.suggestions.length>0&&e.jsxs(oe,{className:"mb-6",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsxs(ce,{children:[e.jsx("div",{className:"font-medium mb-2",children:"💡 추천 매핑:"}),e.jsx("div",{className:"text-sm space-y-1",children:g.mappingResult.suggestions.slice(0,3).map((n,S)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[n.type==="major"&&"대분류: ",n.type==="middle"&&"중분류: ",n.type==="minor"&&"소분류: ",n.name]}),e.jsxs(V,{variant:"outline",className:"text-xs",children:["유사도 ",n.similarity,"%"]})]},S))})]})]}),e.jsxs(Le,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",onClick:l,disabled:b===0||w,size:"sm",children:"이전"}),e.jsx(N,{variant:"outline",onClick:c,disabled:w,size:"sm",children:"건너뛰기"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",onClick:A,disabled:p,children:"취소"}),!w&&g&&(b<E.length-1?e.jsx(N,{onClick:r,disabled:p,children:"다음"}):e.jsx(N,{onClick:h,disabled:p,className:"bg-blue-600 hover:bg-blue-700",children:p?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4 mr-2 animate-spin"}),"적용 중..."]}):"매핑 적용"}))]})]})]})})},ts=({onDataExtracted:a,onProcessedFileReady:A})=>{const[m,y]=u.useState(!1),[E,d]=u.useState(!1),[b,O]=u.useState(null),[p,k]=u.useState("idle"),[M,L]=u.useState(""),[I,x]=u.useState([]),[j,P]=u.useState(0),[_,R]=u.useState(!1),[w,z]=u.useState([]),[K,g]=u.useState(null),B=u.useCallback(r=>{r.preventDefault(),y(!0)},[]),U=u.useCallback(r=>{r.preventDefault(),y(!1)},[]),q=u.useCallback(r=>{r.preventDefault(),y(!1);const h=Array.from(r.dataTransfer.files).find(v=>v.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||v.name.endsWith(".xlsx"));h?s(h):(L("엑셀 파일(.xlsx)만 업로드 가능합니다."),k("error"))},[]),i=r=>{const l=r.target.files?.[0];l&&s(l)},s=async r=>{O(r),d(!0),k("processing"),L("");const l=new FormData;l.append("file",r);try{const h=await fetch("/api/po-template/upload",{method:"POST",body:l});if(!h.ok)throw new Error("파일 업로드 실패");const v=await h.json();if(v.success&&v.data.orders.length>0){x(v.data.orders),k("success");try{const F=await fetch("/api/po-template/extract-sheets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:v.data.filePath,sheetNames:["갑지","을지"]})});if(F.ok){const C=await F.json();if(C.success&&C.data.extractedPath){const S=`/uploads/${C.data.extractedPath.split("/").pop()}`,$=`${r.name.replace(".xlsx","")}_Input제거.xlsx`;console.log("🔷 처리된 Excel 파일 정보:",{processedFileUrl:S,processedFileName:$}),A?.({url:S,name:$})}}else{console.warn("⚠️ Extract sheets API 실패, 기본값 사용");const n=`/uploads/extracted-${Date.now()}.xlsx`,S=`${r.name.replace(".xlsx","")}_Input제거.xlsx`;A?.({url:n,name:S})}}catch(F){console.error("Extract sheets 호출 실패:",F);const n=`/uploads/extracted-${Date.now()}.xlsx`,S=`${r.name.replace(".xlsx","")}_Input제거.xlsx`;A?.({url:n,name:S})}if(v.data.orders.length===1){const F=v.data.orders[0],C={...F,projectName:F.siteName||F.projectName,orderDate:F.orderDate,deliveryDate:F.dueDate||F.deliveryDate,items:(F.items||[]).map(n=>({...n,name:n.itemName||n.name,unit:n.unit||"EA"}))};await t(C)}}else throw new Error(v.error||"데이터 추출 실패")}catch(h){L(h.message||"파일 처리 중 오류가 발생했습니다."),k("error")}finally{d(!1)}},t=async r=>{if(console.log("🔍 분류 매핑 검증 시작:",r),console.log("🔍 첫 번째 아이템 상세:",r.items?.[0]),!r.items||r.items.length===0){a(r);return}try{const l=r.items.map(C=>({majorCategory:C.majorCategory||C.categoryLv1||C.대분류,middleCategory:C.middleCategory||C.categoryLv2||C.중분류,minorCategory:C.minorCategory||C.categoryLv3||C.소분류}));console.log("🔍 분류 검증 요청 데이터:",l);const h=await fetch("/api/categories/validate-mapping-batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({categories:l})});if(!h.ok)throw new Error("분류 검증 API 호출 실패");const v=await h.json();console.log("🔍 분류 검증 결과:",v);const F=v.results.filter(C=>C.status==="no_match"||C.status==="partial_match"||C.status==="invalid_hierarchy");if(F.length>0){console.log(`⚠️ ${F.length}개 품목에 분류 매핑 문제 발견`);const C=[];v.results.forEach((n,S)=>{if(n.status==="no_match"||n.status==="partial_match"||n.status==="invalid_hierarchy"){const $=r.items[S];C.push({itemName:$.itemName||$.name||`품목 ${S+1}`,rowIndex:S,originalCategories:{major:n.excel.major,middle:n.excel.middle,minor:n.excel.minor},mappingResult:n})}}),g(r),z(C),R(!0)}else{console.log("✅ 모든 분류가 성공적으로 매핑됨");const C={...r};C.items=r.items.map(n=>({...n,majorCategory:n.majorCategory||n.categoryLv1||n.대분류||"",middleCategory:n.middleCategory||n.categoryLv2||n.중분류||"",minorCategory:n.minorCategory||n.categoryLv3||n.소분류||""})),console.log("🔧 카테고리 필드 매핑 완료:",C.items[0]),a(C)}}catch(l){console.error("❌ 분류 검증 실패:",l),console.warn("분류 검증에 실패했지만 계속 진행합니다.");const h={...r};h.items=r.items.map(v=>({...v,majorCategory:v.majorCategory||v.categoryLv1||v.대분류||"",middleCategory:v.middleCategory||v.categoryLv2||v.중분류||"",minorCategory:v.minorCategory||v.categoryLv3||v.소분류||""})),console.log("🔧 카테고리 필드 매핑 완료 (검증 실패 시):",h.items[0]),a(h)}},o=async r=>{if(console.log("🔧 사용자 분류 매핑 적용:",r),!K){console.error("❌ 대기 중인 발주서 데이터가 없습니다.");return}const l={...K};r.forEach(h=>{const v=l.items.findIndex(F=>(F.itemName||F.name)===h.itemName);if(v!==-1&&h.userSelection){const F=l.items[v];h.userSelection.majorId&&(F.majorCategoryId=h.userSelection.majorId),h.userSelection.middleId&&(F.middleCategoryId=h.userSelection.middleId),h.userSelection.minorId&&(F.minorCategoryId=h.userSelection.minorId)}}),R(!1),z([]),g(null),console.log("✅ 분류 매핑이 적용된 발주서 데이터:",l),a(l)},c=async()=>{if(I[j]&&b){const r=I[j],l={...r,projectName:r.siteName||r.projectName,orderDate:r.orderDate,deliveryDate:r.dueDate||r.deliveryDate,items:(r.items||[]).map(h=>({...h,name:h.itemName||h.name,unit:h.unit||"EA"}))};await t(l)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{onDragOver:B,onDragLeave:U,onDrop:q,className:`
          border-2 border-dashed rounded-lg ${p==="success"?"p-4":"p-8"} text-center transition-all
          ${m?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}
          ${E?"opacity-50 pointer-events-none":""}
        `,children:E?e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"w-8 h-8 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"파일을 처리하고 있습니다..."})]}):p==="success"?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-green-700",children:b?.name}),e.jsxs("p",{className:"text-xs text-gray-600",children:[I.length,"개의 발주서 감지됨"]})]})]}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>{k("idle"),x([]),O(null)},children:"다시 업로드"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Be,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-700 mb-2",children:"엑셀 파일을 드래그하여 놓으세요"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"또는"}),e.jsx("input",{type:"file",accept:".xlsx",onChange:i,className:"hidden",id:"excel-upload"}),e.jsx("label",{htmlFor:"excel-upload",children:e.jsx(N,{variant:"outline",asChild:!0,children:e.jsxs("span",{className:"cursor-pointer",children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"파일 선택"]})})})]})}),p==="error"&&M&&e.jsxs(oe,{variant:"destructive",children:[e.jsx(he,{className:"h-4 w-4"}),e.jsx(ce,{children:M})]}),I.length>1&&p==="success"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"발주서를 선택하세요:"}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto border rounded-lg p-2 bg-gray-50",children:I.map((r,l)=>e.jsx("div",{onClick:()=>P(l),className:`
                  p-3 border rounded-lg cursor-pointer transition-colors
                  ${j===l?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 bg-white"}
                `,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:r.orderNumber}),e.jsxs("p",{className:"text-xs text-gray-600",children:[r.vendorName," | ",r.projectName]})]}),e.jsxs(V,{variant:"secondary",children:[r.items?.length||0,"개 품목"]})]}),r.items&&r.items.length>0&&e.jsxs("div",{className:"pt-2 border-t border-gray-200",children:[e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-gray-500",children:[e.jsx("th",{className:"text-left font-normal",children:"품목"}),e.jsx("th",{className:"text-right font-normal",children:"수량"}),e.jsx("th",{className:"text-right font-normal",children:"단가"}),e.jsx("th",{className:"text-right font-normal",children:"금액"})]})}),e.jsx("tbody",{children:r.items.slice(0,2).map((h,v)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-gray-600 truncate max-w-[150px] pr-2",children:h.itemName}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(h.quantity||0).toLocaleString()}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(h.unitPrice||0).toLocaleString()}),e.jsx("td",{className:"text-right font-medium",children:Math.floor(h.totalAmount||0).toLocaleString()})]},v))})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[r.items.length>2&&e.jsxs("p",{className:"text-xs text-gray-500 italic",children:["외 ",r.items.length-2,"개"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-xs text-gray-600 mr-2",children:"총액"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-600",children:[Math.floor(r.totalAmount||r.items.reduce((h,v)=>h+(v.totalAmount||0),0)).toLocaleString(),"원"]})]})]})]})]})},l))}),e.jsx(N,{onClick:c,className:"w-full",size:"sm",children:"선택한 발주서 사용"})]}),e.jsx(ss,{isOpen:_,onClose:()=>{R(!1),z([]),g(null)},mappingItems:w,onApplyMappings:o})]})},rs=({initialData:a={},onChange:A})=>{const[m,y]=u.useState({orderNumber:a.orderNumber||`PO-${new Date().getTime()}`,orderDate:a.orderDate||new Date,deliveryDate:a.deliveryDate||new Date(Date.now()+6048e5),projectId:a.projectId||"",projectName:a.projectName||"",vendorId:a.vendorId||"",vendorName:a.vendorName||"",vendorEmail:a.vendorEmail||"",items:a.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:a.notes||"",totalAmount:a.totalAmount||0}),{data:E,isLoading:d,error:b}=de({queryKey:["projects"],queryFn:async()=>{console.log("🔍 프로젝트 목록 조회 시작");const i=await fetch("/api/projects");if(!i.ok)throw new Error("프로젝트 목록 조회 실패");const s=await i.json();return console.log("✅ 프로젝트 목록 조회 성공:",s.length,"개"),s}}),{data:O,isLoading:p,error:k}=de({queryKey:["vendors"],queryFn:async()=>{console.log("🔍 거래처 목록 조회 시작");const i=await fetch("/api/vendors");if(!i.ok)throw new Error("거래처 목록 조회 실패");const s=await i.json();return console.log("✅ 거래처 목록 조회 성공:",s.length,"개"),s}}),{data:M,isLoading:L,error:I}=de({queryKey:["categories"],queryFn:async()=>{console.log("🔍 카테고리 목록 조회 시작");const i=await fetch("/api/item-categories");if(!i.ok)throw new Error("카테고리 목록 조회 실패");const s=await i.json();return console.log("✅ 카테고리 목록 조회 성공:",s?.length,"개"),{categories:s}}}),x=u.useRef({}),j=u.useRef(!0);u.useEffect(()=>{if(a&&Object.keys(a).length>0){const i=x.current;(j.current||a.orderNumber!==i.orderNumber||a.projectName!==i.projectName||a.vendorName!==i.vendorName||a.items?.length!==i.items?.length)&&(console.log("📝 DirectInputForm: initialData 유의미한 변경 감지",{isInitialLoad:j.current,orderNumber:a.orderNumber}),y({orderNumber:a.orderNumber||`PO-${new Date().getTime()}`,orderDate:a.orderDate?new Date(a.orderDate):new Date,deliveryDate:a.deliveryDate?new Date(a.deliveryDate):new Date(Date.now()+7*24*60*60*1e3),projectId:a.projectId||"",projectName:a.projectName||"",vendorId:a.vendorId||"",vendorName:a.vendorName||"",vendorEmail:a.vendorEmail||"",items:a.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:a.notes||"",totalAmount:a.totalAmount||0}),x.current=a,j.current=!1)}},[a]),u.useEffect(()=>{const i=m.items.reduce((s,t)=>s+(t.totalAmount||0),0);i!==m.totalAmount&&y(s=>({...s,totalAmount:i}))},[m.items]),u.useEffect(()=>{const i=setTimeout(()=>{A(m)},100);return()=>clearTimeout(i)},[m.orderNumber,m.projectName,m.vendorName,m.vendorEmail,m.totalAmount,m.items.length]);const P=(i,s)=>{y(t=>({...t,[i]:s}))},_=i=>{const s=E?.find(t=>t.id.toString()===i);s&&y(t=>({...t,projectId:i,projectName:s.projectName}))},R=i=>{const s=O?.find(t=>t.id.toString()===i);s&&y(t=>({...t,vendorId:i,vendorName:s.name,vendorEmail:s.email||""}))},w=(i,s,t)=>{const o=[...m.items];o[i]={...o[i],[s]:t},(s==="quantity"||s==="unitPrice")&&(o[i].totalAmount=o[i].quantity*o[i].unitPrice),y(c=>({...c,items:o}))},z=()=>{y(i=>({...i,items:[...i.items,{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}]}))},K=i=>{if(m.items.length>1){const s=m.items.filter((t,o)=>o!==i);y(t=>({...t,items:s}))}},g=()=>M?.categories?.filter(i=>i.categoryType==="major")||[],B=i=>{const s=M?.categories?.find(t=>t.categoryType==="major"&&t.categoryName===i);return s?M?.categories?.filter(t=>t.categoryType==="middle"&&t.parentId===s.id)||[]:[]},U=i=>{const s=M?.categories?.find(t=>t.categoryType==="middle"&&t.categoryName===i);return s?M?.categories?.filter(t=>t.categoryType==="minor"&&t.parentId===s.id)||[]:[]},q=(i,s,t)=>{const o=[...m.items],c=o[i];if(s==="major"){const r=g().find(l=>l.id.toString()===t);c.majorCategory=r?.categoryName||"",c.middleCategory="",c.minorCategory=""}else if(s==="middle"){const r=B(c.majorCategory).find(l=>l.id.toString()===t);c.middleCategory=r?.categoryName||"",c.minorCategory=""}else if(s==="minor"){const r=U(c.middleCategory).find(l=>l.id.toString()===t);c.minorCategory=r?.categoryName||""}y(r=>({...r,items:o}))};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"기본 정보"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"orderNumber",children:"발주번호"}),e.jsx(J,{id:"orderNumber",value:m.orderNumber,onChange:i=>P("orderNumber",i.target.value),placeholder:"PO-20240101-001"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"발주일"}),e.jsxs(we,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(N,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),Ee(m.orderDate,"PPP",{locale:Ie})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(be,{mode:"single",selected:m.orderDate,onSelect:i=>i&&P("orderDate",i),initialFocus:!0})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"현장"}),e.jsxs(X,{value:m.projectId,onValueChange:_,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:d?"로딩 중...":b?"로딩 실패":"현장 선택"})}),e.jsxs(Z,{children:[d&&e.jsx(T,{value:"loading",disabled:!0,children:"로딩 중..."}),b&&e.jsx(T,{value:"error",disabled:!0,children:"데이터 로딩 실패"}),E?.map(i=>e.jsx(T,{value:i.id.toString(),children:i.projectName},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"납기일"}),e.jsxs(we,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(N,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),Ee(m.deliveryDate,"PPP",{locale:Ie})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(be,{mode:"single",selected:m.deliveryDate,onSelect:i=>i&&P("deliveryDate",i),initialFocus:!0})})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"거래처 정보"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"거래처"}),e.jsxs(X,{value:m.vendorId,onValueChange:R,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:p?"로딩 중...":k?"로딩 실패":"거래처 선택"})}),e.jsxs(Z,{children:[p&&e.jsx(T,{value:"loading",disabled:!0,children:"로딩 중..."}),k&&e.jsx(T,{value:"error",disabled:!0,children:"데이터 로딩 실패"}),O?.map(i=>e.jsx(T,{value:i.id.toString(),children:i.name},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"vendorEmail",children:"이메일"}),e.jsx(J,{id:"vendorEmail",type:"email",value:m.vendorEmail,onChange:i=>P("vendorEmail",i.target.value),placeholder:"vendor@example.com"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"품목 정보"}),e.jsxs(N,{onClick:z,size:"sm",variant:"outline",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"품목 추가"]})]}),e.jsx("div",{className:"space-y-4",children:m.items.map((i,s)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"품목명"}),e.jsx(J,{value:i.itemName,onChange:t=>w(s,"itemName",t.target.value),placeholder:"품목명을 입력하세요"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"규격"}),e.jsx(J,{value:i.specification,onChange:t=>w(s,"specification",t.target.value),placeholder:"규격을 입력하세요"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"단위"}),e.jsxs(X,{value:i.unit,onValueChange:t=>w(s,"unit",t),children:[e.jsx(W,{children:e.jsx(Q,{placeholder:"단위 선택"})}),e.jsxs(Z,{children:[e.jsx(T,{value:"EA",children:"EA"}),e.jsx(T,{value:"M",children:"M"}),e.jsx(T,{value:"M2",children:"M²"}),e.jsx(T,{value:"M3",children:"M³"}),e.jsx(T,{value:"KG",children:"KG"}),e.jsx(T,{value:"TON",children:"TON"}),e.jsx(T,{value:"SET",children:"SET"}),e.jsx(T,{value:"BOX",children:"BOX"}),e.jsx(T,{value:"ROLL",children:"ROLL"}),e.jsx(T,{value:"L",children:"L"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"대분류"}),e.jsxs(X,{value:i.majorCategory?g().find(t=>t.categoryName===i.majorCategory)?.id.toString():"",onValueChange:t=>q(s,"major",t),children:[e.jsx(W,{children:e.jsx(Q,{placeholder:L?"로딩 중...":I?"로딩 실패":"대분류 선택"})}),e.jsxs(Z,{children:[L&&e.jsx(T,{value:"loading",disabled:!0,children:"로딩 중..."}),I&&e.jsx(T,{value:"error",disabled:!0,children:"데이터 로딩 실패"}),g().map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"중분류"}),e.jsxs(X,{value:i.middleCategory?B(i.majorCategory).find(t=>t.categoryName===i.middleCategory)?.id.toString():"",onValueChange:t=>q(s,"middle",t),disabled:!i.majorCategory,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:i.majorCategory?"중분류 선택":"대분류를 먼저 선택하세요"})}),e.jsx(Z,{children:B(i.majorCategory).map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"소분류"}),e.jsxs(X,{value:i.minorCategory?U(i.middleCategory).find(t=>t.categoryName===i.minorCategory)?.id.toString():"",onValueChange:t=>q(s,"minor",t),disabled:!i.middleCategory,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:i.middleCategory?"소분류 선택":"중분류를 먼저 선택하세요"})}),e.jsx(Z,{children:U(i.middleCategory).map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"수량"}),e.jsx(J,{type:"number",value:i.quantity,onChange:t=>w(s,"quantity",Number(t.target.value)),min:"1",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"단가"}),e.jsx(J,{type:"number",value:i.unitPrice,onChange:t=>w(s,"unitPrice",Number(t.target.value)),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"금액"}),e.jsxs("div",{className:"px-3 py-2 bg-muted border rounded-md text-sm font-medium text-foreground",children:[i.totalAmount.toLocaleString(),"원"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"작업"}),e.jsxs(N,{onClick:()=>K(s),size:"sm",variant:"outline",className:"w-full text-red-600 border-red-200 hover:bg-red-50",disabled:m.items.length===1,children:[e.jsx(Re,{className:"w-4 h-4 mr-1"}),"삭제"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"품목 비고"}),e.jsx(ie,{value:i.notes,onChange:t=>w(s,"notes",t.target.value),placeholder:"이 품목에 대한 특별 요청사항이나 참고사항을 입력하세요",rows:2})]})]},s))}),e.jsx("div",{className:"flex justify-end p-3 bg-muted rounded-lg",children:e.jsxs("div",{className:"text-lg font-semibold text-foreground",children:["총액: ",m.totalAmount.toLocaleString(),"원"]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"notes",children:"비고"}),e.jsx(ie,{id:"notes",value:m.notes,onChange:i=>P("notes",i.target.value),placeholder:"추가 요청사항이나 특이사항을 입력하세요",rows:3})]})]})},as=({orderData:a,pdfUrl:A,processingStatus:m})=>{const[y,E]=u.useState([a.vendorEmail||""]),[d,b]=u.useState([]),[O,p]=u.useState(`발주서 - ${a.orderNumber||""}`),[k,M]=u.useState("info");u.useState(!1);const[L,I]=u.useState([]),[x,j]=u.useState([]),[P,_]=u.useState(()=>`안녕하세요,

${a.vendorName||"거래처"} 담당자님

발주서를 첨부하여 보내드립니다.

발주번호: ${a.orderNumber||"-"}
프로젝트: ${a.projectName||"-"}
납기일: ${a.deliveryDate?new Date(a.deliveryDate).toLocaleDateString("ko-KR"):"-"}

확인 후 회신 부탁드립니다.

감사합니다.`);u.useEffect(()=>{_(`안녕하세요,

${a.vendorName||"거래처"} 담당자님

발주서를 첨부하여 보내드립니다.

발주번호: ${a.orderNumber||"-"}
프로젝트: ${a.projectName||"-"}
납기일: ${a.deliveryDate?new Date(a.deliveryDate).toLocaleDateString("ko-KR"):"-"}

확인 후 회신 부탁드립니다.

감사합니다.`)},[a.vendorName,a.orderNumber,a.projectName,a.deliveryDate]),u.useEffect(()=>{const s=[];a.processedExcelUrl&&s.push({id:"processed-excel",name:a.originalFileName||"처리된_Excel_파일.xlsx",size:0,type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",url:a.processedExcelUrl,isDefault:!0,isSelected:!0}),A&&m.pdf==="completed"&&s.push({id:"generated-pdf",name:`발주서_${a.orderNumber||"generated"}.pdf`,size:0,type:"application/pdf",url:A,isDefault:!0,isSelected:!0}),I(t=>{const o=t.filter(c=>!c.isDefault);return[...s,...o]})},[a.processedExcelUrl,A,m.pdf,a.orderNumber]);const R=s=>{s==="to"?E([...y,""]):b([...d,""])},w=(s,t)=>{s==="to"&&y.length>1?E(y.filter((o,c)=>c!==t)):s==="cc"&&b(d.filter((o,c)=>c!==t))},z=(s,t,o)=>{if(s==="to"){const c=[...y];c[t]=o,E(c)}else{const c=[...d];c[t]=o,b(c)}},K=async s=>{const t=Array.from(s);for(const o of t){const c=`custom-${Date.now()}-${Math.random()}`;j(r=>[...r,c]);try{const r={id:c,name:o.name,size:o.size,type:o.type,file:o,isDefault:!1,isSelected:!0};I(l=>[...l,r])}catch(r){console.error("파일 업로드 실패:",r)}finally{j(r=>r.filter(l=>l!==c))}}},g=s=>{I(t=>t.map(o=>o.id===s?{...o,isSelected:!o.isSelected}:o))},B=s=>{I(t=>t.filter(o=>o.id!==s))},U=s=>{if(s===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,c)).toFixed(2))+" "+o[c]},q=s=>s.includes("pdf")?e.jsx(re,{className:"w-4 h-4 text-red-600"}):s.includes("spreadsheet")||s.includes("excel")?e.jsx(re,{className:"w-4 h-4 text-green-600"}):e.jsx(pe,{className:"w-4 h-4 text-gray-600"}),i=s=>{switch(s){case"completed":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"processing":return e.jsx(G,{className:"w-4 h-4 text-blue-600 animate-spin"});case"error":return e.jsx(he,{className:"w-4 h-4 text-red-600"});default:return null}};return e.jsxs(ee,{className:"h-full",children:[e.jsx(Pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Fe,{children:"실시간 미리보기"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{variant:m.pdf==="completed"?"success":"secondary",children:[i(m.pdf),e.jsx("span",{className:"ml-1",children:"PDF"})]}),e.jsxs(V,{variant:m.vendor==="completed"?"success":"secondary",children:[i(m.vendor),e.jsx("span",{className:"ml-1",children:"거래처"})]}),e.jsxs(V,{variant:m.email==="completed"?"success":"secondary",children:[i(m.email),e.jsx("span",{className:"ml-1",children:"이메일"})]})]})]})}),e.jsx(se,{className:"h-[calc(100%-5rem)]",children:e.jsxs(We,{value:k,onValueChange:M,className:"h-full",children:[e.jsxs(Qe,{className:"grid w-full grid-cols-3",children:[e.jsxs(me,{value:"info",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"발주서 정보"]}),e.jsxs(me,{value:"pdf",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"PDF 미리보기"]}),e.jsxs(me,{value:"email",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"이메일 설정"]})]}),e.jsx(xe,{value:"pdf",className:"h-[calc(100%-3rem)]",children:m.pdf==="processing"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(G,{className:"w-12 h-12 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"PDF를 생성하고 있습니다..."})]})}):m.pdf==="error"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(he,{className:"w-12 h-12 mx-auto text-red-600"}),e.jsx("p",{className:"text-sm text-red-600",children:"PDF 생성 실패"}),e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(ze,{className:"w-4 h-4 mr-2"}),"다시 시도"]})]})}):A&&m.pdf==="completed"?e.jsx("div",{className:"w-full h-full flex flex-col",children:e.jsx("div",{className:"flex-1 bg-gray-50 rounded-lg p-8 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(te,{className:"w-16 h-16 mx-auto text-green-600"}),e.jsx("h3",{className:"text-lg font-medium",children:"PDF가 생성되었습니다"}),e.jsx("p",{className:"text-sm text-gray-600",children:"아래 버튼을 클릭하여 PDF를 확인하세요"}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-6",children:[e.jsxs(N,{variant:"default",onClick:()=>window.open(A,"_blank"),children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"PDF 미리보기"]}),e.jsxs(N,{variant:"outline",onClick:()=>window.open(`${A}?download=true`,"_blank"),children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"PDF 다운로드"]})]})]})})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(re,{className:"w-12 h-12 mx-auto text-gray-400"}),e.jsx("p",{className:"text-sm text-gray-600",children:"발주서 정보가 완성되면 PDF가 자동으로 생성됩니다"}),e.jsx("p",{className:"text-xs text-gray-500",children:"먼저 '발주서 정보' 탭에서 내용을 확인해주세요"})]})})}),e.jsxs(xe,{value:"info",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"발주번호"}),e.jsx("p",{className:"font-medium",children:a.orderNumber||"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"발주일"}),e.jsx("p",{className:"font-medium",children:a.orderDate?new Date(a.orderDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"프로젝트"}),e.jsx("p",{className:"font-medium",children:a.projectName||"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"거래처"}),e.jsx("p",{className:"font-medium",children:a.vendorName||"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"납기일"}),e.jsx("p",{className:"font-medium",children:a.deliveryDate?new Date(a.deliveryDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"총액"}),e.jsx("p",{className:"font-medium text-lg text-blue-600",children:a.totalAmount?`${Math.floor(a.totalAmount).toLocaleString()}원`:"-"})]})]}),a.items&&a.items.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"text-xs text-gray-600",children:"품목 목록"}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-2",children:"품목명"}),e.jsx("th",{className:"text-right p-2",children:"수량"}),e.jsx("th",{className:"text-right p-2",children:"단가"}),e.jsx("th",{className:"text-right p-2",children:"금액"})]})}),e.jsx("tbody",{children:a.items.map((s,t)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.itemName||s.name}),e.jsx("td",{className:"text-right p-2",children:Math.floor(s.quantity||0).toLocaleString()}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.unitPrice||0).toLocaleString(),"원"]}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.totalAmount||s.quantity*s.unitPrice||0).toLocaleString(),"원"]})]},t))})]})})]})]}),e.jsx(xe,{value:"email",className:"space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{children:"받는 사람"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>R("to"),children:e.jsx(le,{className:"w-4 h-4"})})]}),y.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{type:"email",value:s,onChange:o=>z("to",t,o.target.value),placeholder:"email@example.com"}),y.length>1&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>w("to",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{children:"참조 (CC)"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>R("cc"),children:e.jsx(le,{className:"w-4 h-4"})})]}),d.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{type:"email",value:s,onChange:o=>z("cc",t,o.target.value),placeholder:"cc@example.com"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>w("cc",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"제목"}),e.jsx(J,{value:O,onChange:s=>p(s.target.value),placeholder:"이메일 제목"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"메일 본문"}),e.jsx(ie,{value:P,onChange:s=>_(s.target.value),placeholder:"이메일 본문을 입력하세요",className:"min-h-[200px] font-mono text-sm",rows:10})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{children:"첨부파일"}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept=".pdf,.xlsx,.xls,.doc,.docx,.txt",s.onchange=t=>{const o=t.target;o.files&&o.files.length>0&&K(o.files)},s.click()},children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"파일 추가"]})]}),e.jsx("div",{className:"space-y-3",children:L.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"첨부할 파일이 없습니다"}):L.map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-gray-50",children:[e.jsx(ne,{checked:s.isSelected,onCheckedChange:()=>g(s.id)}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[q(s.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("span",{children:U(s.size)}),s.isDefault&&e.jsx(V,{variant:"secondary",className:"text-xs",children:"기본파일"})]})]})]}),x.includes(s.id)&&e.jsx(G,{className:"w-4 h-4 animate-spin text-blue-600"}),!s.isDefault&&!x.includes(s.id)&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>B(s.id),children:e.jsx(Re,{className:"w-4 h-4 text-red-600"})})]},s.id))}),L.length>0&&e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["선택된 파일: ",L.filter(s=>s.isSelected).length,"/",L.length,"개"]})})]})]})})]})})]})},ls=({orderData:a,pdfUrl:A,processingStatus:m,onSave:y,onSend:E,onDownload:d,onCreateOrder:b,onCreateOrderWithEmail:O})=>{const{isCollapsed:p}=Ve(),[k,M]=u.useState(!0),[L,I]=u.useState(!1),[x,j]=u.useState({to:[a.vendorEmail||""].filter(Boolean),cc:[],subject:`발주서 - ${a.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`,message:`안녕하세요,

첨부된 발주서를 확인해 주시기 바랍니다.

감사합니다.`,attachments:{includeExcel:!0,includePdf:!0,additionalFiles:[]}}),[P,_]=u.useState(""),[R,w]=u.useState("");u.useEffect(()=>{const r=a.vendorEmail||"",l=r?[r]:[];console.log("🔍 orderData 변경 감지:",{vendorEmail:r,newToEmails:l}),j(h=>({...h,to:l,subject:`발주서 - ${a.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`}))},[a.vendorEmail,a.orderNumber]);const z=()=>{P.trim()&&!x.to.includes(P.trim())&&(j(r=>({...r,to:[...r.to,P.trim()]})),_(""))},K=r=>{j(l=>({...l,to:l.to.filter(h=>h!==r)}))},g=()=>{R.trim()&&!x.cc.includes(R.trim())&&(j(r=>({...r,cc:[...r.cc,R.trim()]})),w(""))},B=r=>{j(l=>({...l,cc:l.cc.filter(h=>h!==r)}))},U=r=>{const l=Array.from(r.target.files||[]);j(h=>({...h,attachments:{...h.attachments,additionalFiles:[...h.attachments.additionalFiles,...l]}}))},q=r=>{j(l=>({...l,attachments:{...l.attachments,additionalFiles:l.attachments.additionalFiles.filter((h,v)=>v!==r)}}))},i=m.pdf==="completed"&&m.vendor==="completed"&&x.to.length>0,s=a.orderNumber&&a.vendorName&&a.projectName&&a.items?.length>0,t=Object.values(m).some(r=>r==="processing"),o=()=>{k&&O?I(!0):b()},c=()=>{I(!1),O&&O(x)};return e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-background border-t border-border shadow-lg z-30",children:[e.jsxs("div",{className:Y("container mx-auto px-6 py-4 transition-all duration-300",p?"xl:ml-16":"xl:ml-64"),children:[e.jsxs("div",{className:"flex flex-col gap-3 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-muted rounded-lg text-sm",children:[e.jsx(ne,{id:"send-email",checked:k,onCheckedChange:r=>M(!!r),className:"h-4 w-4"}),e.jsx("label",{htmlFor:"send-email",className:"font-medium cursor-pointer text-foreground whitespace-nowrap text-xs",children:"발주서 생성 후 이메일 자동 발송"}),t&&e.jsxs("div",{className:"flex items-center gap-1 ml-2 text-xs text-muted-foreground",children:[e.jsx(G,{className:"w-3 h-3 animate-spin"}),"처리 중"]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsxs(N,{variant:"outline",onClick:y,disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(Ze,{className:"w-3 h-3 mr-1"}),"임시저장"]}),e.jsxs(N,{variant:"outline",onClick:d,disabled:!A||m.pdf!=="completed",size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(ve,{className:"w-3 h-3 mr-1"}),"다운로드"]}),!k&&e.jsx(N,{onClick:E,disabled:!i||m.email==="processing",size:"sm",className:Y("text-xs px-3 py-2 h-8",i?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":""),children:m.email==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-3 h-3 mr-1 animate-spin"}),"발송중"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-3 h-3 mr-1"}),"이메일 발송"]})}),e.jsx(N,{variant:"default",onClick:o,disabled:!s||m.order==="processing",size:"sm",className:Y("text-xs px-4 py-2 h-8 font-medium",s?k?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":"bg-green-600 hover:bg-green-700 dark:bg-green-600 dark:hover:bg-green-700":""),children:m.order==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-3 h-3 mr-1 animate-spin"}),k?"생성 및 발송 중":"생성 중"]}):e.jsx(e.Fragment,{children:k?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),"발주서 생성 및 발송"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),"발주서 생성"]})})}),e.jsxs(N,{variant:"ghost",onClick:()=>window.location.href="/orders",disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8 text-muted-foreground hover:text-foreground",children:[e.jsx(es,{className:"w-3 h-3 mr-1"}),"발주서 관리"]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-6 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.pdf==="completed"?"bg-green-500":m.pdf==="processing"?"bg-blue-500 animate-pulse":m.pdf==="error"?"bg-red-500":"bg-muted-foreground")}),"PDF 생성"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.vendor==="completed"?"bg-green-500":m.vendor==="processing"?"bg-blue-500 animate-pulse":m.vendor==="error"?"bg-red-500":"bg-muted-foreground")}),"거래처 확인"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.order==="completed"?"bg-green-500":m.order==="processing"?"bg-blue-500 animate-pulse":m.order==="error"?"bg-red-500":"bg-muted-foreground")}),"발주서 생성"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.email==="completed"?"bg-green-500":m.email==="processing"?"bg-blue-500 animate-pulse":m.email==="error"?"bg-red-500":"bg-muted-foreground")}),"이메일 준비"]})]})]}),e.jsx(Te,{open:L,onOpenChange:I,children:e.jsxs(Ae,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Oe,{children:e.jsx(De,{children:"이메일 발송 설정"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(f,{className:"text-sm font-medium",children:"받는 사람 *"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[x.to.map((r,l)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>K(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},l)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{value:P,onChange:r=>_(r.target.value),placeholder:"example@company.com",onKeyPress:r=>r.key==="Enter"&&z(),className:"flex-1"}),e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:z,disabled:!P.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-sm font-medium",children:"참조 (CC)"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[x.cc.map((r,l)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>B(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},l)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{value:R,onChange:r=>w(r.target.value),placeholder:"manager@company.com (선택사항)",onKeyPress:r=>r.key==="Enter"&&g(),className:"flex-1"}),e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:g,disabled:!R.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"email-subject",className:"text-sm font-medium",children:"제목 *"}),e.jsx(J,{id:"email-subject",value:x.subject,onChange:r=>j(l=>({...l,subject:r.target.value})),className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"email-message",className:"text-sm font-medium",children:"메시지"}),e.jsx(ie,{id:"email-message",value:x.message,onChange:r=>j(l=>({...l,message:r.target.value})),rows:4,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-sm font-medium",children:"첨부파일"}),e.jsxs("div",{className:"mt-2 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:"include-excel",checked:x.attachments.includeExcel,onCheckedChange:r=>j(l=>({...l,attachments:{...l.attachments,includeExcel:!!r}}))}),e.jsx(f,{htmlFor:"include-excel",className:"text-sm",children:"Excel 파일 첨부"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:"include-pdf",checked:x.attachments.includePdf,onCheckedChange:r=>j(l=>({...l,attachments:{...l.attachments,includePdf:!!r}}))}),e.jsx(f,{htmlFor:"include-pdf",className:"text-sm",children:"PDF 파일 첨부"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(f,{className:"text-sm",children:"추가 파일"}),e.jsxs(N,{type:"button",variant:"outline",size:"sm",onClick:()=>document.getElementById("additional-files")?.click(),className:"h-8",children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),"파일 선택"]})]}),e.jsx("input",{id:"additional-files",type:"file",multiple:!0,onChange:U,className:"hidden"}),x.attachments.additionalFiles.length>0&&e.jsx("div",{className:"space-y-1",children:x.attachments.additionalFiles.map((r,l)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx(pe,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[(r.size/1024).toFixed(1)," KB"]}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>q(l),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},l))})]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground bg-blue-50 dark:bg-blue-950 p-2 rounded",children:"📎 선택한 첨부파일이 이메일과 함께 발송됩니다."})]}),e.jsxs(Le,{className:"mt-6",children:[e.jsx(N,{variant:"outline",onClick:()=>I(!1),children:"취소"}),e.jsxs(N,{onClick:c,disabled:x.to.length===0||!x.subject,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"발주서 생성"]})]}),e.jsxs("div",{className:"mt-2 p-2 bg-gray-100 text-xs text-gray-600 rounded",children:["🔍 Debug: to.length=",x.to.length,', subject="',x.subject,'", disabled=',x.to.length===0||!x.subject]})]})})]})},ns=({orderData:a,onSuggestionApply:A})=>{const[m,y]=u.useState([]),[E,d]=u.useState(new Set),[b,O]=u.useState(!1);u.useEffect(()=>{p()},[a]);const p=()=>{O(!0);const x=[];if(a.vendorName&&!a.vendorEmail&&x.push({id:"vendor-email",type:"autofill",title:"거래처 이메일 자동 완성",description:"등록된 거래처 정보에서 이메일을 가져올 수 있습니다.",action:{label:"이메일 자동 입력",data:{vendorEmail:"vendor@example.com"}},priority:"high"}),a.deliveryDate){const j=new Date(a.deliveryDate),P=new Date,_=Math.ceil((j.getTime()-P.getTime())/(1e3*60*60*24));_<3&&x.push({id:"delivery-urgent",type:"warning",title:"긴급 납기",description:`납기일이 ${_}일 남았습니다. 긴급 처리가 필요합니다.`,priority:"high"})}a.projectName&&!a.notes&&x.push({id:"project-defaults",type:"recommendation",title:"프로젝트 기본 설정",description:"이전 발주서를 참고하여 자주 사용하는 설정을 적용할 수 있습니다.",action:{label:"기본값 적용",data:{notes:"상차 후 연락 요망",deliveryLocation:"현장 직납"}},priority:"medium"}),a.totalAmount>1e7&&x.push({id:"amount-check",type:"info",title:"고액 발주서",description:"1천만원 이상의 발주서입니다. 결재 승인이 필요할 수 있습니다.",priority:"medium"}),a.vendorName&&a.vendorName.length>2&&["(주)ABC건설","(주)ABC종합건설"].length>0&&x.push({id:"similar-vendors",type:"recommendation",title:"유사 거래처 발견",description:`'${a.vendorName}'와 유사한 거래처가 있습니다. 확인해보세요.`,priority:"low"}),y(x.filter(j=>!E.has(j.id))),O(!1)},k=x=>{x.action&&(A(x.action.data),M(x.id))},M=x=>{d(j=>new Set(j).add(x)),y(j=>j.filter(P=>P.id!==x))},L=x=>{switch(x){case"warning":return e.jsx(ue,{className:"w-5 h-5 text-yellow-600"});case"info":return e.jsx(je,{className:"w-5 h-5 text-blue-600"});case"recommendation":return e.jsx(Me,{className:"w-5 h-5 text-green-600"});case"autofill":return e.jsx(fe,{className:"w-5 h-5 text-purple-600"});default:return e.jsx(je,{className:"w-5 h-5 text-gray-600"})}},I=x=>{switch(x){case"warning":return"bg-yellow-50 border-yellow-200";case"info":return"bg-blue-50 border-blue-200";case"recommendation":return"bg-green-50 border-green-200";case"autofill":return"bg-purple-50 border-purple-200";default:return"bg-gray-50 border-gray-200"}};return m.length===0&&!b?null:e.jsxs(ee,{children:[e.jsx(Pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Fe,{className:"text-lg flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 text-yellow-500"}),"스마트 어시스트"]}),b&&e.jsx(ze,{className:"w-4 h-4 text-gray-500 animate-spin"})]})}),e.jsxs(se,{className:"space-y-3",children:[m.sort((x,j)=>{const P={high:0,medium:1,low:2};return P[x.priority]-P[j.priority]}).map(x=>e.jsx(oe,{className:`${I(x.type)} border`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[L(x.type),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-medium text-sm",children:x.title}),x.priority==="high"&&e.jsx(V,{variant:"destructive",className:"text-xs",children:"중요"})]}),e.jsx(ce,{className:"text-xs",children:x.description}),x.action&&e.jsxs(N,{size:"sm",variant:"outline",className:"mt-2",onClick:()=>k(x),children:[x.action.label,e.jsx($e,{className:"w-3 h-3 ml-1"})]})]}),e.jsx(N,{size:"sm",variant:"ghost",className:"text-gray-400 hover:text-gray-600 h-6 w-6 p-0",onClick:()=>M(x.id),children:"×"})]})},x.id)),m.length===0&&!b&&e.jsxs("div",{className:"text-center py-4 text-sm text-gray-500",children:[e.jsx(te,{className:"w-8 h-8 text-green-500 mx-auto mb-2"}),"모든 항목이 올바르게 입력되었습니다"]})]})]})},Us=()=>{const{toast:a}=Ke(),{user:A,isAuthenticated:m}=Je(),[y,E]=u.useState(null),[d,b]=u.useState({}),[O,p]=u.useState({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),[k,M]=u.useState(null),[L,I]=u.useState(!1),[x,j]=u.useState(!1),P=u.useCallback(()=>{console.log("🔄 발주서 작성 페이지 초기화"),E(null),b({}),p({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),M(null),I(!1),j(!1),localStorage.removeItem("draftOrder")},[]);u.useEffect(()=>{if(x&&d.orderNumber){const s=setTimeout(()=>{_()},2e3);return()=>clearTimeout(s)}},[d,x]),u.useEffect(()=>{if(d.orderNumber&&d.vendorName&&d.projectName&&d.items?.length>0){const s=setTimeout(()=>{R()},500);return()=>clearTimeout(s)}},[d.orderNumber,d.vendorName,d.projectName,d.items]);const _=async()=>{I(!0);try{localStorage.setItem("draftOrder",JSON.stringify(d)),j(!1)}catch(s){console.error("Auto-save failed:",s)}finally{I(!1)}},R=async()=>{if(d.orderNumber){console.log("🔵 PDF 생성 시작:",d),p(s=>({...s,pdf:"processing"}));try{const s=d.totalAmount||(d.items||[]).reduce((c,r)=>c+(r.quantity||0)*(r.unitPrice||0),0),t={...d,totalAmount:s};console.log("🔵 PDF 생성 요청 데이터:",t);const o=await fetch("/api/orders/generate-pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderData:t})});if(o.ok){const c=await o.json();console.log("🔵 PDF 생성 응답:",c);const r=c.pdfUrl.startsWith("http")?c.pdfUrl:`${window.location.origin}${c.pdfUrl}`;console.log("🔵 PDF URL:",r),M(r),p(l=>({...l,pdf:"completed"})),fetch(r,{method:"HEAD"}).then(l=>{console.log("🔵 PDF 접근성 테스트:",l.status,l.headers.get("content-type"))}).catch(l=>{console.error("🔴 PDF 접근 실패:",l)})}else{const c=await o.text();throw console.error("🔴 PDF 생성 실패 응답:",o.status,c),new Error(`PDF 생성 실패: ${o.status}`)}}catch(s){p(t=>({...t,pdf:"error"})),console.error("🔴 PDF generation error:",s)}}},w=s=>{E(s);const t=localStorage.getItem("draftOrder");if(t)try{const o=JSON.parse(t);console.log("📋 임시저장 데이터 발견:",o),window.confirm("저장된 임시 작업이 있습니다. 불러오시겠습니까?")?(console.log("✅ 사용자 확인: 임시저장 데이터 로드 시작"),b(c=>(console.log("🔄 이전 orderData:",c),console.log("🔄 새로운 orderData:",o),{...o})),j(!1),a({title:"임시저장 불러오기 완료",description:`발주번호 ${o.orderNumber||"미정"}의 임시 작업을 불러왔습니다.`})):(console.log("❌ 사용자 취소: 임시저장 데이터 로드 취소"),localStorage.removeItem("draftOrder"))}catch(o){console.error("❌ 임시저장 데이터 파싱 오류:",o),localStorage.removeItem("draftOrder"),a({title:"임시저장 불러오기 실패",description:"저장된 데이터가 손상되어 삭제되었습니다.",variant:"destructive"})}else console.log("📋 임시저장 데이터 없음")},z=u.useCallback(s=>{b(t=>Object.keys(s).some(c=>JSON.stringify(s[c])!==JSON.stringify(t[c]))?{...t,...s}:t),j(!0),s.vendorName&&s.vendorName!==d.vendorName&&g(s.vendorName)},[d.vendorName]),K=s=>{b(t=>({...t,processedExcelUrl:s.url,originalFileName:s.name}))},g=async s=>{p(t=>({...t,vendor:"processing"}));try{const t=await fetch("/api/vendors/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({vendorName:s})});if(t.ok){const o=await t.json();o.isValid?(p(c=>({...c,vendor:"completed"})),o.vendorEmail&&b(c=>({...c,vendorEmail:o.vendorEmail}))):p(c=>({...c,vendor:"error"}))}}catch{p(o=>({...o,vendor:"error"}))}},B=async()=>{if(!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){a({title:"생성 불가",description:"필수 정보를 모두 입력해주세요.",variant:"destructive"});return}if(p(s=>({...s,order:"processing"})),!m||!A){console.error("🔴 인증 실패 - 로그인 필요"),a({title:"인증 필요",description:"로그인이 필요합니다. 로그인 페이지로 이동합니다.",variant:"destructive"}),p(s=>({...s,order:"error"})),setTimeout(()=>{window.location.href="/login"},2e3);return}console.log("🔐 현재 사용자:",A);try{console.log("🟢 발주서 생성 시작:",d);const s=new FormData;s.append("projectId","1"),s.append("vendorId","1"),s.append("orderDate",d.orderDate||new Date().toISOString()),s.append("deliveryDate",d.deliveryDate||new Date().toISOString()),s.append("notes",d.notes||`발주서 작성으로 생성된 발주서 - ${d.orderNumber}`);const t=(d.items||[]).map(c=>({itemName:c.name||c.itemName||"",specification:c.specification||"",unit:c.unit||"EA",quantity:parseFloat(c.quantity||"0"),unitPrice:parseFloat(c.unitPrice||"0"),totalAmount:parseFloat(c.quantity||"0")*parseFloat(c.unitPrice||"0"),majorCategory:c.majorCategory||"",middleCategory:c.middleCategory||"",minorCategory:c.minorCategory||"",notes:c.notes||""}));s.append("items",JSON.stringify(t)),console.log("🟢 발주서 생성 요청 데이터:",{projectId:"1",vendorId:"1",orderDate:d.orderDate||new Date().toISOString(),deliveryDate:d.deliveryDate||new Date().toISOString(),notes:d.notes||`발주서 작성으로 생성된 발주서 - ${d.orderNumber}`,items:t});const o=await fetch("/api/orders",{method:"POST",body:s});if(console.log("🟢 발주서 생성 응답 상태:",o.status),o.ok){const c=await o.json();console.log("🟢 생성된 발주서:",c),p(r=>({...r,order:"completed"})),a({title:"생성 완료",description:`발주서가 성공적으로 생성되었습니다. (${c.orderNumber||d.orderNumber}) 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.`,duration:5e3})}else{const c=await o.text();console.error("🔴 발주서 생성 실패 응답:",o.status,c);let r="발주서 생성 실패";try{r=JSON.parse(c).message||r}catch{r=`HTTP ${o.status}: ${c}`}throw new Error(r)}}catch(s){p(t=>({...t,order:"error"})),a({title:"생성 실패",description:s instanceof Error?s.message:"발주서 생성 중 오류가 발생했습니다.",variant:"destructive"})}},U=async s=>{if(console.log("📧 발주서 생성 및 이메일 발송 시작:",{orderData:d,emailSettings:s}),!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){a({title:"생성 불가",description:"필수 정보를 모두 입력해주세요.",variant:"destructive"});return}p(t=>({...t,order:"processing",email:"processing"}));try{console.log("🟢 Step 1: 발주서 생성");const t=new FormData;t.append("projectId","1"),t.append("vendorId","1"),t.append("orderDate",d.orderDate||new Date().toISOString()),t.append("deliveryDate",d.deliveryDate||new Date().toISOString()),t.append("notes",d.notes||`발주서 작성으로 생성된 발주서 - ${d.orderNumber}`);const o=(d.items||[]).map(l=>({itemName:l.name||l.itemName||"",specification:l.specification||"",unit:l.unit||"EA",quantity:parseFloat(l.quantity||"0"),unitPrice:parseFloat(l.unitPrice||"0"),totalAmount:parseFloat(l.quantity||"0")*parseFloat(l.unitPrice||"0"),majorCategory:l.majorCategory||"",middleCategory:l.middleCategory||"",minorCategory:l.minorCategory||"",notes:l.notes||""}));t.append("items",JSON.stringify(o));const c=await fetch("/api/orders",{method:"POST",body:t});if(!c.ok)throw new Error("발주서 생성 실패");const r=await c.json();if(console.log("🟢 발주서 생성 완료:",r),p(l=>({...l,order:"completed"})),console.log("📧 Step 2: 이메일 발송"),console.log("🔍 processedExcelUrl 확인:",d.processedExcelUrl),console.log("🔍 이메일 설정 확인:",s),d.processedExcelUrl)try{console.log("📤 Excel 이메일 요청 시작...");const l=await fetch("/api/orders/send-email-with-excel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emailSettings:{to:s.to,cc:s.cc||"",subject:s.subject,message:s.message,orderNumber:d.orderNumber,vendorName:d.vendorName,totalAmount:d.totalAmount},excelFilePath:d.processedExcelUrl,orderData:d})});if(l.ok)console.log("📧 이메일 발송 성공"),p(h=>({...h,email:"completed"})),a({title:"생성 및 발송 완료",description:`발주서가 생성되고 이메일이 발송되었습니다. (${r.orderNumber||d.orderNumber}) 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.`,duration:5e3});else{const h=await l.text();throw console.error("📧 Excel 이메일 발송 HTTP 오류:",l.status,h),new Error(`Excel 이메일 발송 실패 (${l.status}): ${h}`)}}catch(l){console.error("📧 Excel 이메일 발송 실패 상세:",{error:l,message:l instanceof Error?l.message:"Unknown error",stack:l instanceof Error?l.stack:"No stack"}),p(h=>({...h,email:"error"})),a({title:"부분 완료",description:"발주서는 생성되었으나 이메일 발송에 실패했습니다.",variant:"destructive"})}else try{console.log("📤 PDF 이메일 요청 시작...");const l=await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderData:{...d,vendorEmail:s.to},pdfUrl:k,recipients:s.to,emailSettings:{subject:s.subject,message:s.message,cc:s.cc}})});if(l.ok)console.log("📧 PDF 이메일 발송 성공"),p(h=>({...h,email:"completed"})),a({title:"생성 및 발송 완료",description:"발주서가 생성되고 PDF 이메일이 발송되었습니다. 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.",duration:5e3});else{const h=await l.text();throw console.error("📧 PDF 이메일 발송 HTTP 오류:",l.status,h),new Error(`PDF 이메일 발송 실패 (${l.status}): ${h}`)}}catch(l){console.error("📧 PDF 이메일 발송 실패 상세:",{error:l,message:l instanceof Error?l.message:"Unknown error",stack:l instanceof Error?l.stack:"No stack"}),p(h=>({...h,email:"error"})),a({title:"부분 완료",description:"발주서는 생성되었으나 이메일 발송에 실패했습니다.",variant:"destructive"})}}catch(t){console.error("🔴 발주서 생성 및 이메일 발송 실패:",t),p(o=>({...o,order:"error",email:"error"})),a({title:"실패",description:t instanceof Error?t.message:"발주서 생성 및 이메일 발송 중 오류가 발생했습니다.",variant:"destructive"})}},q=async()=>{if(!d.vendorEmail){a({title:"발송 불가",description:"수신자 이메일을 입력해주세요.",variant:"destructive"});return}p(s=>({...s,email:"processing"}));try{if((await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderData:d,pdfUrl:k||null,recipients:[d.vendorEmail]})})).ok)p(t=>({...t,email:"completed"})),a({title:"발송 완료",description:"발주서가 성공적으로 발송되었습니다. 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.",duration:5e3});else throw new Error("이메일 발송 실패")}catch{p(t=>({...t,email:"error"})),a({title:"발송 실패",description:"이메일 발송 중 오류가 발생했습니다.",variant:"destructive"})}},i=()=>{const s=Object.values(O);return s.filter(o=>o==="completed").length/s.length*100};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"bg-background border-b border-border sticky top-0 z-40",children:e.jsx("div",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"발주서 작성"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"한 화면에서 모든 작업을 완료하세요"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[y&&e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>{window.confirm("현재 작업 중인 내용이 모두 삭제됩니다. 새로 작성하시겠습니까?")&&(P(),a({title:"새로 작성",description:"발주서 작성 화면이 초기화되었습니다."}))},className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"새로 작성"]}),L&&e.jsxs(V,{variant:"secondary",className:"animate-pulse",children:[e.jsx(G,{className:"w-3 h-3 mr-1 animate-spin"}),"자동 저장 중..."]}),!L&&!x&&d.orderNumber&&e.jsxs(V,{variant:"secondary",className:"bg-green-50 text-green-700",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),"저장됨"]}),e.jsx(He,{value:i(),className:"w-32 h-2"})]})]})})}),e.jsxs("div",{className:"container mx-auto px-6 py-6",style:{paddingBottom:"120px"},children:[!y&&e.jsx("div",{className:"mb-8",children:e.jsxs(oe,{className:"mb-6 max-w-4xl mx-auto",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(ce,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-medium",children:"📋 사용팁"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-blue-600 dark:text-blue-400",children:"엑셀 파일 업로드:"})," 대량 발주서, 반복 업무, 자동화 처리에 적합 (50건+ 권장)"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-green-600 dark:text-green-400",children:"직접 입력:"})," 소량 발주서, 세밀한 조정, 즉시 처리에 적합 (10건 이하 권장)"]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs(N,{variant:"outline",size:"sm",className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",onClick:async()=>{try{const s=await fetch("/PO_Excel_Template.xlsx");if(s.ok){const t=await s.blob(),o=URL.createObjectURL(t),c=document.createElement("a");c.href=o,c.download="PO_Excel_Template.xlsx",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(o)}else throw new Error("파일을 찾을 수 없습니다")}catch(s){console.error("엑셀 템플릿 다운로드 실패:",s),a({title:"다운로드 실패",description:"엑셀 템플릿 다운로드에 실패했습니다.",variant:"destructive"})}},children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"엑셀 템플릿 다운로드"]})})]})})]})}),!y&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto",children:[e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-500 dark:hover:border-blue-400",onClick:()=>w("excel"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(Ne,{className:"w-16 h-16 mx-auto mb-4 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"엑셀 파일 업로드"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"기존 엑셀 파일을 업로드하여 빠르게 작성"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"✅ 대량 처리 (50건+)"}),e.jsx("div",{children:"✅ 자동화 워크플로우"}),e.jsx("div",{children:"✅ 거래처 자동 매칭"}),e.jsx("div",{children:"✅ 이메일 자동 발송"})]})]})}),e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-green-500 dark:hover:border-green-400 bg-card",onClick:()=>w("direct"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(re,{className:"w-16 h-16 mx-auto mb-4 text-green-600 dark:text-green-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"직접 입력"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"폼을 통해 직접 정보 입력"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"✅ 소량 처리 (10건 이하)"}),e.jsx("div",{children:"✅ 즉시 처리"}),e.jsx("div",{children:"✅ 실시간 검증"}),e.jsx("div",{children:"✅ 세밀한 조정"})]})]})})]}),y&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{children:e.jsxs(se,{className:"p-6",children:[y==="excel"&&e.jsx(ts,{onDataExtracted:z,onProcessedFileReady:K}),y==="direct"&&e.jsx(rs,{initialData:d,onChange:z})]})}),e.jsx(ns,{orderData:d,onSuggestionApply:z})]}),e.jsx("div",{className:"space-y-6",children:e.jsx(as,{orderData:d,pdfUrl:k,processingStatus:O})})]}),y&&d.orderNumber&&e.jsx(ls,{orderData:d,pdfUrl:k,processingStatus:O,onSave:_,onSend:q,onCreateOrder:B,onCreateOrderWithEmail:U,onDownload:()=>{k&&window.open(`${k}?download=true`,"_blank")}})]})]})};export{Us as default};
