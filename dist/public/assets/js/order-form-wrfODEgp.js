import{at as c,a as Se,r as x,k as S,am as Pe,au as Fe,p as be,l as te,v as ue,j as e,o as M,z as V,A,q as L,L as F,I as N,m as P,F as _e,P as Me,f as Ne,af as Ve}from"./index-BmMnSXV0.js";import{T as ke}from"./textarea-Drbw1bxw.js";import{S as $,a as B,b as Q,c as W,d as O}from"./select-MnpL2n0I.js";import{T as Ae,a as Le,b as ve,c as k,d as Re,e as f}from"./table-CRNOcc3S.js";import{i as Ie}from"./authUtils-CcDzk6i0.js";import{D as Ke}from"./download-t2riQs1n.js";import{U as qe}from"./upload-R-RTwloC.js";import{T as Te}from"./trash-2-CxJFTiy5.js";import"./index-DAT-yBtZ.js";import"./chevron-up-ZhZAJcOI.js";const He=c.object({templateId:c.number().optional(),projectId:c.number().min(1,"프로젝트를 선택하세요"),vendorId:c.number().min(1,"거래처를 선택하세요"),orderDate:c.string().min(1,"발주일자를 선택하세요"),deliveryDate:c.string().optional(),notes:c.string().optional()});function Ue({orderId:v,onSuccess:ae,onCancel:de,preselectedTemplateId:xe,onTemplateChange:I}){const{toast:h}=Se(),G=x.useRef(null),p=x.useRef(null);x.useState([]);const[Y,J]=x.useState([]),[X,se]=x.useState(!1),[y,ne]=x.useState(null),[C,Ce]=x.useState(null),{data:re}=S({queryKey:["/api/projects"]}),{data:oe}=S({queryKey:["/api/vendors"]}),{data:g}=S({queryKey:["/api/templates"]}),{data:R,isLoading:b}=S({queryKey:["/api/orders",v],enabled:!!v}),{register:q,handleSubmit:K,setValue:Z,watch:w,reset:we,formState:{errors:u}}=Pe({resolver:Fe(He),defaultValues:{vendorId:0,orderDate:new Date().toISOString().split("T")[0]}});x.useEffect(()=>{(async()=>{if(window.Handsontable){se(!0);return}try{const i=document.createElement("link");i.rel="stylesheet",i.href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css",document.head.appendChild(i);const l=document.createElement("script");l.src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js",l.onload=()=>{se(!0)},document.head.appendChild(l)}catch(i){console.error("Failed to load Handsontable:",i),h({title:"오류",description:"테이블 라이브러리 로드에 실패했습니다.",variant:"destructive"})}})()},[]);const ge=()=>{const r=p.current;if(!r)return;let i=0;for(let l=0;l<10;l++){const o=r.getDataAtCell(l,6)||0;typeof o=="number"&&(i+=o)}r.setDataAtCell(10,6,i,"total_calculation")};x.useEffect(()=>{if(!X||!G.current||p.current)return;const i={data:Array.from({length:11},(l,o)=>o===10?["총합","","","","","",0,""]:[o+1,"","","",0,0,0,""]),colHeaders:["NO","품명","규격","단위","수량","단가","금액","비고"],columns:[{data:0,type:"text",readOnly:!0,className:"htCenter",width:60},{data:1,type:"text",className:"htMiddle",width:150},{data:2,type:"text",className:"htMiddle",width:120},{data:3,type:"text",className:"htCenter htMiddle",width:60},{data:4,type:"numeric",numericFormat:{pattern:"0,0"},className:"htCenter htMiddle",width:80},{data:5,type:"numeric",numericFormat:{pattern:"₩0,0"},className:"htRight htMiddle",width:100},{data:6,type:"numeric",numericFormat:{pattern:"₩0,0"},readOnly:!0,className:"htRight htMiddle",width:120},{data:7,type:"text",className:"htMiddle",width:100}],rowHeaders:!0,width:"100%",height:450,licenseKey:"non-commercial-and-evaluation",stretchH:"none",autoWrapRow:!1,autoWrapCol:!1,copyPaste:!0,fillHandle:!0,contextMenu:["row_above","row_below","remove_row","copy","cut","paste"],manualRowResize:!0,manualColumnResize:!0,rowHeights:28,cells:(l,o)=>{const d={};if(d.className="htMiddle",l===10)return d.readOnly=!0,o===0?d.className="htCenter htMiddle total-row":o===6?d.className="htRight htMiddle total-row":d.className="htCenter htMiddle total-row",d;switch(o){case 0:d.className="htCenter htMiddle",d.readOnly=!0;break;case 1:d.className="htLeft htMiddle";break;case 2:d.className="htLeft htMiddle";break;case 3:d.className="htCenter htMiddle";break;case 4:d.className="htCenter htMiddle";break;case 5:d.className="htRight htMiddle";break;case 6:d.className="htRight htMiddle",d.readOnly=!0;break;case 7:d.className="htLeft htMiddle";break;default:d.className="htMiddle"}return d},afterChange:(l,o)=>{if(o==="loadData"||o==="calculation"||o==="total_calculation")return;const d=p.current;d&&(l?.forEach(([z,H,E,U])=>{if(z!==10){if(H===4||H===5){const le=d.getDataAtCell(z,4)||0,he=d.getDataAtCell(z,5)||0,fe=le*he;d.setDataAtCell(z,6,fe,"calculation")}H===1&&U&&U.trim()&&d.setDataAtCell(z,0,z+1,"auto")}}),setTimeout(()=>{ge()},50))},beforeChange:(l,o)=>{l?.forEach(d=>{const[z,H,E,U]=d;(H===4||H===5)&&U&&isNaN(Number(U))&&(d[3]=E,h({title:"입력 오류",description:"숫자만 입력 가능합니다.",variant:"destructive"}))})}};return p.current=new window.Handsontable(G.current,i),()=>{p.current&&(p.current.destroy(),p.current=null)}},[X]);const ee=()=>p.current?p.current.getData().slice(0,10).filter(i=>i[1]&&i[1].trim()).map((i,l)=>({id:`item-${l}`,itemName:i[1]||"",specification:i[2]||"",unit:i[3]||"",quantity:Number(i[4])||0,unitPrice:Number(i[5])||0,totalAmount:Number(i[6])||0,notes:i[7]||""})):[],ce=()=>ee().reduce((i,l)=>i+l.totalAmount,0),ie=()=>{p.current&&(p.current.countRows(),p.current.alter("insert_row_below",9),p.current.setDataAtCell(10,0,11),p.current.setDataAtCell(11,0,"총합"))},je=()=>{p.current&&(p.current.getData(),h({title:"기능 준비중",description:"엑셀 내보내기 기능을 준비중입니다."}))},ye=r=>{const i=ee(),l=ce();if(i.length===0){h({title:"오류",description:"최소 하나의 품목을 입력해주세요.",variant:"destructive"});return}me(r,i,l)},j=be({mutationFn:async r=>await te("POST","/api/orders",r),onSuccess:async r=>{const i=r.id;if(Y.length>0){const l=new FormData;Y.forEach(o=>{l.append("files",o)}),await te("POST",`/api/orders/${i}/attachments`,l)}ue.invalidateQueries({queryKey:["/api/orders"]}),h({title:"성공",description:"발주서가 생성되었습니다."}),ae?.()},onError:r=>{if(Ie(r)){h({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{window.location.href="/api/login"},500);return}h({title:"오류",description:"발주서 생성에 실패했습니다.",variant:"destructive"})}}),me=(r,i,l)=>{const o=Number(r.vendorId);if(!o||o===0){h({title:"오류",description:"거래처를 선택해주세요.",variant:"destructive"});return}const d={...r,vendorId:o,projectId:r.projectId?Number(r.projectId):void 0,templateId:4,orderDate:r.orderDate,deliveryDate:r.deliveryDate||void 0,items:i,totalAmount:l};j.mutate(d)},D=r=>{ye(r)},pe=r=>{const i=Array.from(r.target.files||[]);J(l=>[...l,...i])};return b&&v?e.jsx("div",{className:"p-6",children:"Loading..."}):X?e.jsxs("div",{className:"compact-form space-y-6",children:[e.jsx("style",{children:`
        .total-row {
          background-color: #f3f4f6 !important;
          font-weight: bold !important;
        }
        
        /* Handsontable row alignment fixes */
        .handsontable {
          font-size: 13px !important;
        }
        
        .handsontable td, .handsontable th {
          vertical-align: middle !important;
          height: 28px !important;
          line-height: 28px !important;
          border: 1px solid #ccc !important;
        }
        
        .handsontable thead th {
          height: 30px !important;
          line-height: 30px !important;
          background-color: #f8f9fa !important;
          border: 1px solid #ccc !important;
          text-align: center !important;
          font-weight: 600 !important;
          font-size: 13px !important;
        }
        
        .handsontable tbody tr {
          height: 28px !important;
        }
        
        .handsontable tbody tr td {
          height: 28px !important;
          line-height: 26px !important;
          padding: 1px 4px !important;
          vertical-align: middle !important;
          border: 1px solid #ccc !important;
          font-size: 13px !important;
        }
        
        .handsontable .htMiddle {
          vertical-align: middle !important;
        }
        
        .handsontable .htLeft {
          text-align: left !important;
          vertical-align: middle !important;
          padding-left: 6px !important;
        }
        
        .handsontable .htCenter {
          text-align: center !important;
          vertical-align: middle !important;
        }
        
        .handsontable .htRight {
          text-align: right !important;
          vertical-align: middle !important;
          padding-right: 6px !important;
        }
        
        .handsontable .total-row td {
          background-color: #f3f4f6 !important;
          font-weight: bold !important;
          height: 28px !important;
          line-height: 26px !important;
        }
        
        /* Row header styling */
        .handsontable .ht_clone_left thead th {
          height: 30px !important;
          line-height: 30px !important;
        }
        
        .handsontable .ht_clone_left tbody th {
          height: 28px !important;
          line-height: 26px !important;
          text-align: center !important;
          font-size: 12px !important;
        }
        
        /* Fix column widths */
        .handsontable col:nth-child(1) { width: 60px !important; }
        .handsontable col:nth-child(2) { width: 150px !important; }
        .handsontable col:nth-child(3) { width: 120px !important; }
        .handsontable col:nth-child(4) { width: 60px !important; }
        .handsontable col:nth-child(5) { width: 80px !important; }
        .handsontable col:nth-child(6) { width: 100px !important; }
        .handsontable col:nth-child(7) { width: 120px !important; }
        .handsontable col:nth-child(8) { width: 100px !important; }
      `}),e.jsxs("form",{onSubmit:K(D),className:"space-y-6",children:[e.jsxs(M,{children:[e.jsx(V,{children:e.jsx(A,{children:"기본 정보"})}),e.jsxs(L,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"templateId",children:"발주서 템플릿 *"}),e.jsxs($,{onValueChange:r=>{const i=parseInt(r);Z("templateId",i),console.log("ExcelLikeOrderForm: Template changed to:",i),I&&I(i)},value:xe?.toString()||"",children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"템플릿을 선택하세요"})}),e.jsx(W,{className:"z-[9999]",style:{position:"fixed",zIndex:9999},children:g?.map(r=>e.jsx(O,{value:r.id.toString(),children:r.templateName},r.id))})]}),u.templateId&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:u.templateId.message})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"projectId",children:"프로젝트 *"}),e.jsxs($,{onValueChange:r=>{const i=parseInt(r);Z("projectId",i);const l=re?.find(o=>o.id===i);l&&ne(l)},children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"현장을 선택하세요"})}),e.jsx(W,{className:"z-[9999]",style:{position:"fixed",zIndex:9999},children:re?.map(r=>e.jsxs(O,{value:r.id.toString(),children:[r.projectName," (",r.projectCode,")"]},r.id))})]}),u.projectId&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:u.projectId.message})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"vendorId",children:"거래처 *"}),e.jsxs($,{onValueChange:r=>{const i=parseInt(r);Z("vendorId",i);const l=oe?.find(o=>o.id===i);l&&Ce(l)},children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"거래처를 선택하세요"})}),e.jsx(W,{className:"z-[9999]",style:{position:"fixed",zIndex:9999},children:oe?.map(r=>e.jsx(O,{value:r.id.toString(),children:r.name},r.id))})]}),u.vendorId&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:u.vendorId.message})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"orderDate",children:"발주서 작성일 *"}),e.jsx(N,{...q("orderDate"),type:"date",id:"orderDate"}),u.orderDate&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:u.orderDate.message})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"deliveryDate",children:"납품 희망일"}),e.jsx(N,{...q("deliveryDate"),type:"date",id:"deliveryDate"})]})]}),(y||C)&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[y&&e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"프로젝트 정보"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"프로젝트명:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:y.projectName})]}),y.location&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"주소:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:y.location})]}),y.projectManager&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"현장 관리자:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:y.projectManager})]}),y.managerPhone&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"전화번호:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:y.managerPhone})]}),y.managerEmail&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"이메일:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:y.managerEmail})]})]})]}),C&&e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-2",children:"거래처 정보"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"거래처명:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:C.name})]}),C.contactPerson&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"담당자:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:C.contactPerson})]}),C.phone&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"연락처:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:C.phone})]}),C.email&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"이메일:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:C.email})]}),C.address&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"주소:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:C.address})]})]})]})]})})]})]}),e.jsxs(M,{children:[e.jsx(V,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{children:"발주 품목"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(P,{type:"button",onClick:ie,size:"sm",children:"행 추가"}),e.jsxs(P,{type:"button",onClick:je,size:"sm",variant:"outline",children:[e.jsx(Ke,{className:"h-4 w-4 mr-2"}),"엑셀 내보내기"]})]})]})}),e.jsx(L,{children:e.jsx("div",{ref:G,className:"w-full"})})]}),e.jsxs(M,{children:[e.jsx(V,{children:e.jsx(A,{children:"파일 첨부"})}),e.jsxs(L,{children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx(qe,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs(F,{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx("span",{className:"mt-2 block text-sm font-medium text-gray-900",children:"파일을 드래그하거나 클릭하여 업로드"}),e.jsx("span",{className:"mt-1 block text-xs text-gray-500",children:"PDF, DWG, 이미지 파일 (최대 10MB)"})]}),e.jsx(N,{id:"file-upload",type:"file",multiple:!0,className:"hidden",onChange:pe,accept:".pdf,.dwg,.jpg,.jpeg,.png,.gif"})]})]}),Y.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:Y.map((r,i)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(_e,{className:"h-4 w-4 mr-2 text-gray-500"}),e.jsx("span",{className:"text-sm",children:r.name})]}),e.jsx(P,{type:"button",variant:"ghost",size:"sm",onClick:()=>J(l=>l.filter((o,d)=>d!==i)),children:"삭제"})]},i))})]})]}),e.jsxs(M,{children:[e.jsx(V,{children:e.jsx(A,{children:"특이사항"})}),e.jsx(L,{children:e.jsx(ke,{...q("notes"),placeholder:"발주 관련 특이사항이나 요청사항을 입력하세요",rows:4})})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-6 border-t",children:[e.jsx(P,{type:"button",variant:"outline",onClick:de,children:"취소"}),e.jsx(P,{type:"submit",disabled:j.isPending,children:j.isPending?"저장 중...":"PDF 미리보기 및 발주서 제출"})]})]})]}):e.jsx("div",{className:"p-6",children:"테이블 라이브러리를 로딩중입니다..."})}const $e=c.object({itemId:c.number().min(1,"품목을 선택하세요"),itemName:c.string().min(1,"품목명을 입력하세요"),specification:c.string().optional(),majorCategory:c.string().optional(),middleCategory:c.string().optional(),minorCategory:c.string().optional(),quantity:c.number().positive("수량은 0보다 커야 합니다"),unitPrice:c.number().positive("단가는 0보다 커야 합니다"),notes:c.string().optional()}),Be=c.object({templateId:c.number().optional(),projectId:c.number().min(1,"현장을 선택하세요"),vendorId:c.number().min(1,"거래처를 선택하세요"),orderDate:c.string().min(1,"발주일자를 선택하세요"),deliveryDate:c.string().optional(),notes:c.string().optional(),items:c.array($e).min(1,"최소 하나의 품목을 추가하세요"),customFields:c.record(c.any()).optional()});function st({orderId:v,onSuccess:ae,onCancel:de,preselectedTemplateId:xe}){const{toast:I}=Se(),[h,G]=x.useState(xe||null),[p,Y]=x.useState([]),[J,X]=x.useState(!0),[se,y]=x.useState(null);x.useEffect(()=>{(async()=>{try{X(!0),console.log("Loading templates...");const a=await fetch("/api/templates",{method:"GET",headers:{Accept:"application/json"},credentials:"include"});if(console.log("Template response status:",a.status),!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=await a.json();console.log("Templates loaded:",s),Y(s),y(null)}catch(a){console.error("Error loading templates:",a),y(a)}finally{X(!1)}})()},[]),S({queryKey:["/api/templates",h],enabled:!!h,retry:1});const{data:ne,isLoading:C,error:Ce}=S({queryKey:["/api/items"],select:t=>t.items||[],retry:1});S({queryKey:["/api/item-categories/major"],retry:1}),S({queryKey:["/api/item-categories"],retry:1});const{data:re,isLoading:oe}=S({queryKey:["/api/projects"],retry:1});console.log("Items data:",ne),console.log("Templates data:",p),console.log("Templates loading:",J),console.log("Templates error:",se),console.log("API endpoint test for templates");const[g,R]=x.useState([{itemId:0,itemName:"",specification:"",majorCategory:"",middleCategory:"",minorCategory:"",quantity:0,unitPrice:0,notes:""}]),[b,q]=x.useState([""]),[K,Z]=x.useState([]),[w,we]=x.useState(null),[u,ge]=x.useState(null),ee=t=>t===0||isNaN(t)?"":Ne(t),ce=t=>{const a=t.replace(/[₩,\s]/g,""),s=parseFloat(a);return isNaN(s)?0:s},{register:ie,handleSubmit:je,watch:ye,setValue:j,reset:me,formState:{errors:D}}=Pe({resolver:Fe(Be),defaultValues:{templateId:void 0,projectId:0,vendorId:0,orderDate:new Date().toISOString().split("T")[0],deliveryDate:"",notes:"",items:g,customFields:{}}}),{data:pe}=S({queryKey:["/api/vendors"]});S({queryKey:["/api/projects"]});const{data:r,isLoading:i}=S({queryKey:["/api/orders",v],enabled:!!v}),l=be({mutationFn:async t=>await te("POST","/api/orders",t),onSuccess:async t=>{const a=t?.id;if(K.length>0&&a)try{const s=new FormData;K.forEach(n=>{s.append("files",n)}),await te("POST",`/api/orders/${a}/attachments`,s)}catch(s){console.error("Error uploading files:",s)}ue.invalidateQueries({queryKey:["/api/orders"]}),I({title:"성공",description:"발주서가 생성되었습니다."}),ae?.()},onError:t=>{if(Ie(t)){I({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{window.location.href="/api/login"},500);return}I({title:"오류",description:"발주서 생성에 실패했습니다.",variant:"destructive"})}}),o=be({mutationFn:async t=>{const{items:a,...s}=t;if(await te("PUT",`/api/orders/${v}`,{...s,items:a.map(n=>({...n,totalAmount:(n.quantity||0)*(n.unitPrice||0)}))}),K.length>0){const n=new FormData;K.forEach(m=>{n.append("files",m)}),await te("POST",`/api/orders/${v}/attachments`,n)}},onSuccess:()=>{ue.invalidateQueries({queryKey:["/api/orders"]}),ue.invalidateQueries({queryKey:["/api/orders",v]}),I({title:"성공",description:"발주서가 수정되었습니다."}),ae?.()},onError:t=>{if(Ie(t)){I({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{window.location.href="/api/login"},500);return}I({title:"오류",description:"발주서 수정에 실패했습니다.",variant:"destructive"})}});x.useEffect(()=>{if(r&&!i&&typeof r=="object"){const t=r,a=(t.items||[]).map(s=>({itemId:s.itemId||0,itemName:s.itemName,specification:s.specification||"",majorCategory:s.majorCategory||"",middleCategory:s.middleCategory||"",minorCategory:s.minorCategory||"",quantity:s.quantity,unitPrice:s.unitPrice,notes:s.notes||""}));me({vendorId:t.vendorId,orderDate:new Date(t.orderDate).toISOString().split("T")[0],deliveryDate:t.deliveryDate?new Date(t.deliveryDate).toISOString().split("T")[0]:"",notes:t.notes||"",items:a}),R(a)}},[r,i,me]);const d=()=>{const t=g.length>0?g[g.length-1]:null,a=b.length>0?b[b.length-1]:"",s=t?{itemId:t.itemId,itemName:t.itemName,specification:t.specification,majorCategory:t.majorCategory,middleCategory:t.middleCategory,minorCategory:t.minorCategory,quantity:t.quantity,unitPrice:t.unitPrice,notes:t.notes}:{itemId:0,itemName:"",specification:"",majorCategory:"",middleCategory:"",minorCategory:"",quantity:0,unitPrice:0,notes:""},n=[...g,s];R(n),j("items",n),q([...b,a])},z=t=>{const a=g[t],s=b[t]||"",n={itemId:a.itemId,itemName:a.itemName,specification:a.specification,majorCategory:a.majorCategory,middleCategory:a.middleCategory,minorCategory:a.minorCategory,quantity:a.quantity,unitPrice:a.unitPrice,notes:a.notes},m=[...g,n];R(m),j("items",m),q([...b,s])},H=t=>{if(g.length===1)return;const a=g.filter((n,m)=>m!==t),s=b.filter((n,m)=>m!==t);R(a),j("items",a),q(s)},E=(t,a,s)=>{const n=[...g];n[t]={...n[t],[a]:s},R(n),j("items",n)},U=(t,a)=>{const s=ne?.find(n=>n.id===a);if(s){const n=[...g],m=parseFloat(s.standardPrice)||0;n[t]={...n[t],itemId:s.id,itemName:s.name,specification:s.specification||"",majorCategory:s.majorCategory||"",middleCategory:s.middleCategory||"",minorCategory:s.minorCategory||"",unitPrice:m},R(n),j("items",n);const T=[...b];T[t]=ee(m),q(T)}},le=t=>(t.quantity||0)*(t.unitPrice||0),he=()=>g.reduce((t,a)=>t+le(a),0),fe=t=>{const s=Array.from(t.target.files||[]).filter(n=>["application/pdf","image/jpeg","image/png","image/gif","application/dwg","application/x-dwg"].includes(n.type)?n.size>10485760?(I({title:"파일 크기 오류",description:`${n.name}은(는) 파일 크기가 10MB를 초과합니다.`,variant:"destructive"}),!1):!0:(I({title:"파일 형식 오류",description:`${n.name}은(는) 지원하지 않는 파일 형식입니다.`,variant:"destructive"}),!1));Z(n=>[...n,...s])},Ee=t=>{Z(a=>a.filter((s,n)=>n!==t))},Oe=()=>{if(!_?.fieldsConfig)return null;try{const t=typeof _.fieldsConfig=="string"?JSON.parse(_.fieldsConfig):_.fieldsConfig,a=[];if(_.templateType==="material_extrusion")t.basic_fields&&a.push({key:"basic_fields",name:"기본 정보",fields:t.basic_fields}),t.extrusion_list&&a.push({key:"extrusion_list",name:"압출 목록",fields:t.extrusion_list}),t.schedule_fields&&a.push({key:"schedule_fields",name:"일정 정보",fields:t.schedule_fields}),t.specification_fields&&a.push({key:"specification_fields",name:"사양 정보",fields:t.specification_fields});else if(_.templateType==="panel_manufacturing")t.basic_fields&&a.push({key:"basic_fields",name:"기본 정보",fields:t.basic_fields}),t.color_breakdown&&a.push({key:"color_breakdown",name:"색상 분류",fields:t.color_breakdown}),t.material_fields&&a.push({key:"material_fields",name:"재료 정보",fields:t.material_fields}),t.panel_breakdown&&a.push({key:"panel_breakdown",name:"판넬 분류",fields:t.panel_breakdown}),t.delivery_schedule&&a.push({key:"delivery_schedule",name:"배송 일정",fields:t.delivery_schedule}),t.insulation_details&&a.push({key:"insulation_details",name:"단열재 상세",fields:t.insulation_details});else if(t.fields&&Array.isArray(t.fields)){const s=t.fields.reduce((n,m)=>{const T=m.sectionName||"기본 정보";return n[T]||(n[T]=[]),n[T].push(m),n},{});Object.entries(s).forEach(([n,m])=>{a.push({key:n,name:n,fields:m})})}return a.length===0?null:a.map(s=>e.jsxs(M,{className:"mb-4",children:[e.jsx(V,{className:"pb-2",children:e.jsx(A,{className:"text-lg",children:s.name})}),e.jsx(L,{className:"pt-2",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:Array.isArray(s.fields)?s.fields.map(n=>De(n)):Object.entries(s.fields).map(([n,m])=>De({fieldName:n,label:m,fieldType:n.includes("date")?"date":n.includes("amount")||n.includes("price")||n.includes("quantity")||n.includes("count")||n.includes("weight")||n.includes("kg")||n.includes("area")||n==="quantity"?"number":"text"}))})})]},s.key))}catch(t){return console.error("Error rendering dynamic template fields:",t),null}},De=t=>{const a=t.fieldName||t.id,s=t.label,n=t.fieldType||"text";return e.jsxs("div",{children:[e.jsx(F,{htmlFor:a,children:s}),e.jsx(N,{id:a,type:n,placeholder:`${s}을 입력하세요`,onChange:m=>{const T=ye("customFields")||{};j("customFields",{...T,[a]:m.target.value})}})]},a)},ze=t=>{const a=Number(t.vendorId);if(!a||a===0){I({title:"오류",description:"거래처를 선택해주세요.",variant:"destructive"});return}const s={...t,vendorId:a,projectId:t.projectId?Number(t.projectId):void 0,templateId:h?Number(h):void 0,orderDate:t.orderDate,deliveryDate:t.deliveryDate||void 0,items:g.map(n=>({...n,itemId:Number(n.itemId),quantity:Number(n.quantity),unitPrice:Number(n.unitPrice),totalAmount:le(n)})),totalAmount:he()};v?o.mutate(s):l.mutate(s)};if(i&&v)return e.jsx("div",{className:"p-6",children:"Loading..."});const _=p.find(t=>t.id===h);return console.log("=== RENDER CHECK ==="),console.log("Current selectedTemplateId:",h),console.log("Selected template:",_),console.log("Template type:",_?.templateType),console.log("Templates available:",p.map(t=>({id:t.id,name:t.templateName,type:t.templateType}))),_?.templateType==="excel_like"||_?.templateType==="handsontable"?(console.log("Rendering ExcelLikeOrderForm for template:",h),e.jsx(Ue,{orderId:v,onSuccess:ae,onCancel:de,preselectedTemplateId:h,onTemplateChange:t=>{console.log("OrderForm: Received template change from ExcelLikeOrderForm:",t),G(t),j("templateId",t)}},`excel-${h}-${Date.now()}`)):e.jsx("div",{className:"compact-form space-y-3",children:e.jsxs("form",{onSubmit:je(ze),className:"space-y-3",children:[e.jsxs(M,{children:[e.jsx(V,{className:"pb-2",children:e.jsx(A,{className:"text-lg",children:"기본 정보"})}),e.jsxs(L,{className:"space-y-3 pt-2",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"templateId",children:"발주서 템플릿 *"}),e.jsxs($,{onValueChange:t=>{const a=parseInt(t);console.log("Template selected:",a),j("templateId",a),G(a),console.log("Setting selectedTemplateId to:",a),R([{itemId:0,itemName:"",specification:"",majorCategory:"",middleCategory:"",minorCategory:"",quantity:1,unitPrice:0,totalAmount:0,notes:""}]),j("items",[{itemId:0,itemName:"",specification:"",majorCategory:"",middleCategory:"",minorCategory:"",quantity:1,unitPrice:0,totalAmount:0,notes:""}])},disabled:J,value:h?.toString()||"",children:[e.jsx(B,{children:e.jsx(Q,{placeholder:J?"로딩 중...":"템플릿을 선택하세요"})}),e.jsx(W,{children:p&&p.length>0?p.map(t=>(console.log("Rendering template:",t),e.jsx(O,{value:t.id.toString(),children:t.templateName},t.id))):e.jsx(O,{value:"no-templates",disabled:!0,children:"템플릿이 없습니다"})})]}),D.templateId&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:D.templateId.message}),se&&e.jsx("p",{className:"text-yellow-600 text-sm mt-1",children:"템플릿 API 연결 오류: 기본 템플릿 사용 중"})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"projectId",children:"현장 *"}),e.jsxs($,{onValueChange:t=>{const a=parseInt(t);j("projectId",a);const s=re?.find(n=>n.id===a);s&&we(s)},children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"현장을 선택하세요"})}),e.jsx(W,{children:oe?e.jsx(O,{value:"loading",disabled:!0,children:"로딩 중..."}):re?.map(t=>e.jsxs(O,{value:t.id.toString(),children:[t.projectName," (",t.projectCode,")"]},t.id))||e.jsx(O,{value:"no-projects",disabled:!0,children:"현장이 없습니다"})})]}),D.projectId&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:D.projectId.message})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"vendorId",children:"거래처 *"}),e.jsxs($,{onValueChange:t=>{const a=parseInt(t);j("vendorId",a);const s=pe?.find(n=>n.id===a);s&&ge(s)},children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"거래처를 선택하세요"})}),e.jsx(W,{className:"z-[100] dropdown-high-priority",style:{position:"fixed",zIndex:9999},children:pe?.map(t=>e.jsx(O,{value:t.id.toString(),children:t.name},t.id))})]}),D.vendorId&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:D.vendorId.message})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"orderDate",children:"발주서 작성일 *"}),e.jsx(N,{id:"orderDate",type:"date",...ie("orderDate")}),D.orderDate&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:D.orderDate.message})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"deliveryDate",children:"납품 희망일"}),e.jsx(N,{id:"deliveryDate",type:"date",...ie("deliveryDate")})]})]}),(w||u)&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[w&&e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"현장 정보"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"현장명:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:w.projectName})]}),w.location&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"주소:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:w.location})]}),w.projectManager&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"현장 관리자:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:w.projectManager})]}),w.managerPhone&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"전화번호:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:w.managerPhone})]}),w.managerEmail&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"이메일:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:w.managerEmail})]})]})]}),u&&e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-2",children:"거래처 정보"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"거래처명:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:u.name})]}),u.contactPerson&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"담당자:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:u.contactPerson})]}),u.phone&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"연락처:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:u.phone})]}),u.email&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"이메일:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:u.email})]}),u.address&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-600",children:"주소:"}),e.jsx("span",{className:"ml-2 text-gray-900",children:u.address})]})]})]})]})})]})]}),_&&Oe(),e.jsxs(M,{children:[e.jsx(V,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"text-lg",children:"발주 품목"}),e.jsxs(P,{type:"button",variant:"outline",size:"sm",onClick:d,children:[e.jsx(Me,{className:"h-4 w-4 mr-1"}),"품목 추가"]})]})}),e.jsxs(L,{className:"pt-2",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ae,{children:[e.jsx(Le,{children:e.jsxs(ve,{children:[e.jsx(k,{className:"py-2",children:"품목명"}),e.jsx(k,{className:"py-2",children:"규격"}),e.jsx(k,{className:"py-2",children:"대분류"}),e.jsx(k,{className:"py-2",children:"중분류"}),e.jsx(k,{className:"py-2",children:"소분류"}),e.jsx(k,{className:"py-2",children:"수량"}),e.jsx(k,{className:"py-2",children:"단가"}),e.jsx(k,{className:"py-2",children:"금액"}),e.jsx(k,{className:"py-2",children:"비고"}),e.jsx(k,{className:"py-2 text-center",children:"복사"}),e.jsx(k,{className:"py-2 text-center",children:"삭제"})]})}),e.jsx(Re,{children:g.map((t,a)=>e.jsxs(ve,{children:[e.jsx(f,{className:"py-1",children:e.jsx("div",{className:"min-w-[180px]",children:e.jsxs($,{value:t.itemId?t.itemId.toString():"",onValueChange:s=>U(a,parseInt(s)),children:[e.jsx(B,{className:"h-8",children:e.jsx(Q,{placeholder:"품목을 선택하세요"})}),e.jsx(W,{children:ne?.map(s=>e.jsx(O,{value:s.id.toString(),children:s.name},s.id))})]})})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8",placeholder:"규격",value:t.specification,onChange:s=>E(a,"specification",s.target.value)})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8",placeholder:"대분류",value:t.majorCategory,onChange:s=>E(a,"majorCategory",s.target.value)})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8",placeholder:"중분류",value:t.middleCategory,onChange:s=>E(a,"middleCategory",s.target.value)})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8",placeholder:"소분류",value:t.minorCategory,onChange:s=>E(a,"minorCategory",s.target.value)})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8",type:"number",placeholder:"수량",value:t.quantity||"",onChange:s=>E(a,"quantity",parseFloat(s.target.value)||0)})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8",type:"text",placeholder:"₩0",value:b[a]||ee(t.unitPrice),onChange:s=>{const n=[...b];n[a]=s.target.value,q(n);const m=ce(s.target.value);E(a,"unitPrice",m)},onBlur:s=>{const n=ce(s.target.value),m=ee(n),T=[...b];T[a]=m,q(T)}})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8 bg-gray-50",readOnly:!0,value:Ne(le(t))})}),e.jsx(f,{className:"py-1",children:e.jsx(N,{className:"h-8",placeholder:"비고",value:t.notes,onChange:s=>E(a,"notes",s.target.value)})}),e.jsx(f,{className:"py-1 text-center",children:e.jsx(P,{type:"button",variant:"ghost",size:"sm",onClick:()=>z(a),className:"h-6 w-6 p-0",children:e.jsx(Ve,{className:"h-3 w-3 text-blue-500"})})}),e.jsx(f,{className:"py-1 text-center",children:e.jsx(P,{type:"button",variant:"ghost",size:"sm",onClick:()=>H(a),disabled:g.length===1,className:"h-6 w-6 p-0",children:e.jsx(Te,{className:"h-3 w-3 text-red-500"})})})]},a))}),e.jsx("tfoot",{className:"bg-gray-50",children:e.jsxs(ve,{children:[e.jsx(f,{colSpan:7,className:"py-2 text-right font-medium",children:"총 금액:"}),e.jsx(f,{className:"py-2 font-bold text-lg",children:Ne(he())}),e.jsx(f,{colSpan:3,className:"py-2"})]})})]})}),D.items&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:D.items.message})]})]}),e.jsxs(M,{children:[e.jsx(V,{className:"pb-2",children:e.jsx(A,{className:"text-lg",children:"파일 첨부"})}),e.jsxs(L,{className:"pt-2",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-3 text-center hover:border-primary/50 transition-colors",children:[e.jsx(qe,{className:"mx-auto h-6 w-6 text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"파일을 드래그하거나 클릭하여 업로드"}),e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"PDF, DWG, 이미지 파일 (최대 10MB)"}),e.jsx("input",{type:"file",multiple:!0,accept:".pdf,.dwg,.jpg,.jpeg,.png,.gif",onChange:fe,className:"hidden",id:"fileUpload"}),e.jsx(P,{type:"button",variant:"outline",size:"sm",onClick:()=>document.getElementById("fileUpload")?.click(),children:"파일 선택"})]}),K.length>0&&e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"첨부된 파일"}),K.map((t,a)=>e.jsxs("div",{className:"flex items-center justify-between p-1 bg-gray-50 rounded text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(_e,{className:"h-3 w-3 text-gray-400"}),e.jsx("span",{className:"text-gray-700",children:t.name}),e.jsxs("span",{className:"text-gray-500",children:["(",(t.size/1024/1024).toFixed(2)," MB)"]})]}),e.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"h-4 w-4 p-0",onClick:()=>Ee(a),children:e.jsx(Te,{className:"h-3 w-3 text-red-500"})})]},a))]})]})]}),e.jsxs(M,{children:[e.jsx(V,{className:"pb-2",children:e.jsx(A,{className:"text-lg",children:"특이사항"})}),e.jsx(L,{className:"pt-2",children:e.jsx(ke,{...ie("notes"),placeholder:"발주 관련 특이사항이나 요청사항을 입력하세요",rows:3,className:"text-sm"})})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-3 border-t",children:[e.jsx(P,{type:"button",variant:"outline",size:"sm",onClick:de,children:"취소"}),e.jsx(P,{type:"submit",size:"sm",disabled:l.isPending||o.isPending,children:l.isPending||o.isPending?"저장 중...":v?"수정":"발주서 제출"})]})]})},`general-${h}`)}export{st as OrderForm};
