import{u as V,a as B,b as M,v as U,r as S,k as f,p as Y,j as e,m,o as C,y as T,z as q,q as w,L as v,I as j,P as _,l as g,t as P}from"./index-CKOkJa8a.js";import{T as J}from"./textarea-C8421qec.js";import{S as E,a as k,b as F,c as O,d as L}from"./select-DmFFwEDq.js";import{T as W,a as X,b as $,c as u,d as Z,e as x}from"./table-CS3WGgKq.js";import{i as ee}from"./authUtils-CcDzk6i0.js";import{A as se}from"./arrow-left-BWU8ue7L.js";import{S as te}from"./square-pen-BgHgGG75.js";import{T as re}from"./trash-2-CvqwPzWA.js";import{S as ae}from"./save-Cr1utZ58.js";import"./index-CAd-gX2w.js";import"./chevron-down-DecYLFH6.js";import"./chevron-up-BJNKxpa8.js";function ge(){V();const{toast:p}=B(),[ie,h]=M(),b=U(),n=b.id;console.log("OrderEdit params:",b),console.log("OrderEdit orderId:",n,typeof n);const[i,l]=S.useState({vendorId:"",orderDate:"",deliveryDate:"",notes:"",items:[]}),{data:a,isLoading:D,error:y}=f({queryKey:[`/api/orders/${n}`],queryFn:()=>g("GET",`/api/orders/${n}`),enabled:!!n});console.log("OrderEdit Debug:",{orderId:n,order:a,orderLoading:D,orderError:y,enabled:!!n});const{data:K}=f({queryKey:["/api/vendors"],queryFn:()=>g("GET","/api/vendors")}),{data:z}=f({queryKey:["/api/items"],queryFn:()=>g("GET","/api/items")}),o=z?.items||[];S.useEffect(()=>{if(a&&o.length>0){const s=(a.items||[]).map(t=>{let r=null;return r=o.find(d=>d.name===t.itemName),r||(r=o.find(d=>d.name.includes(t.itemName)||t.itemName.includes(d.name))),!r&&t.itemId&&(r=o.find(d=>d.id===t.itemId)),{itemId:r?.id||null,itemName:t.itemName||"",quantity:parseFloat(t.quantity)||1,unitPrice:parseFloat(t.unitPrice)||0,specification:t.specification||"",notes:t.notes||""}});l({vendorId:a.vendorId?.toString()||"",orderDate:a.orderDate?new Date(a.orderDate).toISOString().split("T")[0]:"",deliveryDate:a.deliveryDate?new Date(a.deliveryDate).toISOString().split("T")[0]:"",notes:a.notes||"",items:s})}else a&&o.length===0&&l({vendorId:a.vendorId?.toString()||"",orderDate:a.orderDate?new Date(a.orderDate).toISOString().split("T")[0]:"",deliveryDate:a.deliveryDate?new Date(a.deliveryDate).toISOString().split("T")[0]:"",notes:a.notes||"",items:a.items||[]})},[a,o]);const N=Y({mutationFn:async s=>await g("PATCH",`/api/orders/${n}`,s),onSuccess:()=>{p({title:"성공",description:"발주서가 수정되었습니다."}),P.invalidateQueries({queryKey:[`/api/orders/${n}`]}),P.invalidateQueries({queryKey:["/api/orders"]}),h(`/orders/${n}`)},onError:s=>{if(ee(s)){p({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{h("/login")},500);return}p({title:"오류",description:"발주서 수정에 실패했습니다.",variant:"destructive"})}}),A=s=>{if(s.preventDefault(),!i.vendorId||!i.orderDate||i.items.length===0){p({title:"오류",description:"모든 필수 필드를 입력해주세요.",variant:"destructive"});return}const t={vendorId:parseInt(i.vendorId),orderDate:new Date(i.orderDate),deliveryDate:i.deliveryDate?new Date(i.deliveryDate):null,notes:i.notes,items:i.items.map(r=>({itemId:r.itemId,itemName:r.itemName,quantity:Number(r.quantity),unitPrice:Number(r.unitPrice),specification:r.specification||"",notes:r.notes||""}))};N.mutate(t)},H=()=>{l(s=>({...s,items:[...s.items,{itemId:null,itemName:"",quantity:1,unitPrice:0,specification:"",notes:""}]}))},R=s=>{l(t=>({...t,items:t.items.filter((r,d)=>d!==s)}))},c=(s,t,r)=>{l(d=>({...d,items:d.items.map((I,Q)=>Q===s?{...I,[t]:r}:I)}))},G=(s,t)=>{const r=o.find(d=>d.id.toString()===t);r&&(c(s,"itemId",r.id),c(s,"itemName",r.name),c(s,"unitPrice",r.unitPrice||0),c(s,"specification",r.specification||""))};return D?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4 mb-6"}),e.jsx("div",{className:"h-96 bg-gray-200 rounded"})]})}):y?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서 로드 중 오류가 발생했습니다"}),e.jsx("p",{className:"mb-4 text-red-600",children:y.message}),e.jsx(m,{onClick:()=>h("/orders"),children:"발주서 목록으로 돌아가기"})]})}):a?e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>h(`/orders/${n}`),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"돌아가기"]}),e.jsx(te,{className:"h-6 w-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"발주서 수정"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"발주서 정보를 수정합니다"})]})]})})}),e.jsxs("form",{onSubmit:A,children:[e.jsxs(C,{className:"mb-6",children:[e.jsx(T,{children:e.jsx(q,{children:"기본 정보"})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"vendor",children:"거래처 *"}),e.jsxs(E,{value:i.vendorId,onValueChange:s=>l(t=>({...t,vendorId:s})),children:[e.jsx(k,{children:e.jsx(F,{placeholder:"거래처를 선택하세요"})}),e.jsx(O,{children:K?.map(s=>e.jsx(L,{value:s.id.toString(),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"orderDate",children:"발주일자 *"}),e.jsx(j,{id:"orderDate",type:"date",value:i.orderDate,onChange:s=>l(t=>({...t,orderDate:s.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"deliveryDate",children:"납품희망일"}),e.jsx(j,{id:"deliveryDate",type:"date",value:i.deliveryDate,onChange:s=>l(t=>({...t,deliveryDate:s.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"notes",children:"비고"}),e.jsx(J,{id:"notes",placeholder:"추가 정보나 요청사항을 입력하세요",value:i.notes,onChange:s=>l(t=>({...t,notes:s.target.value})),rows:3})]})]})]}),e.jsxs(C,{className:"mb-6",children:[e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(q,{children:"발주 품목"}),e.jsxs(m,{type:"button",onClick:H,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"품목 추가"]})]})}),e.jsxs(w,{children:[i.items.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"발주할 품목을 추가해주세요"}):e.jsxs(W,{children:[e.jsx(X,{children:e.jsxs($,{children:[e.jsx(u,{children:"품목명 *"}),e.jsx(u,{children:"수량 *"}),e.jsx(u,{children:"단가"}),e.jsx(u,{children:"규격"}),e.jsx(u,{children:"비고"}),e.jsx(u,{children:"총액"}),e.jsx(u,{className:"w-[100px]",children:"작업"})]})}),e.jsx(Z,{children:i.items.map((s,t)=>e.jsxs($,{children:[e.jsx(x,{children:e.jsxs(E,{value:s.itemId?.toString()||"",onValueChange:r=>G(t,r),children:[e.jsx(k,{children:e.jsx(F,{placeholder:s.itemName||"품목 선택"})}),e.jsx(O,{children:o.map(r=>e.jsx(L,{value:r.id.toString(),children:r.name},r.id))})]})}),e.jsx(x,{children:e.jsx(j,{type:"number",value:s.quantity,onChange:r=>c(t,"quantity",Number(r.target.value)),min:"1",required:!0})}),e.jsx(x,{children:e.jsx(j,{type:"number",value:s.unitPrice,onChange:r=>c(t,"unitPrice",Number(r.target.value)),min:"0"})}),e.jsx(x,{children:e.jsx(j,{value:s.specification,onChange:r=>c(t,"specification",r.target.value),placeholder:"규격 입력"})}),e.jsx(x,{children:e.jsx(j,{value:s.notes,onChange:r=>c(t,"notes",r.target.value),placeholder:"비고 입력"})}),e.jsxs(x,{children:["₩",(Number(s.quantity)*Number(s.unitPrice)).toLocaleString("ko-KR")]}),e.jsx(x,{children:e.jsx(m,{type:"button",variant:"ghost",size:"sm",onClick:()=>R(t),children:e.jsx(re,{className:"h-4 w-4 text-red-500"})})})]},t))})]}),i.items.length>0&&e.jsx("div",{className:"mt-4 pt-4 border-t mx-6 mb-6",children:e.jsx("div",{className:"flex justify-end",children:e.jsx("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg",children:e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"총 합계 금액"}),e.jsxs("div",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:["₩",i.items.reduce((s,t)=>{const r=(t.quantity||0)*(t.unitPrice||0);return s+r},0).toLocaleString()]})]})})})})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(m,{type:"button",variant:"outline",onClick:()=>h(`/orders/${n}`),children:"취소"}),e.jsxs(m,{type:"submit",disabled:N.isPending,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),N.isPending?"저장 중...":"저장"]})]})]})]}):e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서를 찾을 수 없습니다"}),e.jsxs("p",{className:"mb-4 text-gray-600",children:["OrderID: ",n]}),e.jsx(m,{onClick:()=>h("/orders"),children:"발주서 목록으로 돌아가기"})]})})}export{ge as default};
