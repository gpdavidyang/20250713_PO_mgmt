# 📄 엑셀 발주서 업로드 → 이메일 발송 전체 워크플로우 (업그레이드 버전)

---

## 🟦 Step 0. 양식 사전 검증 단계 (사전 유효성 검사)

**목적**: 업로드 직후 파싱 오류 방지 및 UX 향상

**검사 항목 및 처리 방식:**
- `Input` 시트 존재 여부 → 없을 경우 업로드 중단 및 에러 표시
- 필수 Header 누락 여부 (예: 발주번호, 거래처명) → 누락 시 사용자 안내
- 빈 행 또는 필수값 누락 여부 → 유효성 검사 후 사용자에게 수정 요청

✅ **사전 오류 방지 및 사용자 편의성 향상**

---

## 🟦 Step 1. 엑셀 파일 업로드

- 사용자는 ‘엑셀 발주서’ 메뉴에서 파일 업로드
- 필수 시트: `Input`, `갑지`, `을지`

---

## 🟦 Step 2. Input 시트 파싱 및 데이터 추출

- 1행 Header 기준으로 각 Row 파싱
- 주요 추출 항목: 발주번호, 발주일, 거래처명, 납품처명 등
- 거래처명/납품처명 → 중복 제거하여 고유 리스트 구성

🔹 **Validation 고도화 제안**
- 최근 사용 거래처 자동 추천
- 납품처 주소 자동 조회
- 거래처 담당자 정보 자동 로딩

✅ **정확한 이메일 커뮤니케이션 가능**

---

## 🟦 Step 3. 거래처/납품처 존재 여부 확인

- DB `vendors` 테이블에서 명칭 검색
- 미존재 시:
  - 유사 이름 추천
  - 사용자 확인 후 직접 선택 or 신규 등록

---

## 🟦 Step 4. 이메일 수신 대상자 결정

- 확인된 거래처/납품처의 이메일을 수신자로 설정
- 복수 건일 경우, 중복 제거하여 리스트 구성

---

## 🟦 Step 5. 사용자 확인 단계

- 발송 요약 정보 사용자에게 표시:
  - 수신자 이메일 리스트
  - 첨부파일 미리보기
  - 이메일 본문 Preview
  - “다시 확인하기” 기능 제공

✅ **실수 방지 및 사용자 신뢰도 강화**

---

## 🟦 Step 6. 첨부 파일 생성

- `Input` 시트 제외한 엑셀 파일 생성 (`갑지`, `을지` 유지)
- 위 엑셀 파일을 PDF로 변환
- 워터마크 삽입 여부 및 비밀번호 설정 → **UI에서 사용자가 선택**
  - 예: “Confidential” 워터마크, 사용자 입력 비밀번호

📎 **엑셀 + PDF 파일 2종 첨부**

✅ **보안 및 문서 정합성 강화**

---

## 🟦 Step 7. 이메일 발송

- 이메일 제목/본문 자동 생성
- 첨부파일 포함, 사용자 승인 후 이메일 전송
- 발송 성공/실패 결과 저장 및 사용자에게 피드백

🔹 **추적 기능**
- “발주서 관리”에 상태 노출
- 거래처별 발송 이력 확인 기능

✅ **CS 대응 및 기록 관리 강화**

---

## ✅ 최종 상태 정리

- 모든 발주 정보 → DB `purchase_orders` 저장
- “발주서 관리” 화면에 자동 반영
- 이메일 발송 상태는 DB에 `email_status` 필드로 저장
  - 예: `success`, `failure`, `pending`

---
