import{g as ee,r as c,j as e,s as V,G as C,H as T,N as U,aq as D,t as F,F as k,B as m,n as j}from"./index-B5aSphH7.js";import{u as se}from"./index-DYMRwy0X.js";import{S as te}from"./separator-CO_8toA1.js";import{A as H,a as q}from"./alert-BXC6_2B1.js";import{P as re}from"./progress-DFwZp-ML.js";import{V as ae}from"./vendor-validation-modal-DGZBarXw.js";import{C as v}from"./circle-x-DLDhUBHX.js";import{M as ie}from"./mail-CXeqvvVG.js";import{D as G}from"./download-Bfbpieyb.js";import{S as le}from"./send-BCW318Af.js";import{C as I}from"./circle-check-h6eZTtM7.js";import{T as ne}from"./triangle-alert-BdQI4N1N.js";import{T as oe}from"./trash-2-BNLUUISF.js";import"./index-Bb2Q5Qo1.js";import"./dialog-DEeopRYd.js";import"./index-DIhXHIGT.js";function Se(){const{theme:K}=ee(),t=K==="dark",[$,g]=c.useState(0),[p,P]=c.useState([{id:"upload",title:"파일 업로드 및 파싱",description:"Excel 파일을 업로드하고 Input 시트를 파싱합니다",status:"pending"},{id:"save",title:"데이터베이스 저장",description:"발주서 데이터를 데이터베이스에 저장합니다",status:"pending"},{id:"validate",title:"거래처 검증",description:"거래처명을 검증하고 이메일 주소를 확인합니다",status:"pending"},{id:"preview",title:"이메일 미리보기",description:"발송할 이메일 내용과 수신자를 확인합니다",status:"pending"}]),[a,E]=c.useState(null),[x,u]=c.useState(!1),[y,n]=c.useState(null),[A,S]=c.useState(!1),[ce,M]=c.useState([]),[o,O]=c.useState(null),L=c.useCallback(async s=>{const r=s[0];if(r){u(!0),n(null),g(0),P(i=>i.map(l=>({...l,status:"pending"})));try{h("upload","processing");const i=new FormData;i.append("file",r),console.log("📤 [클라이언트] 파일 업로드 시작:",{fileName:r.name,fileSize:r.size,fileType:r.type});const l=new AbortController,Z=setTimeout(()=>l.abort(),58e3),d=await fetch("/api/excel-automation/upload-and-process",{method:"POST",body:i,credentials:"include",signal:l.signal});if(clearTimeout(Z),console.log("📥 [클라이언트] 서버 응답 수신:",{status:d.status,ok:d.ok}),d.status===401){n("인증이 만료되었습니다. 페이지를 새로고침하고 다시 로그인해주세요.");return}if(!d.ok){const R=await d.text();let b=`서버 오류 (${d.status})`;try{const J=JSON.parse(R);b=J.error||J.message||b}catch{b=R||b}throw new Error(b)}const w=await d.json();if(!w.success)throw new Error(w.error||"파일 처리 실패");h("upload","completed"),h("save","completed"),h("validate","completed"),h("preview","completed"),E(w.data),w.data.vendorValidation.needsUserAction?S(!0):g(1)}catch(i){console.error("📋 [클라이언트] 자동화 처리 오류:",i);let l="알 수 없는 오류가 발생했습니다";i instanceof Error&&(l=i.message,i.message.includes("Failed to fetch")?l="서버 연결에 실패했습니다. 네트워크 상태를 확인해주세요.":i.message.includes("timeout")||i.name==="AbortError"?l="요청 시간이 초과되었습니다. 파일 크기를 줄이거나 나누어서 업로드해주세요.":i.message.includes("500")?l="서버 내부 오류가 발생했습니다. 잠시 후 다시 시도해주세요.":i.message.includes("413")?l="파일 크기가 너무 큽니다 (최대 10MB). 더 작은 파일로 시도해주세요.":i.message.includes("422")&&(l="파일 형식이 올바르지 않습니다. Excel 파일(.xlsx, .xlsm, .xls)만 업로드 가능합니다.")),console.error("📋 [클라이언트] 최종 에러 메시지:",l),n(l),h("upload","error")}finally{u(!1)}}},[]),{getRootProps:W,getInputProps:X,isDragActive:f,isDragReject:N,rejectedFiles:de}=se({onDrop:L,accept:{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"],"application/vnd.ms-excel.sheet.macroEnabled.12":[".xlsm"],"application/vnd.ms-excel":[".xls"]},maxFiles:1,maxSize:10485760,disabled:x,onDropRejected:s=>{const r=s[0];r&&(r.file.size>10485760?n("파일 크기가 10MB를 초과합니다. 더 작은 파일을 선택해주세요."):n("지원하지 않는 파일 형식입니다. .xlsx, .xlsm, .xls 파일만 업로드 가능합니다."))}}),h=(s,r)=>{P(i=>i.map(l=>l.id===s?{...l,status:r}:l))},_=async s=>{if(a?.filePath){M(s),S(!1),u(!0);try{const r=await fetch("/api/excel-automation/update-email-preview",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({filePath:a.filePath,selectedVendors:s})});if(r.status===401){n("인증이 만료되었습니다. 페이지를 새로고침하고 다시 로그인해주세요.");return}if(!r.ok){const l=await r.text();throw new Error(`서버 오류 (${r.status}): ${l||r.statusText}`)}const i=await r.json();if(i.success)E(l=>l?{...l,emailPreview:i.data.emailPreview}:null),g(1);else throw new Error(i.error)}catch(r){n(r instanceof Error?r.message:"이메일 미리보기 업데이트 실패")}finally{u(!1)}}},Q=async()=>{if(a?.emailPreview){u(!0),n(null);try{const s=await fetch("/api/excel-automation/send-emails",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({processedFilePath:`uploads/${a.emailPreview.attachmentInfo.processedFile}`,recipients:a.emailPreview.recipients,emailOptions:{subject:a.emailPreview.subject,orderNumber:`AUTO-${Date.now()}`,additionalMessage:"자동화 시스템을 통해 발송된 발주서입니다."}})});if(s.status===401){n("인증이 만료되었습니다. 페이지를 새로고침하고 다시 로그인해주세요.");return}if(!s.ok){const i=await s.text();throw new Error(`서버 오류 (${s.status}): ${i||s.statusText}`)}const r=await s.json();if(r.success)O(r.data),g(2);else throw new Error(r.error)}catch(s){n(s instanceof Error?s.message:"이메일 발송 실패")}finally{u(!1)}}},z=()=>{g(0),E(null),n(null),M([]),O(null),P(s=>s.map(r=>({...r,status:"pending"})))},B=s=>s>1024*1024?`${(s/(1024*1024)).toFixed(1)}MB`:`${(s/1024).toFixed(1)}KB`,Y=s=>{switch(s){case"completed":return e.jsx(I,{className:"h-5 w-5 text-green-500"});case"error":return e.jsx(v,{className:"h-5 w-5 text-red-500"});case"processing":return e.jsx("div",{className:`h-5 w-5 border-2 border-t-transparent rounded-full animate-spin transition-colors ${t?"border-blue-400":"border-blue-500"}`});default:return e.jsx("div",{className:`h-5 w-5 border-2 rounded-full transition-colors ${t?"border-gray-600":"border-gray-300"}`})}};if($===0&&!a)return e.jsx("div",{className:"space-y-6",children:e.jsxs(V,{className:`transition-colors ${t?"bg-gray-800 border-gray-700":"bg-white border-gray-200"}`,children:[e.jsxs(C,{children:[e.jsxs(T,{className:`flex items-center gap-2 transition-colors ${t?"text-white":"text-gray-900"}`,children:[e.jsx(U,{className:"h-5 w-5"}),"Excel 발주서 자동화 처리"]}),e.jsx(D,{className:`transition-colors ${t?"text-gray-400":"text-gray-600"}`,children:"Excel 파일을 업로드하면 발주서 데이터 저장부터 이메일 발송까지 자동으로 처리됩니다"})]}),e.jsxs(F,{children:[e.jsxs("div",{...W(),className:`relative border-2 border-dashed rounded-lg p-8 text-center transition-all duration-300 ${N?t?"border-red-400 bg-red-900/30 scale-105":"border-red-500 bg-red-50 scale-105":f?t?"border-blue-400 bg-blue-900/30 scale-105 shadow-lg":"border-blue-500 bg-blue-50 scale-105 shadow-lg":t?"border-gray-600 hover:border-gray-500 hover:bg-gray-800/20":"border-gray-300 hover:border-gray-400 hover:bg-gray-50"} ${x?"opacity-50 cursor-not-allowed":"cursor-pointer hover:shadow-md"}`,children:[e.jsx("input",{...X()}),e.jsx("div",{className:`transition-all duration-300 ${f?"animate-bounce":N?"animate-pulse":""}`,children:N?e.jsx(v,{className:`h-16 w-16 mx-auto mb-4 transition-colors ${t?"text-red-400":"text-red-600"}`}):f?e.jsx(U,{className:`h-16 w-16 mx-auto mb-4 transition-colors ${t?"text-blue-400":"text-blue-600"}`}):e.jsx(k,{className:`h-12 w-12 mx-auto mb-4 transition-colors ${t?"text-gray-500":"text-gray-400"} group-hover:text-blue-500`})}),N?e.jsxs("div",{children:[e.jsx("p",{className:`text-lg font-semibold mb-2 transition-colors ${t?"text-red-400":"text-red-600"}`,children:"지원하지 않는 파일입니다! ❌"}),e.jsx("p",{className:`text-sm transition-colors ${t?"text-red-300":"text-red-500"}`,children:".xlsx, .xlsm, .xls 파일만 업로드 가능합니다"})]}):f?e.jsxs("div",{children:[e.jsx("p",{className:`text-lg font-semibold mb-2 transition-colors ${t?"text-blue-400":"text-blue-600"}`,children:"파일을 여기에 놓으세요! 📁"}),e.jsx("p",{className:`text-sm transition-colors ${t?"text-blue-300":"text-blue-500"}`,children:"Excel 파일이 자동으로 처리됩니다"})]}):e.jsxs("div",{children:[e.jsx("p",{className:`text-lg mb-2 font-medium transition-colors ${t?"text-gray-200":"text-gray-900"}`,children:"📄 Excel 파일을 드래그하거나 클릭하여 업로드"}),e.jsx("p",{className:`text-sm mb-2 transition-colors ${t?"text-gray-400":"text-gray-500"}`,children:".xlsx, .xlsm, .xls 파일 지원 (최대 10MB)"}),e.jsx("div",{className:"mt-4",children:e.jsx(m,{variant:"outline",size:"sm",disabled:x,className:`transition-colors ${t?"border-gray-600 hover:border-blue-400 hover:text-blue-400":"border-gray-300 hover:border-blue-500 hover:text-blue-600"}`,onClick:s=>s.preventDefault(),children:"파일 선택하기"})})]}),f&&e.jsx("div",{className:"absolute inset-0 rounded-lg bg-gradient-to-br from-blue-500/10 to-purple-500/10 animate-pulse"})]}),x&&e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:`flex items-center justify-between text-sm transition-colors ${t?"text-gray-300":"text-gray-700"}`,children:[e.jsx("span",{children:"처리 진행 상황"}),e.jsxs("span",{children:[p.filter(s=>s.status==="completed").length," / ",p.length]})]}),e.jsx(re,{value:p.filter(s=>s.status==="completed").length/p.length*100}),e.jsx("div",{className:"space-y-2",children:p.map(s=>e.jsxs("div",{className:`flex items-center gap-3 p-2 rounded transition-colors ${t?"hover:bg-gray-700":"hover:bg-gray-50"}`,children:[Y(s.status),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:`font-medium transition-colors ${t?"text-gray-200":"text-gray-900"}`,children:s.title}),e.jsx("div",{className:`text-sm transition-colors ${t?"text-gray-400":"text-gray-500"}`,children:s.description})]})]},s.id))})]}),y&&e.jsxs(H,{className:"mt-4",variant:"destructive",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx(q,{children:y})]})]})]})});if(A&&a){const s={vendorValidations:a.vendorValidation.invalidVendors.map(r=>({vendorName:r.vendorName,exists:!1,suggestions:r.suggestions?.map(i=>({...i,contactPerson:i.contactPerson||"",distance:i.distance||0}))||[]})),deliveryValidations:[],emailConflicts:[],summary:{totalVendors:a.vendorValidation.validVendors.length+a.vendorValidation.invalidVendors.length,totalDeliveries:0,unregisteredVendors:a.vendorValidation.invalidVendors.length,unregisteredDeliveries:0,emailConflicts:0,needsAction:a.vendorValidation.needsUserAction}};return e.jsx(ae,{isOpen:A,onClose:()=>S(!1),validationData:s,onConfirm:r=>{const i=r.filter(l=>l.action==="use_existing"&&l.existingVendorId).map(l=>({originalName:l.originalName,selectedVendorId:l.existingVendorId,selectedVendorEmail:""}));_(i)}})}return $===1&&a?e.jsx("div",{className:"space-y-6",children:e.jsxs(V,{className:`transition-colors ${t?"bg-gray-800 border-gray-700":"bg-white border-gray-200"}`,children:[e.jsxs(C,{children:[e.jsxs(T,{className:`flex items-center gap-2 transition-colors ${t?"text-white":"text-gray-900"}`,children:[e.jsx(ie,{className:"h-5 w-5"}),"이메일 발송 미리보기"]}),e.jsx(D,{className:`transition-colors ${t?"text-gray-400":"text-gray-600"}`,children:"발송할 이메일 내용을 확인하고 전송하세요"})]}),e.jsxs(F,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:`text-center p-4 rounded-lg transition-colors ${t?"bg-green-900/20":"bg-green-50"}`,children:[e.jsx("div",{className:`text-2xl font-bold transition-colors ${t?"text-green-400":"text-green-600"}`,children:a.savedOrders}),e.jsx("div",{className:`text-sm transition-colors ${t?"text-green-400":"text-green-600"}`,children:"저장된 발주서"})]}),e.jsxs("div",{className:`text-center p-4 rounded-lg transition-colors ${t?"bg-blue-900/20":"bg-blue-50"}`,children:[e.jsx("div",{className:`text-2xl font-bold transition-colors ${t?"text-blue-400":"text-blue-600"}`,children:a.vendorValidation.validVendors.length}),e.jsx("div",{className:`text-sm transition-colors ${t?"text-blue-400":"text-blue-600"}`,children:"확인된 거래처"})]}),e.jsxs("div",{className:`text-center p-4 rounded-lg transition-colors ${t?"bg-purple-900/20":"bg-purple-50"}`,children:[e.jsx("div",{className:`text-2xl font-bold transition-colors ${t?"text-purple-400":"text-purple-600"}`,children:a.emailPreview.recipients.length}),e.jsx("div",{className:`text-sm transition-colors ${t?"text-purple-400":"text-purple-600"}`,children:"이메일 수신자"})]})]}),e.jsx(te,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-sm font-medium transition-colors ${t?"text-gray-300":"text-gray-700"}`,children:"수신자"}),e.jsx("div",{className:"mt-1 flex flex-wrap gap-2",children:a.emailPreview.recipients.map((s,r)=>e.jsx(j,{variant:"secondary",children:s},r))})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-sm font-medium transition-colors ${t?"text-gray-300":"text-gray-700"}`,children:"제목"}),e.jsx("div",{className:`mt-1 p-2 rounded border transition-colors ${t?"bg-gray-700 border-gray-600 text-gray-100":"bg-gray-50 border-gray-200"}`,children:a.emailPreview.subject})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-sm font-medium transition-colors ${t?"text-gray-300":"text-gray-700"}`,children:"첨부파일"}),e.jsxs("div",{className:"mt-1 space-y-2",children:[e.jsxs("div",{className:`p-2 rounded border flex items-center gap-2 transition-colors ${t?"bg-gray-700 border-gray-600":"bg-gray-50 border-gray-200"}`,children:[e.jsx(k,{className:`h-4 w-4 transition-colors ${t?"text-blue-400":"text-blue-500"}`}),e.jsx("span",{className:`flex-1 transition-colors ${t?"text-gray-200":"text-gray-900"}`,children:a.emailPreview.attachmentInfo.processedFile}),e.jsx(j,{variant:"outline",children:B(a.emailPreview.attachmentInfo.fileSize)})]}),a.emailPreview.attachmentInfo.processedPdfFile&&e.jsxs("div",{className:`p-2 rounded border flex items-center gap-2 transition-colors ${t?"bg-gray-700 border-gray-600":"bg-gray-50 border-gray-200"}`,children:[e.jsx(k,{className:`h-4 w-4 transition-colors ${t?"text-red-400":"text-red-500"}`}),e.jsx("span",{className:`flex-1 transition-colors ${t?"text-gray-200":"text-gray-900"}`,children:a.emailPreview.attachmentInfo.processedPdfFile}),e.jsx(j,{variant:"outline",children:B(a.emailPreview.attachmentInfo.pdfFileSize||0)})]})]})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(m,{variant:"outline",onClick:z,children:"처음부터 다시"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{variant:"outline",onClick:()=>{const s=document.createElement("a");s.href=`/api/excel-automation/download/${a.emailPreview.attachmentInfo.processedFile}`,s.click()},children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"Excel 다운로드"]}),a.emailPreview.attachmentInfo.processedPdfFile&&e.jsxs(m,{variant:"outline",onClick:()=>{const s=document.createElement("a");s.href=`/api/excel-automation/download/${a.emailPreview.attachmentInfo.processedPdfFile}`,s.click()},children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"PDF 다운로드"]}),e.jsxs(m,{onClick:Q,disabled:!a.emailPreview.canProceed||x,children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),x?"발송 중...":"이메일 발송"]})]})]}),y&&e.jsxs(H,{variant:"destructive",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx(q,{children:y})]})]})]})}):$===2&&o?e.jsx("div",{className:"space-y-6",children:e.jsxs(V,{className:`transition-colors ${t?"bg-gray-800 border-gray-700":"bg-white border-gray-200"}`,children:[e.jsxs(C,{children:[e.jsxs(T,{className:`flex items-center gap-2 transition-colors ${t?"text-white":"text-gray-900"}`,children:[o.success?e.jsx(I,{className:"h-5 w-5 text-green-500"}):e.jsx(ne,{className:"h-5 w-5 text-yellow-500"}),"이메일 발송 결과"]}),e.jsx(D,{className:`transition-colors ${t?"text-gray-400":"text-gray-600"}`,children:o.success?`모든 이메일이 성공적으로 발송되었습니다 (${o.sentEmails}개)`:`일부 이메일 발송에 실패했습니다 (성공: ${o.sentEmails}개, 실패: ${o.failedEmails.length}개)`})]}),e.jsxs(F,{className:"space-y-6",children:[e.jsx("div",{className:"space-y-2",children:o.emailResults.map((s,r)=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded border transition-colors ${s.status==="sent"?t?"bg-green-900/20 border-green-700":"bg-green-50 border-green-200":t?"bg-red-900/20 border-red-700":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="sent"?e.jsx(I,{className:"h-4 w-4 text-green-500"}):e.jsx(v,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:`transition-colors ${t?"text-gray-200":"text-gray-900"}`,children:s.email})]}),e.jsx("div",{className:"text-sm",children:s.status==="sent"?e.jsx(j,{variant:"secondary",children:"발송 완료"}):e.jsx(j,{variant:"destructive",children:"실패"})})]},r))}),o.failedEmails.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:`font-medium mb-2 transition-colors ${t?"text-red-400":"text-red-600"}`,children:"발송 실패 상세"}),e.jsx("div",{className:"space-y-2",children:o.failedEmails.map((s,r)=>e.jsxs("div",{className:`p-2 rounded border transition-colors ${t?"bg-red-900/20 border-red-700":"bg-red-50 border-red-200"}`,children:[e.jsx("div",{className:`font-medium transition-colors ${t?"text-gray-200":"text-gray-900"}`,children:s.email}),e.jsx("div",{className:`text-sm transition-colors ${t?"text-red-400":"text-red-600"}`,children:s.error})]},r))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(m,{variant:"outline",onClick:z,children:"새 파일 처리"}),e.jsxs(m,{variant:"outline",onClick:()=>{fetch("/api/excel-automation/cleanup",{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({filePaths:[a?.filePath,`uploads/${a?.emailPreview.attachmentInfo.processedFile}`,a?.emailPreview.attachmentInfo.processedPdfFile?`uploads/${a.emailPreview.attachmentInfo.processedPdfFile}`:null].filter(Boolean)})})},children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"임시 파일 정리"]})]})]})]})}):null}export{Se as ExcelAutomationWizard};
