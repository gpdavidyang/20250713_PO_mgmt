import{m as Y,r as N,u as de,a as L,j as e,P as me,g as xe,c9 as ue,k as pe,l as he,K as H,b$ as w,F as ge,v as je,f as Ne,M as K,ab as fe}from"./chunk-Dd62wDmJ.js";import{u as ye}from"./chunk-CztufZQ6.js";import{a as D,l as ve,u as be,k as C,C as Q,b as we,I as S,Z as O,_ as E,$ as k,a0 as P,a2 as c,j as Se,al as De,am as Ce,an as Oe,ao as Ee,q as V}from"./index-Bmw6lq1s.js";import{i as q}from"./chunk-BMbn8S6D.js";import"./chunk-CuLW_54J.js";import"./chunk-BnRVfYRf.js";import"./chunk-CQ_RH0zA.js";import"./chunk-Szeu1KvF.js";import"./chunk-vB1_IvIP.js";import"./chunk-GSbO87rN.js";function ke(f={}){const o=Y(),g=N.useMemo(()=>["orders-optimized",Object.fromEntries(Object.entries(f).filter(([u,d])=>d!==void 0&&d!==""&&d!=="all"&&d!==null))],[f]),a=de({queryKey:g,queryFn:async()=>{const i=new URLSearchParams;Object.entries(f).forEach(([T,y])=>{y!==void 0&&y!==""&&y!=="all"&&y!==null&&i.append(T,y.toString())});const u=`/api/orders-optimized${i.toString()?`?${i}`:""}`;console.log("🚀 Fetching optimized orders:",u);const d=await D("GET",u);return console.log("✅ Optimized orders response:",{ordersCount:d.orders.length,total:d.total,queryTime:d.performance.queryTime}),d},staleTime:30*1e3,gcTime:5*60*1e3,refetchOnWindowFocus:!1,refetchOnMount:!0,retry:(i,u)=>u?.status>=400&&u?.status<500?!1:i<2}),l=()=>{if(a.data&&a.data.page<a.data.totalPages){const i={...f,page:a.data.page+1};o.prefetchQuery({queryKey:["orders-optimized",i],queryFn:()=>D("GET",`/api/orders-optimized?${new URLSearchParams(i)}`),staleTime:30*1e3})}};return{...a,orders:a.data?.orders||[],vendors:a.data?.metadata.vendors||[],projects:a.data?.metadata.projects||[],users:a.data?.metadata.users||[],total:a.data?.total||0,page:a.data?.page||1,totalPages:a.data?.totalPages||1,performance:a.data?.performance,prefetchNextPage:l,hasNextPage:a.data?a.data.page<a.data.totalPages:!1,hasPreviousPage:a.data?a.data.page>1:!1}}function Pe(f={}){const o=Y(),g=ke(f);return{...g,prefetchRelatedData:()=>{o.prefetchQuery({queryKey:["orders-metadata"],queryFn:()=>D("GET","/api/orders-metadata"),staleTime:10*60*1e3}),g.hasNextPage&&g.prefetchNextPage()},isOptimized:!0,cacheHit:g.performance?.cacheHit||!1,queryTime:g.performance?.queryTime||"unknown"}}function Ge(){const{user:f}=ve(),{toast:o}=be(),[g,a]=ye(),[l,i]=N.useState({status:"",vendorId:"",projectId:"",userId:"",startDate:"",endDate:"",minAmount:"",maxAmount:"",searchText:"",page:1,limit:50,sortBy:"orderDate",sortOrder:"desc"}),[u,d]=N.useState(!1),[T,y]=N.useState(!1),[r,B]=N.useState(null),[W,G]=N.useState(!1),[F,_]=N.useState(null);N.useEffect(()=>{const t=new URLSearchParams(window.location.search),s=t.get("status"),x=t.get("filter"),p=t.get("vendor"),n={page:1,status:"",vendorId:"",projectId:"",userId:"",startDate:"",endDate:"",minAmount:"",maxAmount:"",searchText:"",limit:50};if(s&&!x)n.status=s==="all"?"":s;else if(x==="monthly"){const v=new Date,h=v.getFullYear(),z=v.getMonth(),ne=new Date(h,z,1),le=new Date(h,z+1,0),M=I=>{const oe=I.getFullYear(),ie=String(I.getMonth()+1).padStart(2,"0"),ce=String(I.getDate()).padStart(2,"0");return`${oe}-${ie}-${ce}`};n.startDate=M(ne),n.endDate=M(le)}else if(x==="urgent"){const v=new Date,h=new Date;h.setDate(v.getDate()+7),n.startDate=v.toISOString().split("T")[0],n.endDate=h.toISOString().split("T")[0],n.status="approved"}p&&(n.vendorId=p),i(n)},[g]);const{orders:m,vendors:U,projects:Z,users:J,total:Te,page:Fe,totalPages:Ie,hasNextPage:Le,hasPreviousPage:qe,isLoading:X,error:Ue,cacheHit:$e,queryTime:Re,prefetchRelatedData:$}=Pe(l);N.useEffect(()=>{$()},[$]),L({mutationFn:async({orderId:t,status:s})=>{await D("PUT",`/api/orders/${t}/status`,{status:s})},onSuccess:()=>{V.invalidateQueries({queryKey:["orders-optimized"]}),o({title:"성공",description:"발주서 상태가 변경되었습니다."})},onError:t=>{if(q(t)){o({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{a("/login")},500);return}o({title:"오류",description:"발주서 상태 변경에 실패했습니다.",variant:"destructive"})}}),L({mutationFn:async t=>{await D("DELETE",`/api/orders/${t}`)},onSuccess:()=>{V.invalidateQueries({queryKey:["orders-optimized"]}),o({title:"성공",description:"발주서가 삭제되었습니다."})},onError:t=>{if(q(t)){o({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{a("/login")},500);return}o({title:"오류",description:"발주서 삭제에 실패했습니다.",variant:"destructive"})}});const R=L({mutationFn:async()=>{const t=new URLSearchParams;Object.entries(l).forEach(([v,h])=>{h&&h!=="all"&&h!==""&&t.append(v,h.toString())});const s=await fetch(`/api/orders/export?${t}`,{credentials:"include"});if(!s.ok)throw new Error("Export failed");const x=await s.blob(),p=window.URL.createObjectURL(x),n=document.createElement("a");n.href=p,n.download="orders.xlsx",document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(p),document.body.removeChild(n)},onError:t=>{if(q(t)){o({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{a("/login")},500);return}o({title:"오류",description:"엑셀 다운로드에 실패했습니다.",variant:"destructive"})}}),j=(t,s)=>{const x=s==="all"?"":s;i(p=>({...p,[t]:x,page:1}))},b=t=>{i(s=>({...s,sortBy:t,sortOrder:s.sortBy===t&&s.sortOrder==="desc"?"asc":"desc",page:1}))},ee=t=>{const s=m.find(x=>x.id===t.id);s&&(B(s),y(!0))},te=async t=>{if(r)try{const s={orderNumber:r.orderNumber,vendorName:r.vendorName||r.vendor?.name||"",orderDate:r.orderDate,totalAmount:r.totalAmount,siteName:r.projectName||r.project?.projectName,filePath:r.filePath||""};await Ee.sendPurchaseOrderEmail(s,t),o({title:"이메일 발송 완료",description:`${r.vendor?.name}에게 발주서 ${r.orderNumber}를 전송했습니다.`})}catch(s){o({title:"이메일 발송 실패",description:s instanceof Error?s.message:"이메일 발송 중 오류가 발생했습니다.",variant:"destructive"})}},ae=async t=>{try{const s=await fetch(`/api/orders/${t}/download`,{credentials:"include"});if(!s.ok)throw new Error("Download failed");const x=await s.blob(),p=window.URL.createObjectURL(x),n=document.createElement("a");n.href=p,n.download=`order-${t}.pdf`,document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(p),document.body.removeChild(n)}catch{o({title:"다운로드 실패",description:"발주서 다운로드에 실패했습니다.",variant:"destructive"})}};console.log("🔍 Orders Professional - orders data:",m),console.log("🔍 Orders Professional - first order:",m[0]),m[0]&&(console.log("🔍 Orders Professional - vendor info:",{vendor:m[0].vendor,vendorName:m[0].vendorName,vendorFromVendor:m[0].vendor?.name}),console.log("🔍 Orders Professional - project info:",{project:m[0].project,projectName:m[0].projectName,projectFromProject:m[0].project?.projectName}));const A=m,se=t=>!t.emailStatus||t.totalEmailsSent===0?e.jsx("span",{className:"text-xs text-gray-500",children:"미발송"}):t.emailStatus==="sent"?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"text-xs text-blue-600",children:"발송됨"})]}):t.emailStatus==="opened"?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(K,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"text-xs text-green-600",children:"열람됨"})]}):e.jsx("span",{className:"text-xs text-gray-500",children:"미발송"}),re=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"approved":return"bg-green-100 text-green-800 border-green-200";case"sent":return"bg-blue-100 text-blue-800 border-blue-200";case"completed":return"bg-purple-100 text-purple-800 border-purple-200";case"rejected":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"발주서 관리"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:l.vendorId?`${U?.find(t=>t.id.toString()===l.vendorId)?.name||""} 거래처 발주서`:"전체 발주서를 조회하고 관리하세요"})]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs(C,{onClick:()=>a("/create-order"),className:"bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2 shadow-sm",children:[e.jsx(me,{className:"h-4 w-4"}),"새 발주서 작성"]})})]})}),e.jsx(Q,{className:"mb-6 shadow-sm",children:e.jsxs(we,{className:"p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative max-w-xl",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5"}),e.jsx(S,{placeholder:"발주번호, 품목명으로 검색...",value:l.searchText,onChange:t=>j("searchText",t.target.value),className:"pl-10 h-11 text-sm border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100"})]})}),e.jsxs("div",{className:"flex flex-wrap gap-3 mb-4",children:[e.jsxs(O,{value:l.status||"all",onValueChange:t=>j("status",t),children:[e.jsx(E,{className:"w-40 h-10 border-gray-200",children:e.jsx(k,{placeholder:"상태 선택"})}),e.jsxs(P,{children:[e.jsx(c,{value:"all",children:"모든 상태"}),e.jsx(c,{value:"pending",children:"승인 대기"}),e.jsx(c,{value:"approved",children:"승인 완료"}),e.jsx(c,{value:"sent",children:"발송 완료"}),e.jsx(c,{value:"completed",children:"완료"}),e.jsx(c,{value:"rejected",children:"반려"})]})]}),e.jsxs(O,{value:l.projectId||"all",onValueChange:t=>j("projectId",t),children:[e.jsx(E,{className:"w-48 h-10 border-gray-200",children:e.jsx(k,{placeholder:"프로젝트 선택"})}),e.jsxs(P,{children:[e.jsx(c,{value:"all",children:"모든 프로젝트"}),Z?.map(t=>e.jsx(c,{value:t.id.toString(),children:t.projectName},t.id))]})]}),e.jsxs(O,{value:l.vendorId||"all",onValueChange:t=>j("vendorId",t),children:[e.jsx(E,{className:"w-48 h-10 border-gray-200",children:e.jsx(k,{placeholder:"거래처 선택"})}),e.jsxs(P,{children:[e.jsx(c,{value:"all",children:"모든 거래처"}),U?.map(t=>e.jsx(c,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs(C,{variant:"outline",onClick:()=>d(!u),className:"h-10 px-4 border-gray-200",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"고급 필터",u?e.jsx(pe,{className:"h-4 w-4 ml-2"}):e.jsx(he,{className:"h-4 w-4 ml-2"})]}),e.jsxs("div",{className:"ml-auto flex gap-2",children:[Object.values(l).some(t=>t&&t!=="")&&e.jsx(C,{variant:"ghost",size:"sm",onClick:()=>i({status:"",vendorId:"",projectId:"",userId:"",startDate:"",endDate:"",minAmount:"",maxAmount:"",searchText:"",page:1,limit:50}),className:"h-10",children:"필터 초기화"}),e.jsxs(C,{variant:"outline",onClick:()=>R.mutate(),disabled:R.isPending,className:"h-10 border-gray-200",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"엑셀 다운로드"]})]})]}),u&&e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"발주일 범위"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{type:"date",value:l.startDate,onChange:t=>j("startDate",t.target.value),className:"h-10 text-sm"}),e.jsx("span",{className:"text-gray-400",children:"~"}),e.jsx(S,{type:"date",value:l.endDate,onChange:t=>j("endDate",t.target.value),className:"h-10 text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"금액 범위"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{type:"number",placeholder:"최소 금액",value:l.minAmount,onChange:t=>j("minAmount",t.target.value),className:"h-10 text-sm"}),e.jsx("span",{className:"text-gray-400",children:"~"}),e.jsx(S,{type:"number",placeholder:"최대 금액",value:l.maxAmount,onChange:t=>j("maxAmount",t.target.value),className:"h-10 text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"작성자"}),e.jsxs(O,{value:l.userId||"all",onValueChange:t=>j("userId",t),children:[e.jsx(E,{className:"h-10",children:e.jsx(k,{placeholder:"모든 작성자"})}),e.jsxs(P,{children:[e.jsx(c,{value:"all",children:"모든 작성자"}),J?.map(t=>e.jsx(c,{value:t.id,children:t.name||t.email},t.id))]})]})]})]})})]})}),e.jsx(Q,{className:"shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>b("orderNumber"),className:"flex items-center gap-1 hover:text-gray-700",children:["발주번호",e.jsx(w,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>b("vendorName"),className:"flex items-center gap-1 hover:text-gray-700",children:["거래처",e.jsx(w,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>b("projectName"),className:"flex items-center gap-1 hover:text-gray-700",children:["프로젝트",e.jsx(w,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>b("orderDate"),className:"flex items-center gap-1 hover:text-gray-700",children:["발주일",e.jsx(w,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>b("totalAmount"),className:"flex items-center gap-1 hover:text-gray-700",children:["금액",e.jsx(w,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>b("status"),className:"flex items-center gap-1 hover:text-gray-700",children:["상태",e.jsx(w,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"이메일"}),e.jsx("th",{className:"px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"액션"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:X?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-6 py-12 text-center",children:e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})})}):A.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"text-gray-500",children:[e.jsx(ge,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"발주서가 없습니다."})]})})}):A.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{onClick:()=>a(`/orders/${t.id}`),className:"text-sm font-medium text-blue-600 hover:text-blue-700",children:t.orderNumber})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:t.vendorName||t.vendor?.name||"-"}),t.vendor?.email&&e.jsx("div",{className:"text-xs text-gray-500",children:t.vendor.email})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:t.projectName||t.project?.projectName||"-"}),t.project?.projectCode&&e.jsx("div",{className:"text-xs text-gray-500",children:t.project.projectCode})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:new Date(t.orderDate).toLocaleDateString("ko-KR")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-semibold text-blue-600",children:Se(t.totalAmount)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${re(t.status)}`,children:De(t.status)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:se(t)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>a(`/orders/${t.id}`),className:"text-gray-400 hover:text-blue-600 transition-colors",title:"상세보기",children:e.jsx(je,{className:"h-5 w-5"})}),f?.role==="admin"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>a(`/orders/${t.id}/edit`),className:"text-gray-400 hover:text-blue-600 transition-colors",title:"수정",children:e.jsx(Ne,{className:"h-5 w-5"})}),t.status==="approved"&&e.jsx("button",{onClick:()=>ee(t),className:"text-gray-400 hover:text-green-600 transition-colors",title:"이메일 발송",children:e.jsx(K,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>ae(t.id),className:"text-gray-400 hover:text-purple-600 transition-colors",title:"다운로드",children:e.jsx(H,{className:"h-5 w-5"})})]})]})})]},t.id))})]})})}),r&&e.jsx(Ce,{open:T,onOpenChange:y,orderData:{orderNumber:r.orderNumber,vendorName:r.vendorName||r.vendor?.name||"",vendorEmail:r.vendor?.email,orderDate:new Date(r.orderDate).toLocaleDateString(),totalAmount:r.totalAmount,siteName:r.projectName||r.project?.projectName},onSendEmail:te}),F&&e.jsx(Oe,{orderId:F.id,orderNumber:F.orderNumber,isOpen:W,onClose:()=>{G(!1),_(null)}})]})})}export{Ge as default};
