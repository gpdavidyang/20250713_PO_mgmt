# 발주서 관리 시스템 - Purchase Order Lifecycle 문서

## 개요
본 문서는 발주서 관리 시스템에서 발주서가 생성되어 완료되기까지의 전체 생명주기(Lifecycle)를 설명합니다.

## 발주서 상태 (Purchase Order Status)

발주서는 다음 5가지 상태를 가집니다:

1. **draft** (초안) - 작성 중인 발주서
2. **pending** (대기) - 승인 대기 중인 발주서
3. **approved** (승인) - 승인 완료된 발주서
4. **sent** (발송) - 거래처에 발송된 발주서
5. **completed** (완료) - 최종 완료된 발주서

## 발주서 생성 및 처리 워크플로우

### 1. 발주서 생성 방법

시스템은 두 가지 발주서 생성 방법을 제공합니다:

#### A. 수동 생성 (Manual Creation)
- **화면**: `/create-order`
- **기능**: 
  - 표준 양식을 통한 수동 입력
  - 프로젝트, 거래처, 품목 선택
  - 수량 및 단가 입력
  - 첨부파일 업로드

#### B. 엑셀 자동화 (Excel Automation) 
- **화면**: `/create-order-excel`
- **기능**: 엑셀 파일 업로드를 통한 자동 처리

### 2. 엑셀 자동화 워크플로우 (Step-by-Step)

엑셀 파일을 통한 발주서 처리는 다음 8단계로 진행됩니다:

#### Step 0: Pre-validation (사전 검증)
- 엑셀 파일 형식 검증 (.xlsx, .xlsm 지원)
- 필수 시트 존재 여부 확인
- 데이터 일관성 검증

#### Step 1: 발주 정보 추출 및 DB 저장
- **처리**: Input 시트에서 발주 정보 파싱
- **저장 데이터**:
  - 발주서 기본 정보 (프로젝트, 거래처, 날짜)
  - 품목 상세 (품명, 규격, 수량, 단가)
- **상태**: `draft`로 초기 저장

#### Step 2: Excel 파일 다운로드 및 서식 보존
- **처리**: 갑지/을지 시트 추출
- **기능**:
  - Input 시트 제거 (보안)
  - 100% 서식 보존
  - 별도 파일로 저장

#### Step 3: 거래처 정보 검증
- **화면**: 거래처 검증 모달 (VendorValidationModal)
- **기능**:
  - 기존 거래처 매칭
  - 유사 거래처 추천 (Levenshtein distance 알고리즘)
  - 신규 거래처 등록 옵션
  - 담당자 정보 확인

#### Step 4: 발주서 생성
- **처리**: 
  - PDF 생성 (워터마크 포함)
  - 암호화 설정 (거래처 사업자번호)
  - 첨부파일 준비

#### Step 5: 이메일 발송
- **화면**: 이메일 미리보기
- **기능**:
  - 수신자 확인
  - 제목/본문 편집
  - 첨부파일 확인 (PDF + Excel)
- **발송**: Naver SMTP 사용

#### Step 6: 상태 업데이트
- **변경**: `draft` → `sent`
- **기록**: 발송 시간, 발송자 정보

#### Step 7: 정리 작업
- 임시 파일 삭제
- 로그 기록
- 완료 알림

### 3. 승인 워크플로우 (Approval Workflow)

발주서는 금액에 따라 다단계 승인이 필요합니다:

#### 승인 권한 (Approval Authority)
- **현장 실무자**: 제한 없음 (초안 작성만)
- **프로젝트 매니저**: 1,000만원 이하
- **본사 관리자**: 5,000만원 이하
- **임원**: 1억원 이하
- **관리자**: 금액 제한 없음

#### 승인 프로세스
1. 작성자가 발주서 생성 (`draft`)
2. 시스템이 금액에 따라 필요 승인자 결정
3. 승인 요청 (`draft` → `pending`)
4. 승인자 검토 및 승인
5. 최종 승인 (`pending` → `approved`)

### 4. 발주서 조회 및 관리

#### 발주서 목록 (Orders List)
- **화면**: `/orders`
- **기능**:
  - 상태별 필터링
  - 프로젝트/거래처별 검색
  - 날짜 범위 검색
  - 페이지네이션

#### 발주서 상세 (Order Detail)
- **화면**: `/order/:id`
- **기능**:
  - 발주서 상세 정보 조회
  - 첨부파일 다운로드
  - 상태 이력 확인
  - 인쇄/PDF 출력

#### 발주서 수정 (Order Edit)
- **화면**: `/order/:id/edit`
- **권한**: 작성자 또는 관리자
- **제한**: `sent` 상태 이후 수정 불가

### 5. 대시보드 및 통계

#### 대시보드 (Dashboard)
- **화면**: `/dashboard`
- **표시 정보**:
  - 상태별 발주서 현황
  - 월별 발주 금액 추이
  - 거래처별 발주 현황
  - 승인 대기 건수

### 6. 데이터베이스 구조

#### 주요 테이블
- **purchaseOrders**: 발주서 기본 정보
- **purchaseOrderItems**: 발주 품목 상세
- **orderHistory**: 상태 변경 이력
- **orderAttachments**: 첨부 파일 정보

### 7. API 엔드포인트

#### 발주서 관리
- `GET /api/orders` - 발주서 목록 조회
- `GET /api/orders/:id` - 발주서 상세 조회
- `POST /api/orders` - 발주서 생성
- `PUT /api/orders/:id` - 발주서 수정
- `DELETE /api/orders/:id` - 발주서 삭제

#### 엑셀 자동화
- `POST /api/excel-automation/upload-and-process` - 엑셀 업로드 및 처리
- `POST /api/excel-automation/validate-vendors` - 거래처 검증
- `POST /api/excel-automation/update-email-preview` - 이메일 미리보기
- `POST /api/excel-automation/send-emails` - 이메일 발송
- `GET /api/excel-automation/download/:filename` - 파일 다운로드

### 8. 보안 및 권한

#### 인증 (Authentication)
- Passport.js 기반 세션 인증
- 로그인 필수 API 보호

#### 권한 (Authorization)
- 역할 기반 접근 제어 (RBAC)
- 발주서 작성자/승인자 권한 분리
- 금액별 승인 권한 제한

### 9. 주요 기능 특징

#### 서식 보존
- ZIP 구조 직접 조작으로 100% Excel 서식 유지
- Input 시트만 제거하여 원본 보존

#### 거래처 관리
- 지능형 거래처 추천 시스템
- 유사도 기반 매칭 알고리즘
- 신규 거래처 자동 등록

#### 이메일 자동화
- 템플릿 기반 이메일 생성
- 다중 첨부파일 지원
- 발송 이력 관리

#### 감사 추적 (Audit Trail)
- 모든 상태 변경 기록
- 사용자별 활동 이력
- 시간별 추적 가능

## 결론

본 시스템은 발주서의 전체 생명주기를 체계적으로 관리하며, 특히 엑셀 자동화를 통해 업무 효율성을 극대화합니다. 각 단계별 검증과 승인 프로세스를 통해 정확성과 신뢰성을 보장합니다.