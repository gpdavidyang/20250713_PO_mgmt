import{c as te,d as se,u as re,L as ae,r as k,M as I,H as ie,j as e,B as j,N as F,O as A,V as M,W as R,Y as D,I as g,P as ne,J as y,K as z}from"./index-Bxo91dQJ.js";import{T as le}from"./textarea-xW8V1eop.js";import{S as v,a as N,b as f,c as b,d as u}from"./select-DITSu2gt.js";import{T as de,a as oe,b as G,c as o,d as ce,e as c}from"./table-BrLtz-r1.js";import{i as me}from"./authUtils-CcDzk6i0.js";import{A as ue}from"./arrow-left-D36VIAEm.js";import{S as xe}from"./square-pen-Sp1mYrCs.js";import{T as he}from"./trash-2-NsyjHNY3.js";import{S as je}from"./save-CoeA_lGj.js";import"./index-NWOD9p8K.js";import"./chevron-down-B3-VaMXF.js";import"./chevron-up-BFY9GLfl.js";function we(){te();const{toast:S}=se(),[ge,p]=re(),$=ae(),l=$.id;console.log("OrderEdit params:",$),console.log("OrderEdit orderId:",l,typeof l);const[i,d]=k.useState({projectId:"",vendorId:"",orderDate:"",deliveryDate:"",notes:"",templateId:"",items:[]}),{data:a,isLoading:O,error:T}=I({queryKey:[`/api/orders/${l}`],queryFn:()=>y("GET",`/api/orders/${l}`),enabled:!!l});console.log("OrderEdit Debug:",{orderId:l,order:a,orderLoading:O,orderError:T,enabled:!!l});const{data:H}=I({queryKey:["/api/vendors"],queryFn:()=>y("GET","/api/vendors")}),{data:U}=I({queryKey:["/api/projects"],queryFn:()=>y("GET","/api/projects")}),{data:w}=I({queryKey:["/api/categories"],queryFn:()=>y("GET","/api/categories")}),K=w?.categories||[],C=w?.flatCategories||[];console.log("Categories data:",w),console.log("Categories (hierarchical):",K),console.log("Flat categories:",C);const{data:B}=I({queryKey:["/api/items"],queryFn:()=>y("GET","/api/items")}),x=B?.items||[];k.useEffect(()=>{if(a&&x.length>0){const s=(a.items||[]).map(r=>{let t=null;return t=x.find(n=>n.name===r.itemName),t||(t=x.find(n=>n.name.includes(r.itemName)||r.itemName.includes(n.name))),!t&&r.itemId&&(t=x.find(n=>n.id===r.itemId)),{itemId:t?.id||null,itemName:r.itemName||"",quantity:parseFloat(r.quantity)||1,unitPrice:parseFloat(r.unitPrice)||0,specification:r.specification||"",notes:r.notes||"",unit:r.unit||"EA",majorCategory:r.majorCategory||"",middleCategory:r.middleCategory||"",minorCategory:r.minorCategory||""}});d({projectId:a.projectId?.toString()||"",vendorId:a.vendorId?.toString()||"",orderDate:a.orderDate?new Date(a.orderDate).toISOString().split("T")[0]:"",deliveryDate:a.deliveryDate?new Date(a.deliveryDate).toISOString().split("T")[0]:"",notes:a.notes||"",templateId:a.templateId?.toString()||"",items:s})}else a&&x.length===0&&d({projectId:a.projectId?.toString()||"",vendorId:a.vendorId?.toString()||"",orderDate:a.orderDate?new Date(a.orderDate).toISOString().split("T")[0]:"",deliveryDate:a.deliveryDate?new Date(a.deliveryDate).toISOString().split("T")[0]:"",notes:a.notes||"",templateId:a.templateId?.toString()||"",items:a.items||[]})},[a,x]);const E=ie({mutationFn:async s=>await y("PATCH",`/api/orders/${l}`,s),onSuccess:()=>{S({title:"성공",description:"발주서가 수정되었습니다."}),z.invalidateQueries({queryKey:[`/api/orders/${l}`]}),z.invalidateQueries({queryKey:["/api/orders"]}),p(`/orders/${l}`)},onError:s=>{if(me(s)){S({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{p("/login")},500);return}S({title:"오류",description:"발주서 수정에 실패했습니다.",variant:"destructive"})}}),Q=s=>{if(s.preventDefault(),!i.vendorId||!i.orderDate||i.items.length===0){S({title:"오류",description:"모든 필수 필드를 입력해주세요.",variant:"destructive"});return}const r={projectId:i.projectId?parseInt(i.projectId):null,vendorId:parseInt(i.vendorId),orderDate:new Date(i.orderDate),deliveryDate:i.deliveryDate?new Date(i.deliveryDate):null,notes:i.notes,templateId:i.templateId?parseInt(i.templateId):null,items:i.items.map(t=>({itemId:t.itemId,itemName:t.itemName,quantity:Number(t.quantity),unitPrice:Number(t.unitPrice),specification:t.specification||"",notes:t.notes||"",unit:t.unit||"EA",majorCategory:t.majorCategory||"",middleCategory:t.middleCategory||"",minorCategory:t.minorCategory||""}))};E.mutate(r)},Y=()=>{d(s=>({...s,items:[...s.items,{itemId:null,itemName:"",quantity:1,unitPrice:0,specification:"",notes:"",unit:"EA",majorCategory:"",middleCategory:"",minorCategory:""}]}))},J=s=>{d(r=>({...r,items:r.items.filter((t,n)=>n!==s)}))},m=(s,r,t)=>{d(n=>({...n,items:n.items.map((h,q)=>q===s?{...h,[r]:t}:h)}))},W=(s,r)=>{const t=x.find(n=>n.id.toString()===r);t&&(m(s,"itemId",t.id),m(s,"itemName",t.name),m(s,"unitPrice",t.unitPrice||0),m(s,"specification",t.specification||""))},_=()=>{const s=K||[];return console.log("getMajorCategories result:",s),s},X=s=>{if(!s)return[];const r=C.find(t=>t.categoryType==="major"&&t.categoryName===s);return r?C.filter(t=>t.categoryType==="middle"&&t.parentId===r.id):[]},Z=s=>{if(!s)return[];const r=C.find(t=>t.categoryType==="middle"&&t.categoryName===s);return r?C.filter(t=>t.categoryType==="minor"&&t.parentId===r.id):[]},P=(s,r,t)=>{console.log(`Category change: index=${s}, type=${r}, value=${t}`);const n={},h=t==="none"?"":t;console.log(`Actual value after conversion: ${h}`),r==="major"?(n.majorCategory=h,n.middleCategory="",n.minorCategory=""):r==="middle"?(n.middleCategory=h,n.minorCategory=""):r==="minor"&&(n.minorCategory=h),console.log("Updates to apply:",n),d(q=>{const L=q.items.map((V,ee)=>ee===s?{...V,...n}:V);return console.log(`Updated item ${s}:`,L[s]),{...q,items:L}})};return O?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4 mb-6"}),e.jsx("div",{className:"h-96 bg-gray-200 rounded"})]})}):T?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서 로드 중 오류가 발생했습니다"}),e.jsx("p",{className:"mb-4 text-red-600",children:T.message}),e.jsx(j,{onClick:()=>p("/orders"),children:"발주서 목록으로 돌아가기"})]})}):a?e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>p(`/orders/${l}`),children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"돌아가기"]}),e.jsx(xe,{className:"h-6 w-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"발주서 수정"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"발주서 정보를 수정합니다"})]})]})})}),e.jsxs("form",{onSubmit:Q,children:[a&&e.jsx(F,{className:"mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsx(A,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"발주서 번호"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:a.orderNumber||"N/A"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"현재 상태"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:a.status||"N/A"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"생성일시"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:a.createdAt?new Date(a.createdAt).toLocaleString("ko-KR"):"N/A"})]})]})})}),e.jsxs(F,{className:"mb-6",children:[e.jsx(M,{children:e.jsx(R,{children:"기본 정보"})}),e.jsxs(A,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"project",children:"프로젝트"}),e.jsxs(v,{value:i.projectId,onValueChange:s=>d(r=>({...r,projectId:s})),children:[e.jsx(N,{children:e.jsx(f,{placeholder:"프로젝트를 선택하세요"})}),e.jsx(b,{children:U?.map(s=>e.jsx(u,{value:s.id.toString(),children:s.projectName},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"vendor",children:"거래처 *"}),e.jsxs(v,{value:i.vendorId,onValueChange:s=>d(r=>({...r,vendorId:s})),children:[e.jsx(N,{children:e.jsx(f,{placeholder:"거래처를 선택하세요"})}),e.jsx(b,{children:H?.map(s=>e.jsx(u,{value:s.id.toString(),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"orderDate",children:"발주일자 *"}),e.jsx(g,{id:"orderDate",type:"date",value:i.orderDate,onChange:s=>d(r=>({...r,orderDate:s.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"deliveryDate",children:"납품희망일"}),e.jsx(g,{id:"deliveryDate",type:"date",value:i.deliveryDate,onChange:s=>d(r=>({...r,deliveryDate:s.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"notes",children:"비고"}),e.jsx(le,{id:"notes",placeholder:"추가 정보나 요청사항을 입력하세요",value:i.notes,onChange:s=>d(r=>({...r,notes:s.target.value})),rows:3})]})]})]}),e.jsxs(F,{className:"mb-6",children:[e.jsx(M,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(R,{children:"발주 품목"}),e.jsxs(j,{type:"button",onClick:Y,children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"품목 추가"]})]})}),e.jsxs(A,{children:[i.items.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"발주할 품목을 추가해주세요"}):e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(G,{children:[e.jsx(o,{children:"품목명 *"}),e.jsx(o,{children:"대분류"}),e.jsx(o,{children:"중분류"}),e.jsx(o,{children:"소분류"}),e.jsx(o,{children:"수량 *"}),e.jsx(o,{children:"단위"}),e.jsx(o,{children:"단가"}),e.jsx(o,{children:"규격"}),e.jsx(o,{children:"비고"}),e.jsx(o,{children:"총액"}),e.jsx(o,{className:"w-[100px]",children:"작업"})]})}),e.jsx(ce,{children:i.items.map((s,r)=>e.jsxs(G,{children:[e.jsx(c,{children:e.jsxs(v,{value:s.itemId?.toString()||"",onValueChange:t=>W(r,t),children:[e.jsx(N,{children:e.jsx(f,{placeholder:s.itemName||"품목 선택"})}),e.jsx(b,{children:x.map(t=>e.jsx(u,{value:t.id.toString(),children:t.name},t.id))})]})}),e.jsx(c,{children:e.jsxs(v,{value:s.majorCategory||"none",onValueChange:t=>{console.log(`Select onValueChange triggered: ${t}`),P(r,"major",t)},children:[e.jsx(N,{className:"min-w-[120px]",children:e.jsx(f,{placeholder:"대분류 선택"})}),e.jsxs(b,{children:[e.jsx(u,{value:"none",children:"선택 해제"}),_().map(t=>(console.log("Rendering major category:",t),e.jsx(u,{value:t.categoryName,children:t.categoryName},t.id)))]})]})}),e.jsx(c,{children:e.jsxs(v,{value:s.middleCategory||"none",onValueChange:t=>P(r,"middle",t),disabled:!s.majorCategory,children:[e.jsx(N,{className:"min-w-[120px]",children:e.jsx(f,{placeholder:s.majorCategory?"중분류 선택":"대분류 먼저 선택"})}),e.jsxs(b,{children:[e.jsx(u,{value:"none",children:"선택 해제"}),X(s.majorCategory||"").map(t=>e.jsx(u,{value:t.categoryName,children:t.categoryName},t.id))]})]})}),e.jsx(c,{children:e.jsxs(v,{value:s.minorCategory||"none",onValueChange:t=>P(r,"minor",t),disabled:!s.middleCategory,children:[e.jsx(N,{className:"min-w-[120px]",children:e.jsx(f,{placeholder:s.middleCategory?"소분류 선택":"중분류 먼저 선택"})}),e.jsxs(b,{children:[e.jsx(u,{value:"none",children:"선택 해제"}),Z(s.middleCategory||"").map(t=>e.jsx(u,{value:t.categoryName,children:t.categoryName},t.id))]})]})}),e.jsx(c,{children:e.jsx(g,{type:"number",value:s.quantity,onChange:t=>m(r,"quantity",Number(t.target.value)),min:"1",required:!0})}),e.jsx(c,{children:e.jsx(g,{value:s.unit||"",onChange:t=>m(r,"unit",t.target.value),placeholder:"단위"})}),e.jsx(c,{children:e.jsx(g,{type:"number",value:s.unitPrice,onChange:t=>m(r,"unitPrice",Number(t.target.value)),min:"0"})}),e.jsx(c,{children:e.jsx(g,{value:s.specification,onChange:t=>m(r,"specification",t.target.value),placeholder:"규격 입력"})}),e.jsx(c,{children:e.jsx(g,{value:s.notes,onChange:t=>m(r,"notes",t.target.value),placeholder:"비고 입력"})}),e.jsxs(c,{children:["₩",(Number(s.quantity)*Number(s.unitPrice)).toLocaleString("ko-KR")]}),e.jsx(c,{children:e.jsx(j,{type:"button",variant:"ghost",size:"sm",onClick:()=>J(r),children:e.jsx(he,{className:"h-4 w-4 text-red-500"})})})]},r))})]}),i.items.length>0&&e.jsx("div",{className:"mt-6 space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"총 품목 수"}),e.jsxs("div",{className:"text-xl font-bold text-blue-700",children:[i.items.length,"개"]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"총 수량"}),e.jsx("div",{className:"text-xl font-bold text-green-700",children:i.items.reduce((s,r)=>s+(Number(r.quantity)||0),0)})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-purple-600 mb-1",children:"대분류 수"}),e.jsxs("div",{className:"text-xl font-bold text-purple-700",children:[new Set(i.items.map(s=>s.majorCategory).filter(s=>s)).size,"개"]})]}),e.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-orange-600 mb-1",children:"총 합계 금액"}),e.jsxs("div",{className:"text-xl font-bold text-orange-700",children:["₩",i.items.reduce((s,r)=>{const t=(Number(r.quantity)||0)*(Number(r.unitPrice)||0);return s+t},0).toLocaleString()]})]})]})})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>p(`/orders/${l}`),children:"취소"}),e.jsxs(j,{type:"submit",disabled:E.isPending,children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),E.isPending?"저장 중...":"저장"]})]})]})]}):e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서를 찾을 수 없습니다"}),e.jsxs("p",{className:"mb-4 text-gray-600",children:["OrderID: ",l]}),e.jsx(j,{onClick:()=>p("/orders"),children:"발주서 목록으로 돌아가기"})]})})}export{we as default};
