import{r as f,j as e,M as U,o as E,Q as Z,s as k,b as I,i as H,B as O,as as W,N as _,k as R,I as ee,c as se,u as te,d as ae,G as ie,Y as z}from"./index-CdUdiWMQ.js";import{A as K,a as L}from"./alert-CxBXqo1p.js";import{P as re}from"./progress-BADuZ9AB.js";import{r as le,u as ne}from"./xlsx-ocdEQCFM.js";import{T as ce}from"./textarea-D7lHLy60.js";import{P as T}from"./package-zULVzgkm.js";import{M as oe}from"./mail-BIG-56Gt.js";import{C as de}from"./calendar-Bvzq8Xd1.js";import{H as me}from"./hash-D8euL505.js";import{D as M}from"./dollar-sign-DGIiEZg3.js";import{P as he}from"./pen-line-DrSaXxDU.js";import{U as pe}from"./upload-B2uqQyjg.js";import{S as ue}from"./save-DmsAx1BM.js";function xe({orders:b,onOrderUpdate:u,onOrderRemove:F}){const[j,y]=f.useState(null),[P,v]=f.useState(""),q=(a,s)=>{y(a),v(s||"")},w=(a,s,r)=>{const n={...b[a]},x=s.split(".");let p=n;for(let o=0;o<x.length-1;o++){const S=x[o];if(S==="items"){const $=parseInt(x[o+1]);p=n.items[$],o++}else p=p[S]}const h=x[x.length-1];if(["quantity","unitPrice","totalAmount"].includes(h)?p[h]=parseFloat(r)||0:p[h]=r,h==="quantity"||h==="unitPrice"){const o=p;o.quantity&&o.unitPrice&&(o.totalAmount=o.quantity*o.unitPrice)}n.errors=[],n.projectName||n.errors.push("프로젝트명 필수"),n.vendorName||n.errors.push("거래처명 필수"),n.vendorEmail||n.errors.push("거래처 이메일 필수"),n.items.length===0&&n.errors.push("품목 필수"),n.isValid=n.errors.length===0,u(a,n),y(null)},C=()=>{y(null),v("")},D=(a,s,r)=>{a.key==="Enter"&&!a.shiftKey?(a.preventDefault(),w(s,r,P)):a.key==="Escape"&&C()},c=({fieldId:a,value:s,orderIndex:r,fieldPath:l,placeholder:n,type:x="text",multiline:p=!1,icon:h,className:o=""})=>{if(j===a){const $=p?ce:ee;return e.jsxs("div",{className:"flex items-start gap-2",children:[h&&e.jsx("div",{className:"mt-2 text-gray-400",children:h}),e.jsx($,{type:x,value:P,onChange:N=>v(N.target.value),onKeyDown:N=>D(N,r,l),onBlur:()=>w(r,l,P),placeholder:n,className:E("flex-1",o),autoFocus:!0})]})}return e.jsxs("div",{className:E("flex items-start gap-2 p-2 rounded cursor-pointer hover:bg-gray-50 transition-colors group",!s&&"text-gray-400"),onClick:()=>q(a,s),children:[h&&e.jsx("div",{className:"text-gray-400 group-hover:text-gray-600",children:h}),e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:E(!s&&"italic"),children:s||n})}),e.jsx(he,{className:"h-3 w-3 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"})]})};return e.jsxs("div",{className:"space-y-6",children:[b.map((a,s)=>e.jsxs(U,{className:E("relative transition-all",a.isValid===!1&&"border-red-300 bg-red-50"),children:[e.jsx(Z,{className:"pb-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(k,{variant:"outline",children:["#",s+1]}),e.jsx(k,{variant:a.isValid?"default":"destructive",children:a.isValid?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),"유효"]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),"검증 필요"]})}),a.items.length>0&&e.jsxs(k,{variant:"secondary",children:[e.jsx(T,{className:"h-3 w-3 mr-1"}),a.items.length,"개 품목"]})]}),a.errors&&a.errors.length>0&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:a.errors.join(", ")})]}),e.jsx(O,{variant:"ghost",size:"icon",onClick:()=>F(s),className:"text-gray-400 hover:text-red-600",children:e.jsx(W,{className:"h-4 w-4"})})]})}),e.jsxs(_,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{fieldId:`order-${s}-project`,value:a.projectName,orderIndex:s,fieldPath:"projectName",placeholder:"프로젝트명 입력",icon:e.jsx(R,{className:"h-4 w-4"})}),e.jsx(c,{fieldId:`order-${s}-vendor`,value:a.vendorName,orderIndex:s,fieldPath:"vendorName",placeholder:"거래처명 입력",icon:e.jsx(R,{className:"h-4 w-4"})}),e.jsx(c,{fieldId:`order-${s}-email`,value:a.vendorEmail,orderIndex:s,fieldPath:"vendorEmail",placeholder:"거래처 이메일 입력",type:"email",icon:e.jsx(oe,{className:"h-4 w-4"})}),e.jsx(c,{fieldId:`order-${s}-delivery`,value:a.deliveryDate,orderIndex:s,fieldPath:"deliveryDate",placeholder:"납기일 입력",icon:e.jsx(de,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4"}),"품목 정보"]}),a.items.map((r,l)=>e.jsxs("div",{className:"border rounded-lg p-3 space-y-3 bg-gray-50",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(c,{fieldId:`order-${s}-item-${l}-name`,value:r.itemName,orderIndex:s,fieldPath:`items.${l}.itemName`,placeholder:"품목명"}),e.jsx(c,{fieldId:`order-${s}-item-${l}-spec`,value:r.specification,orderIndex:s,fieldPath:`items.${l}.specification`,placeholder:"규격"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(c,{fieldId:`order-${s}-item-${l}-unit`,value:r.unit,orderIndex:s,fieldPath:`items.${l}.unit`,placeholder:"단위"}),e.jsx(c,{fieldId:`order-${s}-item-${l}-qty`,value:r.quantity,orderIndex:s,fieldPath:`items.${l}.quantity`,placeholder:"수량",type:"number",icon:e.jsx(me,{className:"h-4 w-4"})}),e.jsx(c,{fieldId:`order-${s}-item-${l}-price`,value:r.unitPrice,orderIndex:s,fieldPath:`items.${l}.unitPrice`,placeholder:"단가",type:"number",icon:e.jsx(M,{className:"h-4 w-4"})}),e.jsx("div",{className:"p-2 bg-white rounded border",children:e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(M,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:((r.quantity||0)*(r.unitPrice||0)).toLocaleString()})]})})]}),r.remarks&&e.jsx(c,{fieldId:`order-${s}-item-${l}-remarks`,value:r.remarks,orderIndex:s,fieldPath:`items.${l}.remarks`,placeholder:"비고",multiline:!0})]},l))]}),a.notes&&e.jsx(c,{fieldId:`order-${s}-notes`,value:a.notes,orderIndex:s,fieldPath:"notes",placeholder:"전체 비고",multiline:!0,className:"min-h-[60px]"})]})]},s)),b.length===0&&e.jsx("div",{className:"text-center py-12 text-gray-500",children:"업로드된 발주서가 없습니다."})]})}function De(){se();const[,b]=te(),{toast:u}=ae(),F=f.useRef(null),[j,y]=f.useState(null),[P,v]=f.useState(!1),[q,w]=f.useState([]),[C,D]=f.useState(!1),[c,a]=f.useState(0),[s,r]=f.useState([]),l=t=>{t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?v(!0):t.type==="dragleave"&&v(!1)},n=t=>{if(t.preventDefault(),t.stopPropagation(),v(!1),t.dataTransfer.files&&t.dataTransfer.files[0]){const i=t.dataTransfer.files[0];p(i)}},x=t=>{t.target.files&&t.target.files[0]&&p(t.target.files[0])},p=t=>{const i=t.name.toLowerCase();if(!i.endsWith(".xlsx")&&!i.endsWith(".xls")&&!i.endsWith(".xlsm")){u({title:"파일 형식 오류",description:"엑셀 파일(.xlsx, .xls, .xlsm)만 업로드 가능합니다.",variant:"destructive"});return}y(t),h(t)},h=async t=>{D(!0),a(20);try{const i=await t.arrayBuffer();a(40);const d=le(i,{type:"array"});a(60);const g=d.SheetNames[0],V=d.Sheets[g],X=ne.sheet_to_json(V,{header:1});a(80);const Y=X.slice(1).filter(m=>m&&m.some(B=>B)).map((m,B)=>({rowIndex:B+2,projectName:m[0]?.toString().trim(),vendorName:m[1]?.toString().trim(),vendorEmail:m[2]?.toString().trim(),deliveryDate:m[3]?.toString().trim(),items:[{itemName:m[4]?.toString().trim(),specification:m[5]?.toString().trim(),unit:m[6]?.toString().trim(),quantity:parseFloat(m[7])||0,unitPrice:parseFloat(m[8])||0,totalAmount:parseFloat(m[9])||0,remarks:m[10]?.toString().trim()}],notes:m[11]?.toString().trim(),isValid:!0,errors:[]})),A=o(Y);w(A),r(A),a(100),u({title:"엑셀 파일 로딩 완료",description:`발주서 생성을 위해 ${A.length}개의 데이터가 성공적으로 로드되었습니다. 각 항목을 확인하고 수정한 후 '모두 저장' 버튼을 클릭하세요.`})}catch(i){console.error("Excel parsing error:",i),u({title:"파일 파싱 실패",description:"엑셀 파일을 읽는 중 오류가 발생했습니다.",variant:"destructive"})}finally{D(!1),setTimeout(()=>a(0),1e3)}},o=t=>{const i=new Map;return t.forEach(d=>{const g=`${d.projectName}-${d.vendorName}`;i.has(g)?i.get(g).items.push(...d.items):i.set(g,{...d})}),Array.from(i.values())},S=(t,i)=>{const d=[...s];d[t]=i,r(d)},$=t=>{const i=s.filter((d,g)=>g!==t);r(i),u({title:"발주서 생성 완료",description:"성공적으로 발주서가 생성되어 작성 목록에서 제거되었습니다. 생성된 발주서는 발주서 관리 화면에서 확인할 수 있습니다."})},N=ie({mutationFn:async t=>{const i=new FormData;j&&i.append("excelFile",j),i.append("orders",JSON.stringify(t));const d=await fetch("/api/orders/bulk-create-simple",{method:"POST",credentials:"include",body:i});if(!d.ok){const g=await d.text();throw new Error(g||"Failed to save orders")}return d.json()},onSuccess:t=>{u({title:"저장 완료",description:`${t.savedCount}개의 발주서가 성공적으로 저장되었습니다.`}),setTimeout(()=>b("/orders"),1500)},onError:t=>{u({title:"저장 실패",description:t.message||"발주서 저장 중 오류가 발생했습니다.",variant:"destructive"})}}),G=()=>{const t=s.filter(i=>i.isValid!==!1);if(t.length===0){u({title:"저장할 수 없음",description:"유효한 발주서가 없습니다.",variant:"destructive"});return}N.mutate(t)},J=()=>{y(null),w([]),r([]),a(0)},Q=()=>{F.current?.click()};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-6 pb-20",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"h-6 w-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"엑셀 심플 업로드"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"검증 없이 엑셀 데이터를 바로 편집 가능한 발주서로 변환합니다"})]})]}),s.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(k,{variant:"secondary",className:"px-3 py-1",children:[e.jsx(T,{className:"h-3 w-3 mr-1"}),s.length,"개 발주서"]}),e.jsxs(k,{variant:"outline",className:"px-3 py-1",children:[s.reduce((t,i)=>t+i.items.length,0),"개 품목"]})]})]})}),s.length===0&&e.jsx(U,{children:e.jsxs(_,{className:"p-8",children:[e.jsx("input",{ref:F,type:"file",accept:".xlsx,.xls,.xlsm",onChange:x,className:"hidden"}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-12 text-center transition-colors ${P?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`,onDragEnter:l,onDragLeave:l,onDragOver:l,onDrop:n,children:[e.jsx(pe,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium text-gray-700",children:"엑셀 파일을 드래그하거나 클릭하여 업로드"}),e.jsx("p",{className:"text-sm text-gray-500",children:".xlsx, .xls, .xlsm 파일 지원"})]}),e.jsx(O,{onClick:Q,disabled:C,className:"mt-6",size:"lg",children:C?"처리 중...":"파일 선택"})]}),c>0&&e.jsxs("div",{className:"mt-6 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600",children:[e.jsx("span",{children:"파일 처리 중..."}),e.jsxs("span",{children:[c,"%"]})]}),e.jsx(re,{value:c,className:"h-2"})]}),j&&e.jsxs(K,{className:"mt-6",children:[e.jsx(z,{className:"h-4 w-4"}),e.jsxs(L,{children:[e.jsx("strong",{children:j.name})," (",(j.size/1024).toFixed(1)," KB)"]})]})]})}),s.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sticky top-0 z-10 bg-white border rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(O,{onClick:G,disabled:N.isPending,size:"lg",className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),N.isPending?"저장 중...":"모두 저장"]}),e.jsxs(O,{onClick:J,variant:"outline",size:"lg",children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"초기화"]})]}),e.jsxs(K,{className:"max-w-md",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx(L,{className:"text-xs",children:"각 카드의 필드를 클릭하여 직접 수정할 수 있습니다. 모든 수정이 완료되면 '모두 저장'을 클릭하세요."})]})]})}),e.jsx(xe,{orders:s,onOrderUpdate:S,onOrderRemove:$})]})]})})}export{De as default};
