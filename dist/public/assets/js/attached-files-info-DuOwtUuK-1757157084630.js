import{c as re,e as ne,g as pe,r as k,p as ce,q as M,j as e,s as Z,G as J,H as X,F as P,t as Y,B as p,J as u,I as S,n as h,A as O,X as G,k as b,x as A,bq as de,P as Ne,a as be,d as we,h as De,N as oe,U as qe,w as W}from"./index-C_jNirXW-1757157084630.js";import{S as z,a as B,b as H,c as U,d as F}from"./select-B2Kh59Up-1757157084630.js";import{T as L}from"./textarea-BY7wwqPk-1757157084630.js";import{D as ee,f as Se,a as se,b as te,c as ae}from"./dialog-Bis615mm-1757157084630.js";import{U as Fe}from"./upload-BthZPoJL-1757157084630.js";import{C as ie}from"./calendar-DMq-q6dG-1757157084630.js";import{D as xe}from"./dollar-sign-BCvOd-SE-1757157084630.js";import{f as I}from"./format-CP3yBMIS-1757157084630.js";import{C as ue}from"./checkbox-vwCxpN3X-1757157084630.js";import{P as me}from"./package-B8pd5py--1757157084630.js";import{T as ge}from"./trash-2-BwcDep9K-1757157084630.js";import{T as ke}from"./triangle-alert-BrzyERYq-1757157084630.js";import{A as Ce,f as Te,a as Ie,b as Me,c as Qe,d as $e,e as Ae,g as Re,h as Pe}from"./alert-dialog-C2uwwXMk-1757157084630.js";import{D as Ee}from"./download-MAbNT2z1-1757157084630.js";import{I as Ke}from"./info-Ddms7Smy-1757157084630.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=re("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=re("ReceiptText",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z",key:"q3az6g"}],["path",{d:"M14 8H8",key:"1l3xfs"}],["path",{d:"M16 12H8",key:"1fr5h0"}],["path",{d:"M13 16H8",key:"wsln4y"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=re("Receipt",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z",key:"q3az6g"}],["path",{d:"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8",key:"1h4pet"}],["path",{d:"M12 17.5v-11",key:"1jc1ny"}]]);function ts({orderId:m}){const{toast:c}=ne(),g=pe(),[j,Q]=k.useState(!1),[r,N]=k.useState(null),{data:y=[],isLoading:R}=ce({queryKey:["/api/invoices",m],queryFn:async()=>await(await b("GET",`/api/invoices?orderId=${m}`)).json()}),{data:q=[]}=ce({queryKey:["/api/verification-logs",m],queryFn:async()=>await(await b("GET",`/api/verification-logs?orderId=${m}`)).json()}),v=M({mutationFn:async s=>{const n=await fetch("/api/invoices",{method:"POST",body:s});if(!n.ok)throw new Error("Failed to upload invoice");return n.json()},onSuccess:()=>{g.invalidateQueries({queryKey:["/api/invoices",m]}),g.invalidateQueries({queryKey:["/api/verification-logs",m]}),Q(!1),N(null),c({title:"성공",description:"청구서가 업로드되었습니다."})},onError:()=>{c({title:"오류",description:"청구서 업로드에 실패했습니다.",variant:"destructive"})}}),w=M({mutationFn:async s=>await(await b("POST",`/api/invoices/${s}/verify`)).json(),onSuccess:()=>{g.invalidateQueries({queryKey:["/api/invoices",m]}),g.invalidateQueries({queryKey:["/api/verification-logs",m]}),c({title:"성공",description:"청구서가 검증되었습니다."})},onError:()=>{c({title:"오류",description:"청구서 검증에 실패했습니다.",variant:"destructive"})}}),D=M({mutationFn:async s=>await(await b("POST",`/api/invoices/${s}/issue-tax`)).json(),onSuccess:()=>{g.invalidateQueries({queryKey:["/api/invoices",m]}),c({title:"성공",description:"세금계산서가 발행되었습니다."})},onError:()=>{c({title:"오류",description:"세금계산서 발행에 실패했습니다.",variant:"destructive"})}}),f=M({mutationFn:async s=>await(await b("POST",`/api/invoices/${s}/cancel-tax`)).json(),onSuccess:()=>{g.invalidateQueries({queryKey:["/api/invoices",m]}),c({title:"성공",description:"세금계산서 발행이 취소되었습니다."})},onError:()=>{c({title:"오류",description:"세금계산서 발행 취소에 실패했습니다.",variant:"destructive"})}}),E=s=>{s.preventDefault();const n=new FormData(s.currentTarget);n.set("orderId",m.toString()),r&&n.set("file",r),v.mutate(n)},a=s=>{switch(s){case"pending":return e.jsx(h,{variant:"secondary",children:"검토중"});case"verified":return e.jsx(h,{variant:"default",children:"검증완료"});case"paid":return e.jsx(h,{variant:"outline",children:"지급완료"});default:return e.jsx(h,{variant:"secondary",children:s})}},d=s=>{switch(s){case"invoice":return e.jsx(h,{variant:"outline",children:"청구서"});case"tax_invoice":return e.jsx(h,{variant:"outline",children:"세금계산서"});default:return e.jsx(h,{variant:"outline",children:s})}};return R?e.jsxs(Z,{children:[e.jsx(J,{children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-5 w-5"}),"청구서 관리"]})}),e.jsx(Y,{children:e.jsx("div",{className:"text-center py-4",children:"로딩 중..."})})]}):e.jsxs(Z,{children:[e.jsx(J,{className:"pb-2",children:e.jsxs(X,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(P,{className:"h-4 w-4"}),"청구서 관리"]}),e.jsxs(ee,{open:j,onOpenChange:Q,children:[e.jsx(Se,{asChild:!0,children:e.jsxs(p,{size:"sm",children:[e.jsx(Fe,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"청구서 업로드"})]})}),e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:"청구서 업로드"})}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"invoiceNumber",children:"청구서 번호"}),e.jsx(S,{id:"invoiceNumber",name:"invoiceNumber",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"invoiceType",children:"유형"}),e.jsxs(z,{name:"invoiceType",defaultValue:"invoice",children:[e.jsx(B,{children:e.jsx(H,{})}),e.jsxs(U,{children:[e.jsx(F,{value:"invoice",children:"청구서"}),e.jsx(F,{value:"tax_invoice",children:"세금계산서"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"issueDate",children:"발행일"}),e.jsx(S,{id:"issueDate",name:"issueDate",type:"date",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"dueDate",children:"마감일"}),e.jsx(S,{id:"dueDate",name:"dueDate",type:"date"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"totalAmount",children:"총금액"}),e.jsx(S,{id:"totalAmount",name:"totalAmount",type:"number",step:"0.01",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"vatAmount",children:"부가세"}),e.jsx(S,{id:"vatAmount",name:"vatAmount",type:"number",step:"0.01",defaultValue:"0"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"file",children:"첨부파일"}),e.jsx(S,{id:"file",type:"file",accept:".pdf,.jpg,.jpeg,.png",onChange:s=>N(s.target.files?.[0]||null)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"notes",children:"메모"}),e.jsx(L,{id:"notes",name:"notes",rows:3})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>Q(!1),children:"취소"}),e.jsx(p,{type:"submit",disabled:v.isPending,children:v.isPending?"업로드 중...":"업로드"})]})]})]})]})]})}),e.jsxs(Y,{className:"p-3",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"border-2 border-blue-200 rounded-lg p-3 bg-blue-50 dark:bg-blue-900/20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-semibold text-blue-800 dark:text-blue-200",children:"세금계산서 발행 관리"}),y.length===0?e.jsx(h,{variant:"outline",className:"text-xs border-blue-300 text-blue-700",children:"청구서 업로드 필요"}):y.some(s=>s.taxInvoiceIssued)?e.jsxs(h,{variant:"default",className:"text-xs bg-green-600",children:[e.jsx(he,{className:"h-2 w-2 mr-1"}),"발행완료"]}):e.jsx(h,{variant:"secondary",className:"text-xs",children:"미발행"})]}),e.jsx("div",{className:"text-xs text-blue-600 dark:text-blue-300",children:y.length===0?"청구서를 먼저 업로드하고 검증해주세요":y.some(s=>s.status==="verified")?"발행 준비 완료":"청구서 검증 필요"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-600",children:y.length===0?"세금계산서 발행 관리를 위해서는 청구서를 업로드해주세요.":y.some(s=>s.taxInvoiceIssued)?"세금계산서가 발행되었습니다.":"세금계산서 발행이 가능합니다."}),e.jsx("div",{className:"flex gap-2",children:y.length>0&&y.some(s=>s.status==="verified")?e.jsx(e.Fragment,{children:y.some(s=>s.taxInvoiceIssued)?e.jsxs(p,{size:"sm",variant:"destructive",onClick:()=>{const s=y.find(n=>n.taxInvoiceIssued);s&&f.mutate(s.id)},disabled:f.isPending,children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"미확인"})]}):e.jsxs(p,{size:"sm",variant:"default",onClick:()=>{const s=y.find(n=>n.status==="verified"&&!n.taxInvoiceIssued);s&&D.mutate(s.id)},disabled:D.isPending,children:[e.jsx(O,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"확인"})]})}):e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{size:"sm",variant:"outline",disabled:!0,children:[e.jsx(O,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"확인"})]}),e.jsxs(p,{size:"sm",variant:"outline",disabled:!0,children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"미확인"})]})]})})]})]}),y.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground text-xs",children:"아직 업로드된 청구서가 없습니다."}):e.jsx("div",{className:"space-y-2",children:y.map(s=>e.jsxs("div",{className:"border rounded-lg p-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("h4",{className:"font-medium text-xs",children:s.invoiceNumber}),d(s.invoiceType),a(s.status)]}),s.status==="pending"&&e.jsxs(p,{size:"sm",onClick:()=>w.mutate(s.id),disabled:w.isPending,children:[e.jsx(O,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"검증"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["발행일: ",I(new Date(s.issueDate),"yyyy-MM-dd",{locale:A})]})]}),s.dueDate&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["마감일: ",I(new Date(s.dueDate),"yyyy-MM-dd",{locale:A})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(xe,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["총액: ₩",Math.round(s.totalAmount||0).toLocaleString("ko-KR")]})]}),s.vatAmount>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(xe,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["부가세: ₩",Math.round(s.vatAmount||0).toLocaleString("ko-KR")]})]})]}),s.notes&&e.jsx("div",{className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:s.notes}),e.jsxs("div",{className:"border-t pt-2 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"text-xs font-medium",children:"세금계산서"}),s.taxInvoiceIssued?e.jsxs(h,{variant:"default",className:"text-xs",children:[e.jsx(he,{className:"h-2 w-2 mr-1"}),"발행완료"]}):e.jsx(h,{variant:"secondary",className:"text-xs",children:"미발행"})]}),e.jsxs("div",{className:"flex gap-1",children:[s.status==="verified"&&e.jsx(e.Fragment,{children:s.taxInvoiceIssued?e.jsxs(p,{size:"sm",variant:"destructive",onClick:()=>f.mutate(s.id),disabled:f.isPending,children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:f.isPending?"취소 중...":"발행 취소"})]}):e.jsxs(p,{size:"sm",variant:"outline",onClick:()=>D.mutate(s.id),disabled:D.isPending,children:[e.jsx(_,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:D.isPending?"처리 중...":"발행 확인"})]})}),s.status!=="verified"&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"청구서 검증 후 발행 가능"})]})]}),s.status==="verified"&&s.taxInvoiceIssued&&s.taxInvoiceIssuedDate&&e.jsxs("div",{className:"text-xs text-muted-foreground bg-green-50 dark:bg-green-900/20 p-2 rounded",children:["발행일: ",I(new Date(s.taxInvoiceIssuedDate),"yyyy-MM-dd HH:mm",{locale:A}),s.taxInvoiceIssuedBy&&` | 발행자: ${s.taxInvoiceIssuedBy}`]})]}),s.verifiedBy&&s.verifiedAt&&e.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-1",children:["검증자: ",s.verifiedBy," | 검증일: ",I(new Date(s.verifiedAt),"yyyy-MM-dd HH:mm",{locale:A})]})]},s.id))})]}),q.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-medium mb-2 text-xs",children:"검증 로그"}),e.jsx("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:q.map(s=>e.jsxs("div",{className:"text-xs p-2 bg-muted rounded",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{children:s.details}),e.jsx("span",{className:"text-xs text-muted-foreground",children:I(new Date(s.createdAt),"MM-dd HH:mm",{locale:A})})]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:s.performedBy})]},s.id))})]})]})]})}function as({orderItems:m,orderId:c}){const{toast:g}=ne(),j=pe(),[Q,r]=k.useState(!1),[N,y]=k.useState(null),[R,q]=k.useState(!1),[v,w]=k.useState(null),[,D]=k.useState(0),f=de(["/api/item-receipts",c],{queryFn:async()=>{const t=await b("GET","/api/item-receipts"),i=m.map(o=>o.id);return t.filter(o=>i.includes(o.orderItemId))},cacheType:"DYNAMIC",enabled:m.length>0}),{data:E=[]}=de(["/api/invoices",c],{queryFn:()=>b("GET",`/api/invoices?orderId=${c}`),cacheType:"MASTER",enabled:!!c}),a=M({mutationFn:async t=>{console.log("Sending receipt data to API:",t);try{const i=await b("POST","/api/item-receipts",t);return console.log("API response:",i),i}catch(i){throw console.error("API request failed:",i),i}},onSuccess:async t=>{console.log("💥 Receipt creation successful, forcing refetch:",t),j.resetQueries({queryKey:["/api/item-receipts",c]}),j.invalidateQueries({queryKey:["/api/item-receipts"]}),await f.refetch(),D(i=>i+1),j.invalidateQueries({queryKey:["/api/verification-logs",c]}),r(!1),y(null),g({title:"성공",description:"수령 확인이 등록되었습니다."})},onError:t=>{console.error("Receipt creation mutation error:",t);const i=t?.message||"수령 확인 등록에 실패했습니다.";g({title:"오류",description:i,variant:"destructive"})}}),d=M({mutationFn:async t=>{const{id:i,...l}=t;return await(await b("PATCH",`/api/item-receipts/${i}`,l)).json()},onSuccess:async t=>{console.log("💥 Receipt update successful:",t),j.resetQueries({queryKey:["/api/item-receipts",c]}),j.invalidateQueries({queryKey:["/api/item-receipts"]}),await f.refetch(),D(i=>i+1),j.invalidateQueries({queryKey:["/api/verification-logs",c]}),q(!1),w(null),g({title:"수령 정보 수정 완료",description:"수령 정보가 성공적으로 수정되었습니다."})},onError:t=>{g({title:"수정 실패",description:t.message||"수령 정보 수정 중 오류가 발생했습니다.",variant:"destructive"})}}),s=M({mutationFn:async t=>await b("DELETE",`/api/item-receipts/${t}`),onSuccess:async()=>{console.log("💥 Receipt deletion successful"),j.resetQueries({queryKey:["/api/item-receipts",c]}),j.invalidateQueries({queryKey:["/api/item-receipts"]}),await f.refetch(),D(t=>t+1),j.invalidateQueries({queryKey:["/api/verification-logs",c]}),g({title:"수령 정보 삭제 완료",description:"수령 정보가 성공적으로 삭제되었습니다."})},onError:t=>{g({title:"삭제 실패",description:t.message||"수령 정보 삭제 중 오류가 발생했습니다.",variant:"destructive"})}}),n=M({mutationFn:async t=>{const i=t.map(l=>b("POST","/api/item-receipts",l));return await Promise.all(i)},onSuccess:()=>{j.invalidateQueries({queryKey:["/api/item-receipts"]}),j.invalidateQueries({queryKey:["/api/verification-logs",c]}),g({title:"성공",description:"일괄 수령 등록이 완료되었습니다."})},onError:()=>{g({title:"오류",description:"일괄 수령 등록에 실패했습니다.",variant:"destructive"})}}),C=t=>{t.preventDefault();const i=new FormData(t.currentTarget),l={orderItemId:N.id,invoiceId:i.get("invoiceId")?parseInt(i.get("invoiceId")):void 0,receivedQuantity:parseFloat(i.get("receivedQuantity")),receivedDate:i.get("receivedDate"),qualityCheck:i.get("qualityCheck")==="on",qualityNotes:i.get("qualityNotes")||"",status:i.get("status")||"approved",notes:i.get("notes")||""};console.log("Submitting receipt data:",l),a.mutate(l)},$=t=>{if(t.preventDefault(),!v){g({title:"오류",description:"선택된 수령 정보가 없습니다.",variant:"destructive"});return}const i=new FormData(t.currentTarget),l={id:v.id,receivedQuantity:parseFloat(i.get("receivedQuantity")),receivedDate:i.get("receivedDate"),qualityCheck:i.get("qualityCheck")==="on",qualityNotes:i.get("qualityNotes")||"",status:i.get("status")||"pending",notes:i.get("notes")||""};console.log("Submitting updated receipt data:",l),d.mutate(l)},je=()=>{const t=new Date().toISOString().split("T")[0],i=m.filter(o=>K(o.id)<o.quantity);if(i.length===0){g({title:"알림",description:"모든 항목이 이미 수령 완료되었습니다."});return}const l=i.map(o=>({orderItemId:o.id,receivedQuantity:o.quantity-K(o.id),receivedDate:t,qualityCheck:!0,status:"approved",notes:"일괄 수령 등록"}));n.mutate(l)},le=t=>{if(f.status==="error")return console.log(`❌ Query in error state for item ${t}, triggering fresh fetch`),f.refetch(),[];const i=f.data||[];console.log(`🔍 Looking for receipts for item ${t}`),console.log(`🔍 Current query data length: ${i.length}`),console.log(`🔍 Query status: ${f.status}, isFetching: ${f.isFetching}`);const l=i.filter(o=>o.orderItemId===t);return console.log(`📋 Found ${l.length} receipts for item ${t}:`,l),l},K=t=>{const l=le(t).reduce((o,T)=>{const x=typeof T.receivedQuantity=="string"?parseFloat(T.receivedQuantity):T.receivedQuantity;return o+(x||0)},0);return console.log(`💯 Total received for item ${t}: ${l}`),l},ye=t=>{const o=(f.data||[]).filter(x=>x.orderItemId===t.id).reduce((x,V)=>{const fe=typeof V.receivedQuantity=="string"?parseFloat(V.receivedQuantity):V.receivedQuantity;return x+(fe||0)},0),T=t.quantity;return o===0?{status:"pending",label:"미수령",icon:be,color:"secondary"}:o<T?{status:"partial",label:"부분수령",icon:ke,color:"warning"}:{status:"complete",label:"수령완료",icon:O,color:"default"}},ve=t=>{switch(t){case"pending":return e.jsx(h,{variant:"secondary",children:"대기중"});case"approved":return e.jsx(h,{variant:"default",children:"승인됨"});case"rejected":return e.jsx(h,{variant:"destructive",children:"반려됨"});default:return e.jsx(h,{variant:"secondary",children:t})}};return e.jsxs(Z,{children:[e.jsx(J,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(X,{className:"flex items-center gap-1 text-sm",children:[e.jsx(me,{className:"h-4 w-4"}),"자재 수령 확인"]}),e.jsxs(p,{onClick:je,disabled:n.isPending,className:"bg-blue-600 hover:bg-blue-700",size:"sm",children:[e.jsx(me,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"일괄 수령 등록"})]})]})}),e.jsxs(Y,{className:"p-3",children:[e.jsx("div",{className:"space-y-2",children:m.map(t=>{const i=le(t.id),l=K(t.id),o=ye(t),T=o.icon;return e.jsxs("div",{className:"border rounded-lg p-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("h4",{className:"font-medium text-xs",children:t.itemName}),e.jsxs(h,{variant:o.color,className:"flex items-center gap-1 text-xs",children:[e.jsx(T,{className:"h-3 w-3"}),o.label]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-muted-foreground",children:[e.jsxs("div",{children:["발주수량: ",t.quantity.toLocaleString(),t.unit]}),e.jsxs("div",{children:["수령수량: ",l.toLocaleString(),t.unit]}),e.jsxs("div",{children:["미수령: ",(t.quantity-l).toLocaleString(),t.unit]}),e.jsxs("div",{children:["단가: ₩",Math.round(t.unitPrice||0).toLocaleString("ko-KR")]})]}),t.notes&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:t.notes})]}),e.jsxs(p,{size:"sm",onClick:()=>{y(t),r(!0)},disabled:l>=t.quantity,children:[e.jsx(Ne,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"수령등록"})]})]}),i.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("h5",{className:"text-xs font-medium mb-1",children:"수령 이력"}),e.jsx("div",{className:"space-y-1",children:i.map(x=>e.jsx("div",{className:"bg-muted p-2 rounded text-xs",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("span",{className:"font-medium text-xs",children:[(typeof x.receivedQuantity=="string"?parseFloat(x.receivedQuantity):x.receivedQuantity).toLocaleString(),t.unit," 수령"]}),ve(x.status),x.qualityCheck&&e.jsxs(h,{variant:"outline",className:"text-xs",children:[e.jsx(O,{className:"h-2 w-2 mr-1"}),"품질검사"]})]}),e.jsxs("div",{className:"text-muted-foreground text-xs",children:["수령일: ",I(new Date(x.receivedDate),"yyyy-MM-dd",{locale:A})]}),x.qualityNotes&&e.jsxs("div",{className:"text-muted-foreground text-xs",children:["품질메모: ",x.qualityNotes]}),x.notes&&e.jsxs("div",{className:"text-muted-foreground text-xs",children:["메모: ",x.notes]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(p,{size:"sm",variant:"ghost",onClick:()=>{w(x),q(!0)},className:"h-6 w-6 p-0 hover:bg-blue-50",children:e.jsx(Le,{className:"h-3 w-3 text-blue-600"})}),e.jsx(p,{size:"sm",variant:"ghost",onClick:()=>{confirm("이 수령 기록을 삭제하시겠습니까?")&&s.mutate(x.id)},className:"h-6 w-6 p-0 hover:bg-red-50",disabled:s.isPending,children:e.jsx(ge,{className:"h-3 w-3 text-red-600"})})]}),e.jsxs("div",{className:"text-xs text-muted-foreground text-right",children:[e.jsxs("div",{children:["등록자: ",x.verifiedBy]}),e.jsx("div",{children:I(new Date(x.createdAt),"MM-dd HH:mm",{locale:A})})]})]})]})},x.id))})]})]},t.id)})}),e.jsx(ee,{open:Q,onOpenChange:r,children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:"자재 수령 등록"})}),N&&e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted p-3 rounded",children:[e.jsx("div",{className:"font-medium",children:N.itemName}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["발주수량: ",N.quantity.toLocaleString(),N.unit," | 수령가능: ",(N.quantity-K(N.id)).toLocaleString(),N.unit]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"receivedQuantity",children:"수령 수량"}),e.jsx(S,{id:"receivedQuantity",name:"receivedQuantity",type:"number",step:"0.01",max:N.quantity-K(N.id),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"receivedDate",children:"수령 일자"}),e.jsx(S,{id:"receivedDate",name:"receivedDate",type:"date",defaultValue:new Date().toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"invoiceId",children:"연결된 청구서 (선택)"}),e.jsxs(z,{name:"invoiceId",children:[e.jsx(B,{children:e.jsx(H,{placeholder:"청구서 선택"})}),e.jsx(U,{children:E.map(t=>e.jsxs(F,{value:t.id.toString(),children:[t.invoiceNumber," - ₩",t.totalAmount.toLocaleString()]},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"status",children:"상태"}),e.jsxs(z,{name:"status",defaultValue:"pending",children:[e.jsx(B,{children:e.jsx(H,{})}),e.jsxs(U,{children:[e.jsx(F,{value:"pending",children:"대기중"}),e.jsx(F,{value:"approved",children:"승인됨"}),e.jsx(F,{value:"rejected",children:"반려됨"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{id:"qualityCheck",name:"qualityCheck"}),e.jsx(u,{htmlFor:"qualityCheck",className:"text-sm",children:"품질 검사 완료"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"qualityNotes",children:"품질 검사 메모"}),e.jsx(L,{id:"qualityNotes",name:"qualityNotes",rows:2,placeholder:"품질 검사 결과나 특이사항을 입력하세요"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"notes",children:"추가 메모"}),e.jsx(L,{id:"notes",name:"notes",rows:2,placeholder:"기타 메모사항을 입력하세요"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>r(!1),children:"취소"}),e.jsx(p,{type:"submit",disabled:a.isPending,children:a.isPending?"등록 중...":"등록"})]})]})]})}),e.jsx(ee,{open:R,onOpenChange:q,children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:"수령 정보 수정"})}),v&&e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsx("div",{className:"bg-muted p-3 rounded",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:["수령 기록 ID: ",v.id]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"edit-receivedQuantity",children:"수령 수량"}),e.jsx(S,{id:"edit-receivedQuantity",name:"receivedQuantity",type:"number",step:"0.01",defaultValue:v.receivedQuantity,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"edit-receivedDate",children:"수령 일자"}),e.jsx(S,{id:"edit-receivedDate",name:"receivedDate",type:"date",defaultValue:new Date(v.receivedDate).toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"edit-status",children:"상태"}),e.jsxs(z,{name:"status",defaultValue:v.status,children:[e.jsx(B,{children:e.jsx(H,{})}),e.jsxs(U,{children:[e.jsx(F,{value:"pending",children:"대기중"}),e.jsx(F,{value:"approved",children:"승인됨"}),e.jsx(F,{value:"rejected",children:"반려됨"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{id:"edit-qualityCheck",name:"qualityCheck",defaultChecked:v.qualityCheck}),e.jsx(u,{htmlFor:"edit-qualityCheck",className:"text-sm",children:"품질 검사 완료"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"edit-qualityNotes",children:"품질 검사 메모"}),e.jsx(L,{id:"edit-qualityNotes",name:"qualityNotes",rows:2,defaultValue:v.qualityNotes,placeholder:"품질 검사 결과나 특이사항을 입력하세요"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"edit-notes",children:"추가 메모"}),e.jsx(L,{id:"edit-notes",name:"notes",rows:2,defaultValue:v.notes,placeholder:"기타 메모사항을 입력하세요"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>q(!1),children:"취소"}),e.jsx(p,{type:"submit",disabled:d.isPending,children:d.isPending?"수정 중...":"수정 완료"})]})]})]})})]})]})}function is({attachments:m,orderId:c}){const{user:g}=we(),{toast:j}=ne(),{theme:Q}=De(),r=Q==="dark",[N,y]=k.useState(null),[R,q]=k.useState(null),v=g?.role==="admin";console.log("🔍 AttachedFilesInfo - COMPONENT CALLED!",{attachments:m,orderId:c}),console.log("🔍 AttachedFilesInfo - received attachments:",m);const w=m.map(a=>{const d=a.mimeType?.toLowerCase()||"",s=a.originalName?.toLowerCase()||"";let n="other",C=P;return d.includes("excel")||d.includes("spreadsheet")||s.endsWith(".xlsx")||s.endsWith(".xls")||s.endsWith(".xlsm")?(n="excel",C=oe):(d.includes("pdf")||s.endsWith(".pdf"))&&(n="pdf",C=P),console.log("🔍 Processing attachment:",{originalName:a.originalName,mimeType:a.mimeType,fileName:s,fileType:n}),{...a,fileType:n,icon:C}});if(console.log("📊 AttachedFilesInfo - attached files:",w),w.length===0)return console.log("⚠️ AttachedFilesInfo - No attached files found, component will not render"),null;console.log("✅ AttachedFilesInfo - Rendering component with",w.length,"attached files");const D=async a=>{y(a.id);try{const d=localStorage.getItem("token")||document.cookie.match(/auth_token=([^;]+)/)?.[1],s=await fetch(`/api/attachments/${a.id}/download`,{method:"GET",headers:{Authorization:d?`Bearer ${d}`:""},credentials:"include"});if(!s.ok)throw new Error("파일 다운로드에 실패했습니다");const n=await s.blob(),C=window.URL.createObjectURL(n),$=document.createElement("a");$.href=C,$.download=a.originalName,document.body.appendChild($),$.click(),document.body.removeChild($),window.URL.revokeObjectURL(C),j({title:"다운로드 완료",description:`${a.originalName} 파일이 다운로드되었습니다.`})}catch(d){console.error("Download error:",d),j({title:"다운로드 실패",description:d instanceof Error?d.message:"알 수 없는 오류가 발생했습니다.",variant:"destructive"})}finally{y(null)}},f=async a=>{if(!v){j({title:"권한 없음",description:"관리자만 파일을 삭제할 수 있습니다.",variant:"destructive"});return}q(a.id);try{await b("DELETE",`/api/attachments/${a.id}`),await W.invalidateQueries({queryKey:[`/api/orders/${c}`]}),await W.invalidateQueries({queryKey:["orders-optimized"]}),await W.invalidateQueries({queryKey:["/api/orders"]}),j({title:"파일 삭제 완료",description:`${a.originalName} 파일이 삭제되었습니다.`})}catch(d){console.error("Delete error:",d),j({title:"파일 삭제 실패",description:d instanceof Error?d.message:"알 수 없는 오류가 발생했습니다.",variant:"destructive"})}finally{q(null)}},E=a=>{if(a===0)return"0 B";const d=1024,s=["B","KB","MB","GB"],n=Math.floor(Math.log(a)/Math.log(d));return parseFloat((a/Math.pow(d,n)).toFixed(2))+" "+s[n]};return e.jsxs("div",{className:`shadow-sm rounded-lg border transition-colors ${r?"bg-gray-800 border-gray-700":"bg-white border-gray-200"}`,children:[e.jsx("div",{className:`p-6 border-b transition-colors ${r?"border-gray-700":"border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-lg mr-3 transition-colors ${r?"bg-green-900/20":"bg-green-50"}`,children:e.jsx(oe,{className:`h-5 w-5 transition-colors ${r?"text-green-400":"text-green-600"}`})}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-lg font-semibold transition-colors ${r?"text-white":"text-gray-900"}`,children:"첨부 된 파일"}),e.jsxs("span",{className:`text-sm transition-colors ${r?"text-gray-400":"text-gray-500"}`,children:["발주서와 관련된 첨부 파일 (",w.length,"개)"]})]})]}),e.jsxs(h,{variant:"outline",className:`transition-colors ${r?"border-blue-600 text-blue-400":"border-blue-200 text-blue-700 bg-blue-50"}`,children:[e.jsx(P,{className:"h-3 w-3 mr-1"}),"첨부파일"]})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[w.map(a=>e.jsx("div",{className:`border rounded-lg p-4 transition-all hover:shadow-md ${r?"border-gray-600 hover:border-gray-500 bg-gray-750":"border-gray-200 hover:border-gray-300 bg-gray-50/50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[e.jsx("div",{className:`p-2 rounded-lg transition-colors ${a.fileType==="excel"?r?"bg-green-900/30":"bg-green-100":a.fileType==="pdf"?r?"bg-red-900/30":"bg-red-100":r?"bg-gray-900/30":"bg-gray-100"}`,children:e.jsx(a.icon,{className:`h-5 w-5 transition-colors ${a.fileType==="excel"?r?"text-green-400":"text-green-600":a.fileType==="pdf"?r?"text-red-400":"text-red-600":r?"text-gray-400":"text-gray-600"}`})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:`font-medium text-sm truncate transition-colors ${r?"text-gray-200":"text-gray-900"}`,title:a.originalName,children:a.originalName}),e.jsx(h,{variant:"secondary",className:"text-xs",children:a.fileType==="excel"?"Excel":a.fileType==="pdf"?"PDF":"파일"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(P,{className:`h-3 w-3 transition-colors ${r?"text-gray-500":"text-gray-400"}`}),e.jsx("span",{className:`transition-colors ${r?"text-gray-400":"text-gray-600"}`,children:E(a.fileSize)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(qe,{className:`h-3 w-3 transition-colors ${r?"text-gray-500":"text-gray-400"}`}),e.jsx("span",{className:`transition-colors ${r?"text-gray-400":"text-gray-600"}`,children:a.uploadedBy||"알 수 없음"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:`h-3 w-3 transition-colors ${r?"text-gray-500":"text-gray-400"}`}),e.jsx("span",{className:`transition-colors ${r?"text-gray-400":"text-gray-600"}`,children:I(new Date(a.uploadedAt),"yyyy.MM.dd HH:mm")})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:[e.jsx(p,{variant:"outline",size:"sm",onClick:()=>D(a),disabled:N===a.id,className:`h-8 px-3 text-xs transition-colors ${r?"border-gray-600 text-gray-300 hover:bg-gray-700 hover:border-green-500 hover:text-green-400":"border-gray-300 text-gray-700 hover:bg-green-50 hover:border-green-300 hover:text-green-700"}`,children:N===a.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-current mr-1"}),"다운로드 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-3 w-3 mr-1"}),"다운로드"]})}),v&&e.jsxs(Ce,{children:[e.jsx(Te,{asChild:!0,children:e.jsx(p,{variant:"outline",size:"sm",disabled:R===a.id,className:`h-8 px-3 text-xs transition-colors ${r?"border-red-600 text-red-400 hover:bg-red-900/20 hover:border-red-500":"border-red-300 text-red-700 hover:bg-red-50 hover:border-red-400"}`,children:R===a.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-current mr-1"}),"삭제 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"h-3 w-3 mr-1"}),"삭제"]})})}),e.jsxs(Ie,{className:r?"bg-gray-800 border-gray-700":"",children:[e.jsxs(Me,{children:[e.jsx(Qe,{className:r?"text-white":"",children:"파일 삭제 확인"}),e.jsxs($e,{className:r?"text-gray-400":"",children:[e.jsx("strong",{children:a.originalName})," 파일을 삭제하시겠습니까?",e.jsx("br",{}),"이 작업은 되돌릴 수 없으며, 파일이 영구적으로 삭제됩니다."]})]}),e.jsxs(Ae,{children:[e.jsx(Re,{className:r?"border-gray-600 text-gray-300 hover:bg-gray-700":"",children:"취소"}),e.jsx(Pe,{onClick:()=>f(a),className:"bg-red-600 hover:bg-red-700 text-white",children:"삭제"})]})]})]})]})]})},a.id)),e.jsx("div",{className:`mt-4 p-3 rounded-lg border border-dashed transition-colors ${r?"border-gray-600 bg-gray-750":"border-gray-300 bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ke,{className:`h-4 w-4 mt-0.5 flex-shrink-0 transition-colors ${r?"text-blue-400":"text-blue-600"}`}),e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsx("p",{className:`font-medium transition-colors ${r?"text-blue-400":"text-blue-600"}`,children:"첨부 파일 정보"}),e.jsx("p",{className:`transition-colors ${r?"text-gray-400":"text-gray-600"}`,children:"이 섹션에는 발주서와 관련된 모든 첨부 파일이 표시됩니다. Excel 파일, PDF 문서 등 다양한 형태의 파일을 다운로드하여 사용할 수 있습니다."})]})]})})]})]})}export{is as A,ts as I,as as R};
