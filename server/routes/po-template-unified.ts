import { Router } from 'express';
import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import { POTemplateProcessorMock } from '../utils/po-template-processor-mock.js';
import { DebugLogger } from '../utils/debug-logger.js';
import { MockDB } from '../utils/mock-db.js';
import { POEmailServiceMock } from '../utils/po-email-service-mock.js';
import { convertExcelToPdfMock } from '../utils/excel-to-pdf-mock.js';
import { POTemplateValidator } from '../utils/po-template-validator.js';
import { ExcelAutomationService } from '../utils/excel-automation-service.js';
import { db } from '../db.js';
import { purchaseOrders, purchaseOrderItems, vendors, projects } from '@shared/schema';
import { eq } from 'drizzle-orm';

const router = Router();

// ES modulesÏóêÏÑú __dirname Ï†ïÏùò
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ÌôòÍ≤Ω Í∞êÏßÄ Ìï®Ïàò
const isProductionEnvironment = () => {
  return process.env.NODE_ENV === 'production' && db !== null;
};

// ÌÜµÌï© ÌååÏùº ÏóÖÎ°úÎìú ÏÑ§Ï†ï
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadDir = path.join(__dirname, '../../uploads');
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    const timestamp = Date.now();
    const originalName = Buffer.from(file.originalname, 'latin1').toString('utf8');
    const extension = path.extname(originalName);
    const basename = path.basename(originalName, extension);
    cb(null, `${timestamp}-${basename}${extension}`);
  }
});

const upload = multer({
  storage,
  fileFilter: (req, file, cb) => {
    const allowedMimes = [
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'application/vnd.ms-excel'
    ];
    const allowedExtensions = ['.xlsx', '.xls'];
    const fileExtension = path.extname(file.originalname).toLowerCase();
    
    if (allowedMimes.includes(file.mimetype) && allowedExtensions.includes(fileExtension)) {
      cb(null, true);
    } else {
      cb(new Error('Excel ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.'));
    }
  },
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  }
});

// ÌÜµÌï© Ïù∏Ï¶ù ÎØ∏Îì§Ïõ®Ïñ¥
const requireAuth = (req: any, res: any, next: any) => {
  if (process.env.NODE_ENV === 'development') {
    req.user = { id: isProductionEnvironment() ? 'prod_admin_001' : 'mock-user-001' };
    return next();
  }
  
  if (req.session && req.session.userId) {
    req.user = { id: req.session.userId };
    return next();
  }
  
  return res.status(401).json({ error: 'Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
};

/**
 * ÌôòÍ≤Ω ÏÉÅÌÉú ÌôïÏù∏
 */
router.get('/environment', requireAuth, async (req: any, res) => {
  try {
    const isProduction = isProductionEnvironment();
    let dbStatus = 'disconnected';
    
    if (db) {
      try {
        await db.select().from(vendors).limit(1);
        dbStatus = 'connected';
      } catch (error) {
        dbStatus = 'error';
      }
    }
    
    res.json({
      success: true,
      data: {
        environment: process.env.NODE_ENV || 'development',
        isProduction,
        dbStatus,
        usingMockDB: !isProduction,
        features: {
          realDatabase: isProduction,
          mockDatabase: !isProduction,
          emailService: true,
          pdfGeneration: true,
          excelProcessing: true
        }
      }
    });
  } catch (error) {
    console.error('ÌôòÍ≤Ω ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);
    res.status(500).json({
      error: 'ÌôòÍ≤Ω ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®',
      details: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * PO Template ÌååÏùº ÏóÖÎ°úÎìú Î∞è ÌååÏã± (ÌôòÍ≤Ω ÏûêÎèô Í∞êÏßÄ)
 */
router.post('/upload', requireAuth, upload.single('file'), async (req: any, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'ÌååÏùºÏù¥ ÏóÖÎ°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' });
    }

    const filePath = req.file.path;
    const isProduction = isProductionEnvironment();
    
    // Step 0: ÏÇ¨Ï†Ñ Í≤ÄÏ¶ù (Î™®Îì† ÌôòÍ≤ΩÏóêÏÑú Í≥µÌÜµ)
    console.log('üîç Step 0: Excel ÌååÏùº ÏÇ¨Ï†Ñ Í≤ÄÏ¶ù ÏãúÏûë');
    const preValidation = await ExcelAutomationService.preValidateExcel(filePath);
    
    if (!preValidation.success) {
      fs.unlinkSync(filePath);
      return res.status(400).json({
        error: 'Excel ÌååÏùº Í≤ÄÏ¶ù Ïã§Ìå®',
        details: preValidation.errors.join('\n'),
        warnings: preValidation.warnings
      });
    }

    // Í≤ΩÍ≥†ÏÇ¨Ìï≠ Î°úÍπÖ
    if (preValidation.warnings.length > 0) {
      console.log('‚ö†Ô∏è Excel Í≤ÄÏ¶ù Í≤ΩÍ≥†ÏÇ¨Ìï≠:');
      preValidation.warnings.forEach(warning => console.log(`  - ${warning}`));
    }

    // 1. Îπ†Î•∏ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    const quickValidation = await POTemplateValidator.quickValidate(filePath);
    if (!quickValidation.isValid) {
      fs.unlinkSync(filePath);
      return res.status(400).json({ 
        error: 'ÌååÏùº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ïã§Ìå®', 
        details: quickValidation.errors.join(', '),
        validation: quickValidation
      });
    }

    // 2. Input ÏãúÌä∏ ÌååÏã±
    const parseResult = POTemplateProcessorMock.parseInputSheet(filePath);
    
    if (!parseResult.success) {
      fs.unlinkSync(filePath);
      return res.status(400).json({ 
        error: 'ÌååÏã± Ïã§Ìå®', 
        details: parseResult.error 
      });
    }

    // 3. ÏÉÅÏÑ∏ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    const detailedValidation = await POTemplateValidator.validatePOTemplateFile(filePath);
    
    res.json({
      success: true,
      message: 'ÌååÏùº ÌååÏã± ÏôÑÎ£å',
      data: {
        fileName: req.file.originalname,
        filePath,
        totalOrders: parseResult.totalOrders,
        totalItems: parseResult.totalItems,
        orders: parseResult.orders,
        validation: {
          preValidation,
          quickValidation,
          detailedValidation
        },
        environment: {
          isProduction,
          usingMockDB: !isProduction
        }
      }
    });

  } catch (error) {
    console.error('PO Template ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
    
    if (req.file && fs.existsSync(req.file.path)) {
      fs.unlinkSync(req.file.path);
    }
    
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÄÏû• (ÌôòÍ≤Ω ÏûêÎèô Í∞êÏßÄ)
 */
router.post('/save', requireAuth, async (req: any, res) => {
  try {
    const { orders } = req.body;
    
    if (!orders || !Array.isArray(orders)) {
      return res.status(400).json({ error: 'Î∞úÏ£ºÏÑú Îç∞Ïù¥ÌÑ∞Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.' });
    }

    const isProduction = isProductionEnvironment();
    
    if (isProduction) {
      // Ïã§Ï†ú DBÏóê Ï†ÄÏû•
      const saveResult = await saveToRealDatabase(orders, req.user.id);
      res.json({
        success: true,
        message: 'Ïã§Ï†ú DB Ï†ÄÏû• ÏôÑÎ£å',
        data: {
          ...saveResult,
          usingMockDB: false
        }
      });
    } else {
      // Mock DBÏóê Ï†ÄÏû•
      const mockResult = await POTemplateProcessorMock.saveToDatabase(orders, req.user.id);
      
      if (!mockResult.success) {
        return res.status(500).json({ 
          error: 'Mock DB Ï†ÄÏû• Ïã§Ìå®', 
          details: mockResult.error 
        });
      }
      
      res.json({
        success: true,
        message: 'Mock DB Ï†ÄÏû• ÏôÑÎ£å',
        data: {
          savedOrders: mockResult.savedOrders,
          usingMockDB: true
        }
      });
    }

  } catch (error) {
    console.error('PO Template Ï†ÄÏû• Ïò§Î•ò:', error);
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * Í∞ëÏßÄ/ÏùÑÏßÄ ÏãúÌä∏ Ï∂îÏ∂ú
 */
router.post('/extract-sheets', requireAuth, async (req: any, res) => {
  DebugLogger.logExecutionPath('/api/po-template/extract-sheets', 'POTemplateProcessorMock.extractSheetsToFile');
  
  try {
    const { filePath, sheetNames = ['Í∞ëÏßÄ', 'ÏùÑÏßÄ'] } = req.body;
    
    if (!filePath) {
      return res.status(400).json({ error: 'ÌååÏùº Í≤ΩÎ°úÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.' });
    }

    if (!fs.existsSync(filePath)) {
      return res.status(400).json({ error: 'ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }

    const timestamp = Date.now();
    const extractedPath = path.join(
      path.dirname(filePath),
      `extracted-${timestamp}.xlsx`
    );

    const extractResult = await POTemplateProcessorMock.extractSheetsToFile(
      filePath,
      extractedPath,
      sheetNames
    );

    if (!extractResult.success) {
      return res.status(500).json({ 
        error: 'ÏãúÌä∏ Ï∂îÏ∂ú Ïã§Ìå®', 
        details: extractResult.error 
      });
    }

    res.json({
      success: true,
      message: 'ÏãúÌä∏ Ï∂îÏ∂ú ÏôÑÎ£å',
      data: {
        extractedPath,
        extractedSheets: extractResult.extractedSheets
      }
    });

  } catch (error) {
    console.error('ÏãúÌä∏ Ï∂îÏ∂ú Ïò§Î•ò:', error);
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * ÌÜµÍ≥Ñ Ï°∞Ìöå (ÌôòÍ≤Ω ÏûêÎèô Í∞êÏßÄ)
 */
router.get('/statistics', requireAuth, async (req: any, res) => {
  try {
    const isProduction = isProductionEnvironment();
    
    if (isProduction) {
      try {
        // Ïã§Ï†ú DBÏóêÏÑú ÌÜµÍ≥Ñ Ï°∞Ìöå
        const [vendorCount, projectCount, orderCount, itemCount] = await Promise.all([
          db.select().from(vendors),
          db.select().from(projects),
          db.select().from(purchaseOrders),
          db.select().from(purchaseOrderItems)
        ]);
        
        res.json({
          success: true,
          data: {
            stats: {
              vendors: vendorCount.length,
              projects: projectCount.length,
              purchaseOrders: orderCount.length,
              purchaseOrderItems: itemCount.length
            },
            sampleData: {
              recentVendors: vendorCount.slice(-3),
              recentProjects: projectCount.slice(-3),
              recentOrders: orderCount.slice(-3)
            },
            usingMockDB: false
          }
        });
        
      } catch (dbError) {
        // DB Ïò§Î•ò Ïãú MockÏúºÎ°ú Ìè¥Î∞±
        const mockStats = getMockStatistics();
        res.json({
          success: true,
          data: {
            ...mockStats,
            usingMockDB: true,
            dbError: dbError instanceof Error ? dbError.message : 'Unknown error'
          }
        });
      }
    } else {
      // Mock DB ÌÜµÍ≥Ñ
      const mockStats = getMockStatistics();
      res.json({
        success: true,
        data: {
          ...mockStats,
          usingMockDB: true
        }
      });
    }
    
  } catch (error) {
    console.error('ÌÜµÍ≥Ñ Ï°∞Ìöå Ïò§Î•ò:', error);
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * Ïù¥Î©îÏùº Î∞úÏÜ°
 */
router.post('/send-email', requireAuth, async (req: any, res) => {
  try {
    const { 
      filePath, 
      to, 
      cc, 
      bcc, 
      subject, 
      orderNumber, 
      vendorName, 
      orderDate, 
      dueDate, 
      totalAmount, 
      additionalMessage 
    } = req.body;

    // ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
    if (!filePath || !to || !subject) {
      return res.status(400).json({ 
        error: 'ÌïÑÏàò Îç∞Ïù¥ÌÑ∞Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§. (filePath, to, subject ÌïÑÏàò)' 
      });
    }

    // ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏
    if (!fs.existsSync(filePath)) {
      return res.status(400).json({ error: 'ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }

    // Ïù¥Î©îÏùº ÏÑúÎπÑÏä§ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ± (Mock Î™®Îìú)
    const emailService = new POEmailServiceMock();

    // Ïù¥Î©îÏùº Î∞úÏÜ°
    const emailResult = await emailService.sendPOWithAttachments(filePath, {
      to,
      cc,
      bcc,
      subject,
      orderNumber,
      vendorName,
      orderDate,
      dueDate,
      totalAmount,
      additionalMessage
    });

    if (!emailResult.success) {
      return res.status(500).json({ 
        error: 'Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®', 
        details: emailResult.error 
      });
    }

    res.json({
      success: true,
      message: emailResult.mockMode ? 'Ïù¥Î©îÏùº Î∞úÏÜ° ÏôÑÎ£å (Mock Î™®Îìú)' : 'Ïù¥Î©îÏùº Î∞úÏÜ° ÏôÑÎ£å',
      data: {
        messageId: emailResult.messageId,
        recipients: Array.isArray(to) ? to : [to],
        attachments: ['Í∞ëÏßÄ/ÏùÑÏßÄ ÏãúÌä∏ (Excel)', 'Í∞ëÏßÄ/ÏùÑÏßÄ ÏãúÌä∏ (PDF)'],
        mockMode: emailResult.mockMode
      }
    });

  } catch (error) {
    console.error('Ïù¥Î©îÏùº Î∞úÏÜ° Ïò§Î•ò:', error);
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * PDF Î≥ÄÌôò
 */
router.post('/convert-to-pdf', requireAuth, async (req: any, res) => {
  try {
    const { filePath, outputPath } = req.body;
    
    if (!filePath) {
      return res.status(400).json({ error: 'ÌååÏùº Í≤ΩÎ°úÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.' });
    }

    if (!fs.existsSync(filePath)) {
      return res.status(400).json({ error: 'ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }

    // PDF Î≥ÄÌôò
    const timestamp = Date.now();
    const pdfPath = outputPath || path.join(
      path.dirname(filePath),
      `po-sheets-${timestamp}.pdf`
    );

    const pdfResult = await convertExcelToPdfMock(filePath, pdfPath, ['Í∞ëÏßÄ', 'ÏùÑÏßÄ']);

    if (!pdfResult.success) {
      return res.status(500).json({ 
        error: 'PDF Î≥ÄÌôò Ïã§Ìå®', 
        details: pdfResult.error 
      });
    }

    res.json({
      success: true,
      message: 'PDF Î≥ÄÌôò ÏôÑÎ£å',
      data: {
        pdfPath: pdfResult.pdfPath,
        originalFile: filePath,
        convertedSheets: ['Í∞ëÏßÄ', 'ÏùÑÏßÄ']
      }
    });

  } catch (error) {
    console.error('PDF Î≥ÄÌôò Ïò§Î•ò:', error);
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * ÌÜµÌï© Ï≤òÎ¶¨ ÏõåÌÅ¨ÌîåÎ°úÏö∞
 */
router.post('/process-complete', requireAuth, upload.single('file'), async (req: any, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'ÌååÏùºÏù¥ ÏóÖÎ°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' });
    }

    const filePath = req.file.path;
    const { 
      sendEmail, 
      emailTo, 
      emailSubject, 
      emailMessage,
      generatePDF 
    } = req.body;

    const isProduction = isProductionEnvironment();
    const results = {
      upload: { success: true, fileName: req.file.originalname },
      validation: null,
      parsing: null,
      saving: null,
      extraction: null,
      pdf: null,
      email: null
    };

    // 1. Í≤ÄÏ¶ù Î∞è ÌååÏã±
    console.log('üìÅ 1Îã®Í≥Ñ: ÌååÏùº Í≤ÄÏ¶ù Î∞è ÌååÏã±');
    const validation = await POTemplateValidator.validatePOTemplateFile(filePath);
    results.validation = validation;

    if (!validation.isValid) {
      fs.unlinkSync(filePath);
      return res.status(400).json({ 
        error: 'Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ïã§Ìå®', 
        details: validation.errors.join(', '),
        results
      });
    }

    const parseResult = POTemplateProcessorMock.parseInputSheet(filePath);
    results.parsing = parseResult;

    if (!parseResult.success) {
      fs.unlinkSync(filePath);
      return res.status(400).json({ 
        error: 'ÌååÏã± Ïã§Ìå®', 
        details: parseResult.error,
        results
      });
    }

    // 2. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÄÏû•
    console.log('üíæ 2Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÄÏû•');
    if (isProduction) {
      results.saving = await saveToRealDatabase(parseResult.orders, req.user.id);
    } else {
      results.saving = await POTemplateProcessorMock.saveToDatabase(parseResult.orders, req.user.id);
    }

    // 3. ÏãúÌä∏ Ï∂îÏ∂ú
    console.log('üìã 3Îã®Í≥Ñ: Í∞ëÏßÄ/ÏùÑÏßÄ ÏãúÌä∏ Ï∂îÏ∂ú');
    const timestamp = Date.now();
    const extractedPath = path.join(
      path.dirname(filePath),
      `extracted-${timestamp}.xlsx`
    );

    const extractResult = await POTemplateProcessorMock.extractSheetsToFile(
      filePath,
      extractedPath,
      ['Í∞ëÏßÄ', 'ÏùÑÏßÄ']
    );
    results.extraction = extractResult;

    // 4. PDF Î≥ÄÌôò (ÏòµÏÖò)
    if (generatePDF && extractResult.success) {
      console.log('üìÑ 4Îã®Í≥Ñ: PDF Î≥ÄÌôò');
      const pdfPath = path.join(
        path.dirname(filePath),
        `po-sheets-${timestamp}.pdf`
      );
      
      const pdfResult = await convertExcelToPdfMock(extractedPath, pdfPath);
      results.pdf = pdfResult;
    }

    // 5. Ïù¥Î©îÏùº Î∞úÏÜ° (ÏòµÏÖò)
    if (sendEmail && emailTo && emailSubject && extractResult.success) {
      console.log('üìß 5Îã®Í≥Ñ: Ïù¥Î©îÏùº Î∞úÏÜ°');
      const emailService = new POEmailServiceMock();
      
      const emailResult = await emailService.sendPOWithAttachments(extractedPath, {
        to: emailTo,
        subject: emailSubject,
        orderNumber: parseResult.orders[0]?.orderNumber,
        vendorName: parseResult.orders[0]?.vendorName,
        orderDate: parseResult.orders[0]?.orderDate,
        dueDate: parseResult.orders[0]?.dueDate,
        totalAmount: parseResult.orders[0]?.totalAmount,
        additionalMessage: emailMessage
      });
      
      results.email = emailResult;
    }

    console.log('‚úÖ ÌÜµÌï© Ï≤òÎ¶¨ ÏôÑÎ£å');

    res.json({
      success: true,
      message: 'PO Template ÌÜµÌï© Ï≤òÎ¶¨ ÏôÑÎ£å',
      data: {
        fileName: req.file.originalname,
        environment: {
          isProduction,
          usingMockDB: !isProduction
        },
        results,
        summary: {
          totalOrders: parseResult.totalOrders,
          totalItems: parseResult.totalItems,
          validationPassed: validation.isValid,
          savedToDatabase: results.saving.success,
          sheetsExtracted: extractResult.success,
          pdfGenerated: results.pdf?.success || false,
          emailSent: results.email?.success || false
        }
      }
    });

  } catch (error) {
    console.error('ÌÜµÌï© Ï≤òÎ¶¨ Ïò§Î•ò:', error);
    
    if (req.file && fs.existsSync(req.file.path)) {
      fs.unlinkSync(req.file.path);
    }
    
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * Ïù¥Î©îÏùº Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
 */
router.get('/test-email', requireAuth, async (req: any, res) => {
  try {
    const emailService = new POEmailServiceMock();
    const testResult = await emailService.testConnection();

    res.json({
      success: true,
      message: testResult.mockMode ? 'Ïù¥Î©îÏùº Mock Î™®Îìú Ï†ïÏÉÅ' : 'Ïù¥Î©îÏùº ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ',
      data: {
        mockMode: testResult.mockMode,
        error: testResult.error
      }
    });

  } catch (error) {
    console.error('Ïù¥Î©îÏùº Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ïò§Î•ò:', error);
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

/**
 * Mock DB Î¶¨ÏÖã (Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎßå)
 */
router.post('/reset-mock-db', requireAuth, (req: any, res) => {
  try {
    if (isProductionEnvironment()) {
      return res.status(403).json({ 
        error: 'ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî Mock DB Î¶¨ÏÖãÏù¥ ÌóàÏö©ÎêòÏßÄ ÏïäÏäµÎãàÎã§.' 
      });
    }
    
    MockDB.clear();
    
    res.json({
      success: true,
      message: 'Mock DB Ï¥àÍ∏∞Ìôî ÏôÑÎ£å',
      data: MockDB.getStats()
    });
    
  } catch (error) {
    console.error('DB Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
    res.status(500).json({ 
      error: 'ÏÑúÎ≤Ñ Ïò§Î•ò', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    });
  }
});

// Ìó¨Ìçº Ìï®ÏàòÎì§
async function saveToRealDatabase(orders: any[], userId: string) {
  try {
    let savedOrders = 0;
    
    for (const orderData of orders) {
      // 1. Í±∞ÎûòÏ≤ò Ï∞æÍ∏∞ ÎòêÎäî ÏÉùÏÑ±
      let vendor = await db.select().from(vendors).where(eq(vendors.name, orderData.vendorName)).limit(1);
      let vendorId;
      
      if (vendor.length === 0) {
        const newVendor = await db.insert(vendors).values({
          name: orderData.vendorName,
          contactPerson: 'ÏûêÎèôÏÉùÏÑ±',
          email: `auto-${Date.now()}@example.com`,
          mainContact: 'ÏûêÎèôÏÉùÏÑ±'
        }).returning();
        vendorId = newVendor[0].id;
      } else {
        vendorId = vendor[0].id;
      }
      
      // 2. ÌîÑÎ°úÏ†ùÌä∏ Ï∞æÍ∏∞ ÎòêÎäî ÏÉùÏÑ±
      let project = await db.select().from(projects).where(eq(projects.projectName, orderData.siteName)).limit(1);
      let projectId;
      
      if (project.length === 0) {
        const newProject = await db.insert(projects).values({
          projectName: orderData.siteName,
          projectCode: `AUTO-${Date.now().toString().slice(-8)}`,
          status: 'active'
        }).returning();
        projectId = newProject[0].id;
      } else {
        projectId = project[0].id;
      }
      
      // 3. Î∞úÏ£ºÏÑú ÏÉùÏÑ±
      const newOrder = await db.insert(purchaseOrders).values({
        orderNumber: orderData.orderNumber,
        projectId,
        vendorId,
        userId,
        orderDate: new Date(orderData.orderDate),
        deliveryDate: orderData.dueDate ? new Date(orderData.dueDate) : null,
        totalAmount: orderData.totalAmount,
        status: 'draft',
        notes: 'PO TemplateÏóêÏÑú ÏûêÎèô ÏÉùÏÑ±Îê®'
      }).returning();
      
      const orderId = newOrder[0].id;
      
      // 4. Î∞úÏ£ºÏÑú ÏïÑÏù¥ÌÖúÎì§ ÏÉùÏÑ±
      for (const item of orderData.items) {
        await db.insert(purchaseOrderItems).values({
          orderId,
          itemName: item.itemName,
          specification: item.specification,
          quantity: item.quantity,
          unitPrice: item.unitPrice,
          totalAmount: item.totalAmount,
          categoryLv1: item.categoryLv1,
          categoryLv2: item.categoryLv2,
          categoryLv3: item.categoryLv3,
          supplyAmount: item.supplyAmount,
          taxAmount: item.taxAmount,
          deliveryName: item.deliveryName,
          notes: item.notes
        });
      }
      
      savedOrders++;
    }
    
    return {
      success: true,
      savedOrders,
      usingMockDB: false
    };
    
  } catch (error) {
    console.error('Ïã§Ï†ú DB Ï†ÄÏû• Ïã§Ìå®:', error);
    throw error;
  }
}

function getMockStatistics() {
  const stats = MockDB.getStats();
  const allData = MockDB.getAllData();
  
  return {
    stats,
    sampleData: {
      recentVendors: allData.vendors.slice(-3),
      recentProjects: allData.projects.slice(-3),
      recentOrders: allData.purchaseOrders.slice(-3),
      recentItems: allData.purchaseOrderItems.slice(-3)
    }
  };
}

export default router;