import{x as V,u as $,c as L,b as H,r as N,m as h,an as Q,o as R,j as e,B as p,p as W,A as z,D as G,s as U,ao as X,ap as l,aq as t,ar as o,as as c,I as m,at as i,w,y as _,a8 as J,X as B,f as Y,ax as Z,n as ee,t as F}from"./index-CT0ftmgw.js";import{T as se}from"./textarea-_3whHVQG.js";import{S,a as D,b as M,c as I,d as f}from"./select-i-FUF4r3.js";import{C as re}from"./checkbox-BJHnt2OS.js";import{P as ae}from"./page-header-BAZkX7ib.js";import{C as ne,a as te,b as oe,c as ce,d as le}from"./command-illfNvCY.js";import{P as ie,a as de,b as je}from"./popover-iHl4x2GH.js";import{A as xe}from"./arrow-left-Bf7Qt02N.js";import{C as me}from"./chevrons-up-down-Rp9xUvcG.js";import{S as he}from"./save-DxhsuVpg.js";import"./index-BdQq_4o_.js";import"./index-Ba92UTF-.js";import"./chevron-down-CE-M5reU.js";import"./chevron-up-DjOtQo3T.js";import"./index-B0T6xzVV.js";import"./dialog-Dx9IY5aH.js";import"./search-Bxnovc4O.js";function Fe(){const{id:j}=V(),[,C]=$(),{toast:T}=L();H();const[x,u]=N.useState([]),[q,P]=N.useState(!1),{data:a,isLoading:A}=h({queryKey:["/api/projects",j],queryFn:()=>fetch(`/api/projects/${j}`).then(s=>s.json()),enabled:!!j}),{data:K=[]}=h({queryKey:["/api/project-statuses"]}),{data:k=[]}=h({queryKey:["/api/project-types"]}),{data:g=[]}=h({queryKey:["/api/users"]}),{data:v=[]}=h({queryKey:["/api/project-members",{projectId:j}],queryFn:()=>fetch(`/api/project-members?projectId=${j}`).then(s=>s.json()),enabled:!!j}),n=Q({defaultValues:{projectName:"",projectCode:"",clientName:"",projectType:"",location:"",status:"active",projectManagerId:"",orderManagerId:"",description:"",startDate:"",endDate:"",totalBudget:"",isActive:!0}});N.useEffect(()=>{a&&n.reset({projectName:a.projectName,projectCode:a.projectCode||"",clientName:a.clientName||"",projectType:a.projectType||"",location:a.location||"",status:a.status,projectManagerId:a.projectManagerId||"none",orderManagerId:a.orderManagerId||"none",description:a.description||"",startDate:a.startDate?new Date(a.startDate).toISOString().split("T")[0]:"",endDate:a.endDate?new Date(a.endDate).toISOString().split("T")[0]:"",totalBudget:a.totalBudget||"",isActive:a.isActive??!0})},[a,n]),N.useEffect(()=>{if(v&&v.length>0){const s=v.filter(r=>r.role==="order_manager").map(r=>r.userId);u(s)}},[v]);const y=R({mutationFn:async s=>ee("PATCH",`/api/projects/${j}`,s),onSuccess:()=>{F.invalidateQueries({queryKey:["/api/projects"]}),F.invalidateQueries({queryKey:["/api/projects",j]}),T({description:"현장이 성공적으로 수정되었습니다."}),C(`/projects/${j}`)},onError:s=>{T({variant:"destructive",description:s.message||"현장 수정 중 오류가 발생했습니다."})}}),O=async s=>{const r={...s,totalBudget:s.totalBudget?parseFloat(s.totalBudget.toString().replace(/[^\d.]/g,"")):null,startDate:s.startDate?new Date(s.startDate):null,endDate:s.endDate?new Date(s.endDate):null,projectManagerId:s.projectManagerId==="none"?null:s.projectManagerId,orderManagerId:s.orderManagerId==="none"?null:s.orderManagerId,orderManagers:x};y.mutate(r)},E=()=>{C(`/projects/${j}`)};return A?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-6"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-10 bg-gray-200 rounded"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-10 bg-gray-200 rounded"})]})]})}):a?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6 space-y-6",children:[e.jsx(ae,{title:"현장 수정",description:`${a.projectName} 현장 정보를 수정합니다`}),e.jsxs(W,{className:"max-w-4xl shadow-sm",children:[e.jsx(z,{children:e.jsx(G,{className:"text-lg font-semibold",children:"현장 정보"})}),e.jsx(U,{children:e.jsx(X,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(O),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:n.control,name:"projectName",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"현장명 *"}),e.jsx(c,{children:e.jsx(m,{placeholder:"현장명을 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"projectCode",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"현장 코드"}),e.jsx(c,{children:e.jsx(m,{placeholder:"현장 코드를 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"clientName",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"클라이언트명"}),e.jsx(c,{children:e.jsx(m,{placeholder:"클라이언트명을 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"projectType",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"현장 유형"}),e.jsxs(S,{onValueChange:s.onChange,value:s.value,children:[e.jsx(c,{children:e.jsx(D,{children:e.jsx(M,{placeholder:"현장 유형을 선택하세요"})})}),e.jsx(I,{children:k.map(r=>e.jsx(f,{value:r.id,children:r.name},r.id))})]}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"location",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"위치"}),e.jsx(c,{children:e.jsx(m,{placeholder:"현장 위치를 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"status",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"상태"}),e.jsxs(S,{onValueChange:s.onChange,value:s.value,children:[e.jsx(c,{children:e.jsx(D,{children:e.jsx(M,{placeholder:"상태를 선택하세요"})})}),e.jsx(I,{children:K.map(r=>e.jsx(f,{value:r.id,children:r.name},r.id))})]}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"projectManagerId",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"현장 관리자"}),e.jsxs(S,{onValueChange:s.onChange,value:s.value,children:[e.jsx(c,{children:e.jsx(D,{children:e.jsx(M,{placeholder:"현장 관리자를 선택하세요"})})}),e.jsxs(I,{children:[e.jsx(f,{value:"none",children:"선택 안함"}),g.map(r=>e.jsx(f,{value:r.id,children:r.name},r.id))]})]}),e.jsx(i,{})]})}),e.jsxs(t,{children:[e.jsx(o,{children:"발주 담당자"}),e.jsx(c,{children:e.jsxs(ie,{open:q,onOpenChange:P,children:[e.jsx(de,{asChild:!0,children:e.jsxs(p,{variant:"outline",role:"combobox","aria-expanded":q,className:"w-full justify-between",children:[x.length===0?"발주 담당자를 선택하세요":e.jsxs("div",{className:"flex flex-wrap gap-1",children:[x.slice(0,2).map(s=>{const r=g.find(d=>d.id===s);return e.jsx(w,{variant:"secondary",className:"text-xs",children:r?.name||s},s)}),x.length>2&&e.jsxs(w,{variant:"secondary",className:"text-xs",children:["+",x.length-2,"명 더"]})]}),e.jsx(me,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(je,{className:"w-full p-0",children:e.jsxs(ne,{children:[e.jsx(te,{placeholder:"담당자 검색..."}),e.jsx(oe,{children:"담당자를 찾을 수 없습니다."}),e.jsx(ce,{children:g.map(s=>e.jsxs(le,{onSelect:()=>{const r=x.includes(s.id);u(r?d=>d.filter(b=>b!==s.id):d=>[...d,s.id])},children:[e.jsx(_,{className:J("mr-2 h-4 w-4",x.includes(s.id)?"opacity-100":"opacity-0")}),s.name]},s.id))})]})})]})}),e.jsx(i,{}),x.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"선택된 발주 담당자:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:x.map(s=>{const r=g.find(d=>d.id===s);return e.jsxs(w,{variant:"default",className:"text-xs",children:[r?.name||s,e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"ml-1 h-3 w-3 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>{u(d=>d.filter(b=>b!==s))},children:e.jsx(B,{className:"h-2 w-2"})})]},s)})})]})]}),e.jsx(l,{control:n.control,name:"startDate",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"시작일"}),e.jsx(c,{children:e.jsx(m,{type:"date",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"endDate",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"종료일"}),e.jsx(c,{children:e.jsx(m,{type:"date",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"totalBudget",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"총 예산"}),e.jsx(c,{children:e.jsx(m,{type:"text",placeholder:"₩0",value:s.value?Y(s.value):"",onChange:r=>{const d=Z(r.target.value);s.onChange(d.toString())},onBlur:s.onBlur,name:s.name,ref:s.ref})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"isActive",render:({field:s})=>e.jsxs(t,{className:"flex flex-row items-start space-x-3 space-y-0",children:[e.jsx(c,{children:e.jsx(re,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx("div",{className:"space-y-1 leading-none",children:e.jsx(o,{children:"활성 상태"})})]})})]}),e.jsx(l,{control:n.control,name:"description",render:({field:s})=>e.jsxs(t,{children:[e.jsx(o,{children:"설명"}),e.jsx(c,{children:e.jsx(se,{placeholder:"현장 설명을 입력하세요",className:"min-h-[100px]",...s})}),e.jsx(i,{})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsxs(p,{type:"button",variant:"outline",onClick:E,disabled:y.isPending,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"취소"]}),e.jsxs(p,{type:"submit",disabled:y.isPending,children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),y.isPending?"저장 중...":"저장"]})]})]})})})]})]})}):e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"현장을 찾을 수 없습니다"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"요청하신 현장이 존재하지 않거나 삭제되었습니다."}),e.jsxs(p,{onClick:()=>C("/projects"),children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"목록으로"]})]})})}export{Fe as default};
