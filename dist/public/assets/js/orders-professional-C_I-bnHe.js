import{i as ee,c as ge,r as g,k as fe,l as N,j as e,L as F,I as D,m as k,n as W,X as oe,o as X,U as $e,E as Ne,u as Ie,a as Re,b as Ue,p as Y,P as qe,q as ze,s as He,F as Be,f as Ve,t as Xe,v as de}from"./index-BmMnSXV0.js";import{S as q,a as z,b as H,c as B,d as f}from"./select-MnpL2n0I.js";import{i as G}from"./authUtils-CcDzk6i0.js";import{D as ye,a as ve,b as we,c as be,d as Se,e as _e}from"./dialog-DuhNEJLt.js";import{T as Ke}from"./textarea-Drbw1bxw.js";import{A as Qe,a as Ye}from"./alert-CKRW0A3-.js";import{C as me}from"./checkbox-BlAiq8mI.js";import{M as A}from"./mail-BL85_iar.js";import{T as Ge}from"./triangle-alert-DNNe8a5y.js";import{S as se}from"./send-DS90LtGb.js";import{T as Je,a as We,b as xe,c as Ze}from"./tabs-Dyq66mNa.js";import{S as es}from"./scroll-area-atIrZzP6.js";import{S as ss}from"./separator-CitZgV-D.js";import{R as he}from"./refresh-cw-CHQImglB.js";import{f as V}from"./format-BqlaHE6C.js";import{C as ts}from"./clock-WTWVlGVw.js";import{C as pe}from"./circle-x-B_ChF1Fh.js";import{P as as}from"./paperclip-CoKIOqPs.js";import{k as J}from"./ko-DHTEdlBI.js";import{S as rs}from"./search-DkUR6fz-.js";import{F as ns}from"./filter-Bi-qkdzq.js";import{C as ls}from"./chevron-up-ZhZAJcOI.js";import{D as ue}from"./download-t2riQs1n.js";import{C as M}from"./chevrons-up-down-C5kpA_Y8.js";import{S as cs}from"./square-pen-CIX-J9wN.js";import"./index-DAT-yBtZ.js";import"./index-Vhrf_H4q.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=ee("MailOpen",[["path",{d:"M21.2 8.4c.5.38.8.97.8 1.6v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V10a2 2 0 0 1 .8-1.6l8-6a2 2 0 0 1 2.4 0l8 6Z",key:"1jhwl8"}],["path",{d:"m22 10-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 10",key:"1qfld7"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=ee("MailX",[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h9",key:"1j9vog"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m17 17 4 4",key:"1b3523"}],["path",{d:"m21 17-4 4",key:"uinynz"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=ee("MousePointer",[["path",{d:"M12.586 12.586 19 19",key:"ea5xo7"}],["path",{d:"M3.688 3.037a.497.497 0 0 0-.651.651l6.5 15.999a.501.501 0 0 0 .947-.062l1.569-6.083a2 2 0 0 1 1.448-1.479l6.124-1.579a.5.5 0 0 0 .063-.947z",key:"277e5u"}]]);function ds(h={}){const l=ge(),c=g.useMemo(()=>["orders-optimized",Object.fromEntries(Object.entries(h).filter(([p,u])=>u!==void 0&&u!==""&&u!=="all"&&u!==null))],[h]),t=fe({queryKey:c,queryFn:async()=>{const i=new URLSearchParams;Object.entries(h).forEach(([P,r])=>{r!==void 0&&r!==""&&r!=="all"&&r!==null&&i.append(P,r.toString())});const p=`/api/orders-optimized${i.toString()?`?${i}`:""}`;console.log("🚀 Fetching optimized orders:",p);const u=await N("GET",p);return console.log("✅ Optimized orders response:",{ordersCount:u.orders.length,total:u.total,queryTime:u.performance.queryTime}),u},staleTime:30*1e3,gcTime:5*60*1e3,refetchOnWindowFocus:!1,refetchOnMount:!0,retry:(i,p)=>p?.status>=400&&p?.status<500?!1:i<2}),n=()=>{if(t.data&&t.data.page<t.data.totalPages){const i={...h,page:t.data.page+1};l.prefetchQuery({queryKey:["orders-optimized",i],queryFn:()=>N("GET",`/api/orders-optimized?${new URLSearchParams(i)}`),staleTime:30*1e3})}};return{...t,orders:t.data?.orders||[],vendors:t.data?.metadata.vendors||[],projects:t.data?.metadata.projects||[],users:t.data?.metadata.users||[],total:t.data?.total||0,page:t.data?.page||1,totalPages:t.data?.totalPages||1,performance:t.data?.performance,prefetchNextPage:n,hasNextPage:t.data?t.data.page<t.data.totalPages:!1,hasPreviousPage:t.data?t.data.page>1:!1}}function ms(h={}){const l=ge(),c=ds(h);return{...c,prefetchRelatedData:()=>{l.prefetchQuery({queryKey:["orders-metadata"],queryFn:()=>N("GET","/api/orders-metadata"),staleTime:10*60*1e3}),c.hasNextPage&&c.prefetchNextPage()},isOptimized:!0,cacheHit:c.performance?.cacheHit||!1,queryTime:c.performance?.queryTime||"unknown"}}function xs({open:h,onOpenChange:l,orderData:c,onSendEmail:t}){const[n,i]=g.useState({to:c.vendorEmail?[c.vendorEmail]:[""],cc:[],subject:`발주서 전송 - ${c.orderNumber}`,message:"",attachPDF:!0,attachExcel:!0}),[p,u]=g.useState(!1),[P,r]=g.useState([]),[o,v]=g.useState(""),[E,I]=g.useState(""),O=a=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a),R=()=>{o&&O(o)?n.to.includes(o)||(i(a=>({...a,to:[...a.to.filter(m=>m!==""),o]})),v(""),r(a=>a.filter(m=>!m.includes("수신자")))):r(a=>[...a,"올바른 이메일 주소를 입력하세요."])},j=()=>{E&&O(E)&&(n.cc?.includes(E)||(i(a=>({...a,cc:[...a.cc||[],E]})),I("")))},$=(a,m)=>{i(U=>({...U,[m]:U[m]?.filter(w=>w!==a)||[]}))},_=()=>{const a=[];return(!n.to.length||n.to.every(w=>!w.trim()))&&a.push("최소 하나의 수신자 이메일을 입력하세요."),n.to.filter(w=>w&&!O(w)).length>0&&a.push("수신자 이메일 주소가 올바르지 않습니다."),(n.cc?.filter(w=>w&&!O(w))||[]).length>0&&a.push("참조 이메일 주소가 올바르지 않습니다."),n.subject.trim()||a.push("제목을 입력하세요."),r(a),a.length===0},K=async()=>{if(_()){u(!0);try{await t(n),l(!1)}catch{r(["이메일 발송 중 오류가 발생했습니다."])}finally{u(!1)}}},ae=`안녕하세요.

${c.vendorName} 담당자님께 발주서를 전송드립니다.

■ 발주 정보
- 발주번호: ${c.orderNumber}
- 발주일자: ${c.orderDate}
- 현장명: ${c.siteName||"N/A"}
- 발주금액: ${c.totalAmount.toLocaleString()}원

첨부된 발주서를 확인하시고, 납기일정에 맞춰 진행 부탁드립니다.

감사합니다.`;return e.jsx(ye,{open:h,onOpenChange:l,children:e.jsxs(ve,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(we,{children:[e.jsxs(be,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5"}),"발주서 이메일 발송"]}),e.jsxs(Se,{children:[c.vendorName,"에게 발주서 ",c.orderNumber,"를 이메일로 전송합니다."]})]}),e.jsxs("div",{className:"space-y-4",children:[P.length>0&&e.jsxs(Qe,{variant:"destructive",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx(Ye,{children:e.jsx("ul",{className:"list-disc list-inside",children:P.map((a,m)=>e.jsx("li",{children:a},m))})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"to-email",children:"수신자 *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{id:"to-email",type:"email",placeholder:"example@company.com",value:o,onChange:a=>v(a.target.value),onKeyPress:a=>a.key==="Enter"&&R()}),e.jsx(k,{type:"button",onClick:R,variant:"outline",size:"sm",children:"추가"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.to.filter(a=>a.trim()).map((a,m)=>e.jsxs(W,{variant:"secondary",className:"flex items-center gap-1",children:[a,e.jsx(oe,{className:"h-3 w-3 cursor-pointer hover:text-red-500",onClick:()=>$(a,"to")})]},m))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"cc-email",children:"참조 (선택)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{id:"cc-email",type:"email",placeholder:"cc@company.com",value:E,onChange:a=>I(a.target.value),onKeyPress:a=>a.key==="Enter"&&j()}),e.jsx(k,{type:"button",onClick:j,variant:"outline",size:"sm",children:"추가"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.cc?.map((a,m)=>e.jsxs(W,{variant:"outline",className:"flex items-center gap-1",children:[a,e.jsx(oe,{className:"h-3 w-3 cursor-pointer hover:text-red-500",onClick:()=>$(a,"cc")})]},m))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"subject",children:"제목 *"}),e.jsx(D,{id:"subject",value:n.subject,onChange:a=>i(m=>({...m,subject:a.target.value})),placeholder:"발주서 전송 - PO-XXXX-XXX"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(F,{children:"첨부파일"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(me,{id:"attach-excel",checked:n.attachExcel,onCheckedChange:a=>i(m=>({...m,attachExcel:a}))}),e.jsx(F,{htmlFor:"attach-excel",children:"Excel 파일 (갑지/을지)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(me,{id:"attach-pdf",checked:n.attachPDF,onCheckedChange:a=>i(m=>({...m,attachPDF:a}))}),e.jsx(F,{htmlFor:"attach-pdf",children:"PDF 파일"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"message",children:"메시지 (선택)"}),e.jsx(Ke,{id:"message",value:n.message||ae,onChange:a=>i(m=>({...m,message:a.target.value})),placeholder:"추가 메시지를 입력하세요...",rows:8,className:"resize-none"})]})]}),e.jsxs(_e,{children:[e.jsx(k,{variant:"outline",onClick:()=>l(!1),disabled:p,children:"취소"}),e.jsx(k,{onClick:K,disabled:p,children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"발송 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"이메일 발송"]})})]})]})})}const te=class te{static async sendPurchaseOrderEmailOriginalFormat(l,c){try{const t=await N(`${this.BASE_URL}/send-email-original-format`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:l,...c})});if(!t.ok){const i=await t.json();throw new Error(i.error||"이메일 발송 실패")}return{success:!0,messageId:(await t.json()).data?.messageId}}catch(t){return console.error("원본 형식 유지 이메일 발송 오류:",t),{success:!1,error:t instanceof Error?t.message:"알 수 없는 오류"}}}static async sendPurchaseOrderEmail(l,c){const t={to:c.to,cc:c.cc,subject:c.subject,additionalMessage:c.message,poData:{orderNumber:l.orderNumber,orderDate:l.orderDate,siteName:l.siteName,vendorName:l.vendorName,totalAmount:l.totalAmount}};if(l.filePath&&(t.attachments=[],c.attachExcel&&t.attachments.push({path:l.filePath,filename:`발주서_${l.orderNumber}.xlsx`}),c.attachPDF)){const n=l.filePath.replace(".xlsx",".pdf");t.attachments.push({path:n,filename:`발주서_${l.orderNumber}.pdf`})}try{return await N(`${this.BASE_URL}/send-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(n){throw console.error("Email send error:",n),new Error("이메일 발송 중 오류가 발생했습니다.")}}static async testEmailConnection(){try{return await N(`${this.BASE_URL}/test-email`)}catch(l){return console.error("Email connection test error:",l),{success:!1,message:"이메일 서버 연결 테스트 실패"}}}static async extractSheets(l,c=["갑지","을지"]){try{return await N(`${this.BASE_URL}/extract-sheets`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:l,sheets:c})})}catch(t){throw console.error("Sheet extraction error:",t),new Error("시트 추출 중 오류가 발생했습니다.")}}static async convertToPDF(l,c){try{return await N(`${this.BASE_URL}/convert-to-pdf`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({excelPath:l,sheets:c})})}catch(t){throw console.error("PDF conversion error:",t),new Error("PDF 변환 중 오류가 발생했습니다.")}}static async processComplete(l,c){const t=new FormData;t.append("file",l),Object.entries(c).forEach(([n,i])=>{i!==void 0&&(Array.isArray(i)?t.append(n,i.join(",")):t.append(n,i.toString()))});try{return await N(`${this.BASE_URL}/process-complete`,{method:"POST",body:t})}catch(n){throw console.error("Complete process error:",n),new Error("통합 처리 중 오류가 발생했습니다.")}}};te.BASE_URL="/api/po-template";let Z=te;function hs(h){return fe({queryKey:["/api/orders",h,"email-history"],queryFn:()=>N("GET",`/api/orders/${h}/email-history`),enabled:!!h,staleTime:30*1e3})}function ps({orderId:h,orderNumber:l,isOpen:c,onClose:t,onResend:n}){const{data:i,isLoading:p}=hs(h),u=r=>{switch(r){case"sent":return e.jsx(se,{className:"h-4 w-4"});case"opened":return e.jsx(is,{className:"h-4 w-4"});case"clicked":return e.jsx(je,{className:"h-4 w-4"});case"failed":return e.jsx(os,{className:"h-4 w-4"});case"bounced":return e.jsx(pe,{className:"h-4 w-4"});default:return e.jsx(A,{className:"h-4 w-4"})}},P=r=>{const o={sent:{variant:"default",label:"발송됨"},opened:{variant:"success",label:"열람됨"},clicked:{variant:"secondary",label:"클릭됨"},failed:{variant:"destructive",label:"실패"},bounced:{variant:"warning",label:"반송됨"}},v=o[r]||o.sent;return e.jsxs(W,{variant:v.variant,children:[u(r),e.jsx("span",{className:"ml-1",children:v.label})]})};return e.jsx(ye,{open:c,onOpenChange:t,children:e.jsxs(ve,{className:"max-w-4xl max-h-[90vh]",children:[e.jsxs(we,{children:[e.jsx(be,{children:"이메일 발송 이력"}),e.jsxs(Se,{children:["발주서 ",l,"의 이메일 발송 내역입니다."]})]}),p?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(he,{className:"h-6 w-6 animate-spin text-gray-400"})}):i&&i.length>0?e.jsxs(Je,{defaultValue:"0",className:"w-full",children:[e.jsxs(We,{className:"grid w-full",style:{gridTemplateColumns:`repeat(${Math.min(i.length,5)}, 1fr)`},children:[i.slice(0,5).map((r,o)=>e.jsx(xe,{value:o.toString(),children:V(new Date(r.sentAt),"MM/dd HH:mm")},r.id)),i.length>5&&e.jsxs(xe,{value:"more",disabled:!0,children:["+",i.length-5," more"]})]}),i.map((r,o)=>e.jsxs(Ze,{value:o.toString(),className:"space-y-4",children:[e.jsxs(X,{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ts,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"발송 시간:"}),e.jsx("span",{className:"font-medium",children:V(new Date(r.sentAt),"yyyy년 MM월 dd일 HH:mm:ss",{locale:J})})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($e,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"발송자:"}),e.jsxs("span",{className:"font-medium",children:[r.sentByName," (",r.sentByEmail,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(A,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"수신자:"}),e.jsx("span",{className:"font-medium",children:r.recipientName?`${r.recipientName} <${r.recipientEmail}>`:r.recipientEmail})]}),r.ccEmails&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(A,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"참조:"}),e.jsx("span",{className:"font-medium",children:r.ccEmails})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"상태:"}),P(r.status)]}),r.openedAt&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ne,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-gray-600",children:"열람 시간:"}),e.jsx("span",{className:"font-medium",children:V(new Date(r.openedAt),"yyyy년 MM월 dd일 HH:mm:ss",{locale:J})})]}),r.clickedAt&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(je,{className:"h-4 w-4 text-purple-500"}),e.jsx("span",{className:"text-gray-600",children:"클릭 시간:"}),e.jsx("span",{className:"font-medium",children:V(new Date(r.clickedAt),"yyyy년 MM월 dd일 HH:mm:ss",{locale:J})})]}),r.errorMessage&&e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx(pe,{className:"h-4 w-4 text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"오류 메시지:"}),e.jsx("p",{className:"text-red-600 text-xs mt-1",children:r.errorMessage})]})]})]})]}),r.attachments&&r.attachments.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm mb-2",children:[e.jsx(as,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"첨부 파일:"})]}),e.jsx("div",{className:"space-y-1",children:r.attachments.map((v,E)=>e.jsxs("div",{className:"text-sm text-gray-700",children:[v.filename," (",(v.size/1024/1024).toFixed(2)," MB)"]},E))})]})]}),e.jsxs(X,{className:"p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"제목"}),e.jsx("p",{className:"text-sm text-gray-700 mb-4",children:r.subject}),e.jsx(ss,{}),e.jsx("h4",{className:"font-medium mt-4 mb-2",children:"내용"}),e.jsx(es,{className:"h-[300px] w-full rounded-md border p-4",children:e.jsx("div",{className:"prose prose-sm max-w-none",dangerouslySetInnerHTML:{__html:r.body}})})]}),n&&r.status==="failed"&&e.jsx("div",{className:"flex justify-end",children:e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>n(r.id),children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"재발송"]})})]},r.id))]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(A,{className:"h-12 w-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500",children:"이메일 발송 이력이 없습니다."})]})]})})}function Xs(){const{user:h}=Ie(),{toast:l}=Re(),[c,t]=Ue(),[n,i]=g.useState({status:"",vendorId:"",projectId:"",userId:"",startDate:"",endDate:"",minAmount:"",maxAmount:"",searchText:"",page:1,limit:50,sortBy:"orderDate",sortOrder:"desc"}),[p,u]=g.useState(!1),[P,r]=g.useState(!1),[o,v]=g.useState(null),[E,I]=g.useState(!1),[O,R]=g.useState(null);g.useEffect(()=>{const s=new URLSearchParams(window.location.search),d=s.get("status"),y=s.get("filter"),b=s.get("vendor"),x={page:1,status:"",vendorId:"",projectId:"",userId:"",startDate:"",endDate:"",minAmount:"",maxAmount:"",searchText:"",limit:50};if(d&&!y)x.status=d==="all"?"":d;else if(y==="monthly"){const T=new Date,S=T.getFullYear(),ce=T.getMonth(),Te=new Date(S,ce,1),Fe=new Date(S,ce+1,0),ie=Q=>{const Ae=Q.getFullYear(),Le=String(Q.getMonth()+1).padStart(2,"0"),Me=String(Q.getDate()).padStart(2,"0");return`${Ae}-${Le}-${Me}`};x.startDate=ie(Te),x.endDate=ie(Fe)}else if(y==="urgent"){const T=new Date,S=new Date;S.setDate(T.getDate()+7),x.startDate=T.toISOString().split("T")[0],x.endDate=S.toISOString().split("T")[0],x.status="approved"}b&&(x.vendorId=b),i(x)},[c]);const{orders:j,vendors:$,projects:_,users:K,total:ae,page:a,totalPages:m,hasNextPage:U,hasPreviousPage:w,isLoading:Ee,error:us,cacheHit:js,queryTime:gs,prefetchRelatedData:re}=ms(n);g.useEffect(()=>{re()},[re]),Y({mutationFn:async({orderId:s,status:d})=>{await N("PUT",`/api/orders/${s}/status`,{status:d})},onSuccess:()=>{de.invalidateQueries({queryKey:["orders-optimized"]}),l({title:"성공",description:"발주서 상태가 변경되었습니다."})},onError:s=>{if(G(s)){l({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{t("/login")},500);return}l({title:"오류",description:"발주서 상태 변경에 실패했습니다.",variant:"destructive"})}}),Y({mutationFn:async s=>{await N("DELETE",`/api/orders/${s}`)},onSuccess:()=>{de.invalidateQueries({queryKey:["orders-optimized"]}),l({title:"성공",description:"발주서가 삭제되었습니다."})},onError:s=>{if(G(s)){l({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{t("/login")},500);return}l({title:"오류",description:"발주서 삭제에 실패했습니다.",variant:"destructive"})}});const ne=Y({mutationFn:async()=>{const s=new URLSearchParams;Object.entries(n).forEach(([T,S])=>{S&&S!=="all"&&S!==""&&s.append(T,S.toString())});const d=await fetch(`/api/orders/export?${s}`,{credentials:"include"});if(!d.ok)throw new Error("Export failed");const y=await d.blob(),b=window.URL.createObjectURL(y),x=document.createElement("a");x.href=b,x.download="orders.xlsx",document.body.appendChild(x),x.click(),window.URL.revokeObjectURL(b),document.body.removeChild(x)},onError:s=>{if(G(s)){l({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{t("/login")},500);return}l({title:"오류",description:"엑셀 다운로드에 실패했습니다.",variant:"destructive"})}}),C=(s,d)=>{const y=d==="all"?"":d;i(b=>({...b,[s]:y,page:1}))},L=s=>{i(d=>({...d,sortBy:s,sortOrder:d.sortBy===s&&d.sortOrder==="desc"?"asc":"desc",page:1}))},Ce=s=>{const d=j.find(y=>y.id===s.id);d&&(v(d),r(!0))},ke=async s=>{if(o)try{const d={orderNumber:o.orderNumber,vendorName:o.vendorName||o.vendor?.name||"",orderDate:o.orderDate,totalAmount:o.totalAmount,siteName:o.projectName||o.project?.projectName,filePath:o.filePath||""};await Z.sendPurchaseOrderEmail(d,s),l({title:"이메일 발송 완료",description:`${o.vendor?.name}에게 발주서 ${o.orderNumber}를 전송했습니다.`})}catch(d){l({title:"이메일 발송 실패",description:d instanceof Error?d.message:"이메일 발송 중 오류가 발생했습니다.",variant:"destructive"})}},Pe=async s=>{try{const d=await fetch(`/api/orders/${s}/download`,{credentials:"include"});if(!d.ok)throw new Error("Download failed");const y=await d.blob(),b=window.URL.createObjectURL(y),x=document.createElement("a");x.href=b,x.download=`order-${s}.pdf`,document.body.appendChild(x),x.click(),window.URL.revokeObjectURL(b),document.body.removeChild(x)}catch{l({title:"다운로드 실패",description:"발주서 다운로드에 실패했습니다.",variant:"destructive"})}};console.log("🔍 Orders Professional - orders data:",j),console.log("🔍 Orders Professional - first order:",j[0]),j[0]&&(console.log("🔍 Orders Professional - vendor info:",{vendor:j[0].vendor,vendorName:j[0].vendorName,vendorFromVendor:j[0].vendor?.name}),console.log("🔍 Orders Professional - project info:",{project:j[0].project,projectName:j[0].projectName,projectFromProject:j[0].project?.projectName}));const le=j,Oe=s=>!s.emailStatus||s.totalEmailsSent===0?e.jsx("span",{className:"text-xs text-gray-500",children:"미발송"}):s.emailStatus==="sent"?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"text-xs text-blue-600",children:"발송됨"})]}):s.emailStatus==="opened"?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"text-xs text-green-600",children:"열람됨"})]}):e.jsx("span",{className:"text-xs text-gray-500",children:"미발송"}),De=s=>{switch(s){case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"approved":return"bg-green-100 text-green-800 border-green-200";case"sent":return"bg-blue-100 text-blue-800 border-blue-200";case"completed":return"bg-purple-100 text-purple-800 border-purple-200";case"rejected":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"발주서 관리"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:n.vendorId?`${$?.find(s=>s.id.toString()===n.vendorId)?.name||""} 거래처 발주서`:"전체 발주서를 조회하고 관리하세요"})]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs(k,{onClick:()=>t("/create-order"),className:"bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2 shadow-sm",children:[e.jsx(qe,{className:"h-4 w-4"}),"새 발주서 작성"]})})]})}),e.jsx(X,{className:"mb-6 shadow-sm",children:e.jsxs(ze,{className:"p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative max-w-xl",children:[e.jsx(rs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5"}),e.jsx(D,{placeholder:"발주번호, 품목명으로 검색...",value:n.searchText,onChange:s=>C("searchText",s.target.value),className:"pl-10 h-11 text-sm border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100"})]})}),e.jsxs("div",{className:"flex flex-wrap gap-3 mb-4",children:[e.jsxs(q,{value:n.status||"all",onValueChange:s=>C("status",s),children:[e.jsx(z,{className:"w-40 h-10 border-gray-200",children:e.jsx(H,{placeholder:"상태 선택"})}),e.jsxs(B,{children:[e.jsx(f,{value:"all",children:"모든 상태"}),e.jsx(f,{value:"pending",children:"승인 대기"}),e.jsx(f,{value:"approved",children:"승인 완료"}),e.jsx(f,{value:"sent",children:"발송 완료"}),e.jsx(f,{value:"completed",children:"완료"}),e.jsx(f,{value:"rejected",children:"반려"})]})]}),e.jsxs(q,{value:n.projectId||"all",onValueChange:s=>C("projectId",s),children:[e.jsx(z,{className:"w-48 h-10 border-gray-200",children:e.jsx(H,{placeholder:"프로젝트 선택"})}),e.jsxs(B,{children:[e.jsx(f,{value:"all",children:"모든 프로젝트"}),_?.map(s=>e.jsx(f,{value:s.id.toString(),children:s.projectName},s.id))]})]}),e.jsxs(q,{value:n.vendorId||"all",onValueChange:s=>C("vendorId",s),children:[e.jsx(z,{className:"w-48 h-10 border-gray-200",children:e.jsx(H,{placeholder:"거래처 선택"})}),e.jsxs(B,{children:[e.jsx(f,{value:"all",children:"모든 거래처"}),$?.map(s=>e.jsx(f,{value:s.id.toString(),children:s.name},s.id))]})]}),e.jsxs(k,{variant:"outline",onClick:()=>u(!p),className:"h-10 px-4 border-gray-200",children:[e.jsx(ns,{className:"h-4 w-4 mr-2"}),"고급 필터",p?e.jsx(ls,{className:"h-4 w-4 ml-2"}):e.jsx(He,{className:"h-4 w-4 ml-2"})]}),e.jsxs("div",{className:"ml-auto flex gap-2",children:[Object.values(n).some(s=>s&&s!=="")&&e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>i({status:"",vendorId:"",projectId:"",userId:"",startDate:"",endDate:"",minAmount:"",maxAmount:"",searchText:"",page:1,limit:50}),className:"h-10",children:"필터 초기화"}),e.jsxs(k,{variant:"outline",onClick:()=>ne.mutate(),disabled:ne.isPending,className:"h-10 border-gray-200",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"엑셀 다운로드"]})]})]}),p&&e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"발주일 범위"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{type:"date",value:n.startDate,onChange:s=>C("startDate",s.target.value),className:"h-10 text-sm"}),e.jsx("span",{className:"text-gray-400",children:"~"}),e.jsx(D,{type:"date",value:n.endDate,onChange:s=>C("endDate",s.target.value),className:"h-10 text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"금액 범위"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{type:"number",placeholder:"최소 금액",value:n.minAmount,onChange:s=>C("minAmount",s.target.value),className:"h-10 text-sm"}),e.jsx("span",{className:"text-gray-400",children:"~"}),e.jsx(D,{type:"number",placeholder:"최대 금액",value:n.maxAmount,onChange:s=>C("maxAmount",s.target.value),className:"h-10 text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"작성자"}),e.jsxs(q,{value:n.userId||"all",onValueChange:s=>C("userId",s),children:[e.jsx(z,{className:"h-10",children:e.jsx(H,{placeholder:"모든 작성자"})}),e.jsxs(B,{children:[e.jsx(f,{value:"all",children:"모든 작성자"}),K?.map(s=>e.jsx(f,{value:s.id,children:s.name||s.email},s.id))]})]})]})]})})]})}),e.jsx(X,{className:"shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>L("orderNumber"),className:"flex items-center gap-1 hover:text-gray-700",children:["발주번호",e.jsx(M,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>L("vendorName"),className:"flex items-center gap-1 hover:text-gray-700",children:["거래처",e.jsx(M,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>L("projectName"),className:"flex items-center gap-1 hover:text-gray-700",children:["프로젝트",e.jsx(M,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>L("orderDate"),className:"flex items-center gap-1 hover:text-gray-700",children:["발주일",e.jsx(M,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>L("totalAmount"),className:"flex items-center gap-1 hover:text-gray-700",children:["금액",e.jsx(M,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsxs("button",{onClick:()=>L("status"),className:"flex items-center gap-1 hover:text-gray-700",children:["상태",e.jsx(M,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"이메일"}),e.jsx("th",{className:"px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"액션"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:Ee?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-6 py-12 text-center",children:e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})})}):le.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"text-gray-500",children:[e.jsx(Be,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"발주서가 없습니다."})]})})}):le.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{onClick:()=>t(`/orders/${s.id}`),className:"text-sm font-medium text-blue-600 hover:text-blue-700",children:s.orderNumber})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:s.vendorName||s.vendor?.name||"-"}),s.vendor?.email&&e.jsx("div",{className:"text-xs text-gray-500",children:s.vendor.email})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:s.projectName||s.project?.projectName||"-"}),s.project?.projectCode&&e.jsx("div",{className:"text-xs text-gray-500",children:s.project.projectCode})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:new Date(s.orderDate).toLocaleDateString("ko-KR")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-semibold text-blue-600",children:Ve(s.totalAmount)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${De(s.status)}`,children:Xe(s.status)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:Oe(s)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>t(`/orders/${s.id}`),className:"text-gray-400 hover:text-blue-600 transition-colors",title:"상세보기",children:e.jsx(Ne,{className:"h-5 w-5"})}),h?.role==="admin"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>t(`/orders/${s.id}/edit`),className:"text-gray-400 hover:text-blue-600 transition-colors",title:"수정",children:e.jsx(cs,{className:"h-5 w-5"})}),s.status==="approved"&&e.jsx("button",{onClick:()=>Ce(s),className:"text-gray-400 hover:text-green-600 transition-colors",title:"이메일 발송",children:e.jsx(A,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>Pe(s.id),className:"text-gray-400 hover:text-purple-600 transition-colors",title:"다운로드",children:e.jsx(ue,{className:"h-5 w-5"})})]})]})})]},s.id))})]})})}),o&&e.jsx(xs,{open:P,onOpenChange:r,orderData:{orderNumber:o.orderNumber,vendorName:o.vendorName||o.vendor?.name||"",vendorEmail:o.vendor?.email,orderDate:new Date(o.orderDate).toLocaleDateString(),totalAmount:o.totalAmount,siteName:o.projectName||o.project?.projectName},onSendEmail:ke}),O&&e.jsx(ps,{orderId:O.id,orderNumber:O.orderNumber,isOpen:E,onClose:()=>{I(!1),R(null)}})]})})}export{Xs as default};
