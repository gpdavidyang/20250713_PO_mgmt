import{L as V,u as $,d as L,c as H,r as N,M as h,aJ as Q,H as W,j as e,B as p,N as J,V as R,W as z,O as G,aK as U,aL as l,aM as t,aN as c,aO as o,I as m,aP as i,a2 as X,a3 as _,s as S,a4 as Y,Q as Z,o as ee,$ as F,f as se,aT as ae,J as re,K as P}from"./index-CYSdMOsg.js";import{T as ne}from"./textarea-DKZN5HYr.js";import{S as w,a as M,b as D,c as I,d as f}from"./select-DpDDwyMD.js";import{C as te}from"./checkbox-DQXwhi6z.js";import{P as ce}from"./page-header-D67sRSD2.js";import{C as oe,a as le,b as ie,c as de,d as je}from"./command-Db5hX0IA.js";import{A as xe}from"./arrow-left-T614qN7B.js";import{C as me}from"./chevrons-up-down-CIk9M0rf.js";import{S as he}from"./save-B3Sy8sh5.js";import"./index-C7-ZzLPR.js";import"./chevron-down-ZCgaiwwI.js";import"./chevron-up-DLV_Zaru.js";import"./index-CKqD6XZG.js";import"./dialog-K3vxuI3P.js";import"./search-1NQWFrHR.js";function Be(){const{id:j}=V(),[,C]=$(),{toast:T}=L();H();const[x,u]=N.useState([]),[B,q]=N.useState(!1),{data:r,isLoading:K}=h({queryKey:["/api/projects",j],queryFn:()=>fetch(`/api/projects/${j}`).then(s=>s.json()),enabled:!!j}),{data:O=[]}=h({queryKey:["/api/project-statuses"]}),{data:k=[]}=h({queryKey:["/api/project-types"]}),{data:g=[]}=h({queryKey:["/api/users"]}),{data:v=[]}=h({queryKey:["/api/project-members",{projectId:j}],queryFn:()=>fetch(`/api/project-members?projectId=${j}`).then(s=>s.json()),enabled:!!j}),n=Q({defaultValues:{projectName:"",projectCode:"",clientName:"",projectType:"",location:"",status:"active",projectManagerId:"",orderManagerId:"",description:"",startDate:"",endDate:"",totalBudget:"",isActive:!0}});N.useEffect(()=>{r&&n.reset({projectName:r.projectName,projectCode:r.projectCode||"",clientName:r.clientName||"",projectType:r.projectType||"",location:r.location||"",status:r.status,projectManagerId:r.projectManagerId||"none",orderManagerId:r.orderManagerId||"none",description:r.description||"",startDate:r.startDate?new Date(r.startDate).toISOString().split("T")[0]:"",endDate:r.endDate?new Date(r.endDate).toISOString().split("T")[0]:"",totalBudget:r.totalBudget||"",isActive:r.isActive??!0})},[r,n]),N.useEffect(()=>{if(v&&v.length>0){const s=v.filter(a=>a.role==="order_manager").map(a=>a.userId);u(s)}},[v]);const y=W({mutationFn:async s=>re("PATCH",`/api/projects/${j}`,s),onSuccess:()=>{P.invalidateQueries({queryKey:["/api/projects"]}),P.invalidateQueries({queryKey:["/api/projects",j]}),T({description:"현장이 성공적으로 수정되었습니다."}),C(`/projects/${j}`)},onError:s=>{T({variant:"destructive",description:s.message||"현장 수정 중 오류가 발생했습니다."})}}),A=async s=>{const a={...s,totalBudget:s.totalBudget?parseFloat(s.totalBudget.toString().replace(/[^\d.]/g,"")):null,startDate:s.startDate?new Date(s.startDate):null,endDate:s.endDate?new Date(s.endDate):null,projectManagerId:s.projectManagerId==="none"?null:s.projectManagerId,orderManagerId:s.orderManagerId==="none"?null:s.orderManagerId,orderManagers:x};y.mutate(a)},E=()=>{C(`/projects/${j}`)};return K?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-6"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-10 bg-gray-200 rounded"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-10 bg-gray-200 rounded"})]})]})}):r?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6 space-y-6",children:[e.jsx(ce,{title:"현장 수정",description:`${r.projectName} 현장 정보를 수정합니다`}),e.jsxs(J,{className:"max-w-4xl shadow-sm",children:[e.jsx(R,{children:e.jsx(z,{className:"text-lg font-semibold",children:"현장 정보"})}),e.jsx(G,{children:e.jsx(U,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(A),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:n.control,name:"projectName",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장명 *"}),e.jsx(o,{children:e.jsx(m,{placeholder:"현장명을 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"projectCode",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장 코드"}),e.jsx(o,{children:e.jsx(m,{placeholder:"현장 코드를 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"clientName",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"클라이언트명"}),e.jsx(o,{children:e.jsx(m,{placeholder:"클라이언트명을 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"projectType",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장 유형"}),e.jsxs(w,{onValueChange:s.onChange,value:s.value,children:[e.jsx(o,{children:e.jsx(M,{children:e.jsx(D,{placeholder:"현장 유형을 선택하세요"})})}),e.jsx(I,{children:k.map(a=>e.jsx(f,{value:a.id,children:a.name},a.id))})]}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"location",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"위치"}),e.jsx(o,{children:e.jsx(m,{placeholder:"현장 위치를 입력하세요",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"status",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"상태"}),e.jsxs(w,{onValueChange:s.onChange,value:s.value,children:[e.jsx(o,{children:e.jsx(M,{children:e.jsx(D,{placeholder:"상태를 선택하세요"})})}),e.jsx(I,{children:O.map(a=>e.jsx(f,{value:a.id,children:a.name},a.id))})]}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"projectManagerId",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장 관리자"}),e.jsxs(w,{onValueChange:s.onChange,value:s.value,children:[e.jsx(o,{children:e.jsx(M,{children:e.jsx(D,{placeholder:"현장 관리자를 선택하세요"})})}),e.jsxs(I,{children:[e.jsx(f,{value:"none",children:"선택 안함"}),g.map(a=>e.jsx(f,{value:a.id,children:a.name},a.id))]})]}),e.jsx(i,{})]})}),e.jsxs(t,{children:[e.jsx(c,{children:"발주 담당자"}),e.jsx(o,{children:e.jsxs(X,{open:B,onOpenChange:q,children:[e.jsx(_,{asChild:!0,children:e.jsxs(p,{variant:"outline",role:"combobox","aria-expanded":B,className:"w-full justify-between",children:[x.length===0?"발주 담당자를 선택하세요":e.jsxs("div",{className:"flex flex-wrap gap-1",children:[x.slice(0,2).map(s=>{const a=g.find(d=>d.id===s);return e.jsx(S,{variant:"secondary",className:"text-xs",children:a?.name||s},s)}),x.length>2&&e.jsxs(S,{variant:"secondary",className:"text-xs",children:["+",x.length-2,"명 더"]})]}),e.jsx(me,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Y,{className:"w-full p-0",children:e.jsxs(oe,{children:[e.jsx(le,{placeholder:"담당자 검색..."}),e.jsx(ie,{children:"담당자를 찾을 수 없습니다."}),e.jsx(de,{children:g.map(s=>e.jsxs(je,{onSelect:()=>{const a=x.includes(s.id);u(a?d=>d.filter(b=>b!==s.id):d=>[...d,s.id])},children:[e.jsx(Z,{className:ee("mr-2 h-4 w-4",x.includes(s.id)?"opacity-100":"opacity-0")}),s.name]},s.id))})]})})]})}),e.jsx(i,{}),x.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"선택된 발주 담당자:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:x.map(s=>{const a=g.find(d=>d.id===s);return e.jsxs(S,{variant:"default",className:"text-xs",children:[a?.name||s,e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"ml-1 h-3 w-3 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>{u(d=>d.filter(b=>b!==s))},children:e.jsx(F,{className:"h-2 w-2"})})]},s)})})]})]}),e.jsx(l,{control:n.control,name:"startDate",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"시작일"}),e.jsx(o,{children:e.jsx(m,{type:"date",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"endDate",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"종료일"}),e.jsx(o,{children:e.jsx(m,{type:"date",...s})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"totalBudget",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"총 예산"}),e.jsx(o,{children:e.jsx(m,{type:"text",placeholder:"₩0",value:s.value?se(s.value):"",onChange:a=>{const d=ae(a.target.value);s.onChange(d.toString())},onBlur:s.onBlur,name:s.name,ref:s.ref})}),e.jsx(i,{})]})}),e.jsx(l,{control:n.control,name:"isActive",render:({field:s})=>e.jsxs(t,{className:"flex flex-row items-start space-x-3 space-y-0",children:[e.jsx(o,{children:e.jsx(te,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx("div",{className:"space-y-1 leading-none",children:e.jsx(c,{children:"활성 상태"})})]})})]}),e.jsx(l,{control:n.control,name:"description",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"설명"}),e.jsx(o,{children:e.jsx(ne,{placeholder:"현장 설명을 입력하세요",className:"min-h-[100px]",...s})}),e.jsx(i,{})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsxs(p,{type:"button",variant:"outline",onClick:E,disabled:y.isPending,children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),"취소"]}),e.jsxs(p,{type:"submit",disabled:y.isPending,children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),y.isPending?"저장 중...":"저장"]})]})]})})})]})]})}):e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"현장을 찾을 수 없습니다"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"요청하신 현장이 존재하지 않거나 삭제되었습니다."}),e.jsxs(p,{onClick:()=>C("/projects"),children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"목록으로"]})]})})}export{Be as default};
