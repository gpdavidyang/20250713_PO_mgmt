import{a as f,b as Q,j as e}from"./chunk-D67rGsji.js";import{r as S}from"./chunk-BgLp_VvL.js";import{u as V}from"./chunk-CFxRDIMf.js";import{k as M,l as U,B as m,C,h as q,i as T,g as w,L as v,I as j}from"./chunk-DV-F1ehd.js";import{S as P,h as E,i as k,j as F,k as O,f as Y,n as _,o as J,p as L,r as u,s as W,t as x,g,q as K,l as X}from"./chunk-bdHBeqB0.js";import{au as Z,av as ee,z as se,K as te,ay as ae}from"./chunk-CVirgo2y.js";import"./chunk-CZez8RVl.js";import"./chunk-Bw5QEQRA.js";function xe({params:b}){M();const{toast:p}=U(),[re,h]=V(),n=b.id;console.log("OrderEdit params:",b),console.log("OrderEdit orderId:",n,typeof n);const[i,l]=S.useState({vendorId:"",orderDate:"",deliveryDate:"",notes:"",items:[]}),{data:r,isLoading:D,error:y}=f({queryKey:[`/api/orders/${n}`],queryFn:()=>g("GET",`/api/orders/${n}`),enabled:!!n});console.log("OrderEdit Debug:",{orderId:n,order:r,orderLoading:D,orderError:y,enabled:!!n});const{data:$}=f({queryKey:["/api/vendors"],queryFn:()=>g("GET","/api/vendors")}),{data:z}=f({queryKey:["/api/items"],queryFn:()=>g("GET","/api/items")}),c=z?.items||[];S.useEffect(()=>{if(r&&c.length>0){const s=(r.items||[]).map(t=>{let a=null;return a=c.find(d=>d.name===t.itemName),a||(a=c.find(d=>d.name.includes(t.itemName)||t.itemName.includes(d.name))),!a&&t.itemId&&(a=c.find(d=>d.id===t.itemId)),{itemId:a?.id||null,itemName:t.itemName||"",quantity:parseFloat(t.quantity)||1,unitPrice:parseFloat(t.unitPrice)||0,specification:t.specification||"",notes:t.notes||""}});l({vendorId:r.vendorId?.toString()||"",orderDate:r.orderDate?new Date(r.orderDate).toISOString().split("T")[0]:"",deliveryDate:r.deliveryDate?new Date(r.deliveryDate).toISOString().split("T")[0]:"",notes:r.notes||"",items:s})}else r&&c.length===0&&l({vendorId:r.vendorId?.toString()||"",orderDate:r.orderDate?new Date(r.orderDate).toISOString().split("T")[0]:"",deliveryDate:r.deliveryDate?new Date(r.deliveryDate).toISOString().split("T")[0]:"",notes:r.notes||"",items:r.items||[]})},[r,c]);const N=Q({mutationFn:async s=>await g("PATCH",`/api/orders/${n}`,s),onSuccess:()=>{p({title:"성공",description:"발주서가 수정되었습니다."}),K.invalidateQueries({queryKey:[`/api/orders/${n}`]}),K.invalidateQueries({queryKey:["/api/orders"]}),h(`/orders/${n}`)},onError:s=>{if(X(s)){p({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{h("/login")},500);return}p({title:"오류",description:"발주서 수정에 실패했습니다.",variant:"destructive"})}}),H=s=>{if(s.preventDefault(),!i.vendorId||!i.orderDate||i.items.length===0){p({title:"오류",description:"모든 필수 필드를 입력해주세요.",variant:"destructive"});return}const t={vendorId:parseInt(i.vendorId),orderDate:new Date(i.orderDate),deliveryDate:i.deliveryDate?new Date(i.deliveryDate):null,notes:i.notes,items:i.items.map(a=>({itemId:a.itemId,itemName:a.itemName,quantity:Number(a.quantity),unitPrice:Number(a.unitPrice),specification:a.specification||"",notes:a.notes||""}))};N.mutate(t)},R=()=>{l(s=>({...s,items:[...s.items,{itemId:null,itemName:"",quantity:1,unitPrice:0,specification:"",notes:""}]}))},A=s=>{l(t=>({...t,items:t.items.filter((a,d)=>d!==s)}))},o=(s,t,a)=>{l(d=>({...d,items:d.items.map((I,G)=>G===s?{...I,[t]:a}:I)}))},B=(s,t)=>{const a=c.find(d=>d.id.toString()===t);a&&(o(s,"itemId",a.id),o(s,"itemName",a.name),o(s,"unitPrice",a.unitPrice||0),o(s,"specification",a.specification||""))};return D?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4 mb-6"}),e.jsx("div",{className:"h-96 bg-gray-200 rounded"})]})}):y?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서 로드 중 오류가 발생했습니다"}),e.jsx("p",{className:"mb-4 text-red-600",children:y.message}),e.jsx(m,{onClick:()=>h("/orders"),children:"발주서 목록으로 돌아가기"})]})}):r?e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>h(`/orders/${n}`),children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"돌아가기"]}),e.jsx(ee,{className:"h-6 w-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"발주서 수정"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"발주서 정보를 수정합니다"})]})]})})}),e.jsxs("form",{onSubmit:H,children:[e.jsxs(C,{className:"mb-6",children:[e.jsx(q,{children:e.jsx(T,{children:"기본 정보"})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"vendor",children:"거래처 *"}),e.jsxs(P,{value:i.vendorId,onValueChange:s=>l(t=>({...t,vendorId:s})),children:[e.jsx(E,{children:e.jsx(k,{placeholder:"거래처를 선택하세요"})}),e.jsx(F,{children:$?.map(s=>e.jsx(O,{value:s.id.toString(),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"orderDate",children:"발주일자 *"}),e.jsx(j,{id:"orderDate",type:"date",value:i.orderDate,onChange:s=>l(t=>({...t,orderDate:s.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"deliveryDate",children:"납품희망일"}),e.jsx(j,{id:"deliveryDate",type:"date",value:i.deliveryDate,onChange:s=>l(t=>({...t,deliveryDate:s.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"notes",children:"비고"}),e.jsx(Y,{id:"notes",placeholder:"추가 정보나 요청사항을 입력하세요",value:i.notes,onChange:s=>l(t=>({...t,notes:s.target.value})),rows:3})]})]})]}),e.jsxs(C,{className:"mb-6",children:[e.jsx(q,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(T,{children:"발주 품목"}),e.jsxs(m,{type:"button",onClick:R,children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"품목 추가"]})]})}),e.jsxs(w,{children:[i.items.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"발주할 품목을 추가해주세요"}):e.jsxs(_,{children:[e.jsx(J,{children:e.jsxs(L,{children:[e.jsx(u,{children:"품목명 *"}),e.jsx(u,{children:"수량 *"}),e.jsx(u,{children:"단가"}),e.jsx(u,{children:"규격"}),e.jsx(u,{children:"비고"}),e.jsx(u,{children:"총액"}),e.jsx(u,{className:"w-[100px]",children:"작업"})]})}),e.jsx(W,{children:i.items.map((s,t)=>e.jsxs(L,{children:[e.jsx(x,{children:e.jsxs(P,{value:s.itemId?.toString()||"",onValueChange:a=>B(t,a),children:[e.jsx(E,{children:e.jsx(k,{placeholder:s.itemName||"품목 선택"})}),e.jsx(F,{children:c.map(a=>e.jsx(O,{value:a.id.toString(),children:a.name},a.id))})]})}),e.jsx(x,{children:e.jsx(j,{type:"number",value:s.quantity,onChange:a=>o(t,"quantity",Number(a.target.value)),min:"1",required:!0})}),e.jsx(x,{children:e.jsx(j,{type:"number",value:s.unitPrice,onChange:a=>o(t,"unitPrice",Number(a.target.value)),min:"0"})}),e.jsx(x,{children:e.jsx(j,{value:s.specification,onChange:a=>o(t,"specification",a.target.value),placeholder:"규격 입력"})}),e.jsx(x,{children:e.jsx(j,{value:s.notes,onChange:a=>o(t,"notes",a.target.value),placeholder:"비고 입력"})}),e.jsxs(x,{children:["₩",(Number(s.quantity)*Number(s.unitPrice)).toLocaleString("ko-KR")]}),e.jsx(x,{children:e.jsx(m,{type:"button",variant:"ghost",size:"sm",onClick:()=>A(t),children:e.jsx(te,{className:"h-4 w-4 text-red-500"})})})]},t))})]}),i.items.length>0&&e.jsx("div",{className:"mt-4 pt-4 border-t mx-6 mb-6",children:e.jsx("div",{className:"flex justify-end",children:e.jsx("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg",children:e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"총 합계 금액"}),e.jsxs("div",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:["₩",i.items.reduce((s,t)=>{const a=(t.quantity||0)*(t.unitPrice||0);return s+a},0).toLocaleString()]})]})})})})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(m,{type:"button",variant:"outline",onClick:()=>h(`/orders/${n}`),children:"취소"}),e.jsxs(m,{type:"submit",disabled:N.isPending,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),N.isPending?"저장 중...":"저장"]})]})]})]}):e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서를 찾을 수 없습니다"}),e.jsxs("p",{className:"mb-4 text-gray-600",children:["OrderID: ",n]}),e.jsx(m,{onClick:()=>h("/orders"),children:"발주서 목록으로 돌아가기"})]})})}export{xe as default};
